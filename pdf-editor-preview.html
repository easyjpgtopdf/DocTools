<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Advanced PDF Editor Online Free - Real-Time PDF Editing | easyjpgtopdf</title>
    <meta name="description" content="Advanced PDF editor online free with real-time editing, full A4 preview, text editing, image insertion, OCR, and professional editing tools. Edit PDF files online without installation. Best free online PDF editor 2024.">
    <meta name="keywords" content="advanced pdf editor online free, real-time pdf editing, online pdf editor, edit pdf files, pdf editor tool, edit pdf documents, pdf editor software, edit pdf text, pdf editor free online, best pdf editor online, edit pdf online free no download, pdf editor website, free online pdf editor, real-time pdf editor, pdf editor with ocr">
    
    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    
    <!-- Preload Critical CSS -->
    <link rel="preload" href="css/header.css" as="style">
    <link rel="preload" href="css/footer.css" as="style">
    
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/theme-modern.css">
    <!-- Defer Font Awesome to prevent render blocking -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    
    <!-- PDF.js for rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Advanced PDF Editor Online Free",
      "description": "Advanced PDF editor online free with real-time editing, full A4 preview, text editing, image insertion, OCR, and professional editing tools. Edit PDF files online without installation. Best free online PDF editor 2024.",
      "url": "https://easyjpgtopdf.com/pdf-editor-preview.html",
      "applicationCategory": "ProductivityApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires HTML5 support",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Real-time PDF text editing",
        "Add and manipulate images in PDF",
        "Advanced OCR text recognition",
        "Full A4 size document preview",
        "Professional editing toolbar",
        "No software installation required",
        "Multiple save options (Edited PDF, OCR-Only, Selectable PDF)"
      ],
      "inLanguage": "en-US",
      "isPartOf": {
        "@type": "WebSite",
        "name": "easyjpgtopdf",
        "url": "https://easyjpgtopdf.com"
      },
      "publisher": {
        "@type": "Organization",
        "name": "easyjpgtopdf",
        "url": "https://easyjpgtopdf.com"
      },
      "author": {
        "@type": "Person",
        "name": "Riyaz Mohammad"
      }
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f7ff;
            color: #0b1630;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        main {
            flex: 1;
            padding: 30px 0;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-size: 2.2rem;
            color: #0b1630;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .editor-toolbar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .toolbar-btn {
            padding: 10px 20px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-btn:hover:not(:disabled) {
            background: #3a0ca3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-btn.secondary {
            background: #f8f9ff;
            color: #4361ee;
            border: 2px solid #4361ee;
        }
        
        .toolbar-btn.secondary:hover:not(:disabled) {
            background: #eef2ff;
        }
        
        .preview-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            min-height: 600px;
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            min-height: 800px;
        }
        
        .pdf-page-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin: 0 auto;
        }
        
        .pdf-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .text-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .editable-text {
            position: absolute;
            cursor: text;
            padding: 2px 4px;
            border: 1px dashed transparent;
            user-select: text;
            white-space: pre-wrap;
            pointer-events: auto;
            min-width: 20px;
            min-height: 16px;
        }
        
        .editable-text.selected {
            border-color: #4361ee;
            background: rgba(67, 97, 238, 0.1);
        }
        
        .editable-text.editing {
            border: 2px solid #4361ee;
            background: white;
            z-index: 10;
            outline: none;
        }
        
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .page-btn {
            padding: 8px 15px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #3a0ca3;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 600;
            color: #0b1630;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 12px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4361ee;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tools-roadmap, .user-feedback {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tools-roadmap h2, .user-feedback h2 {
            font-size: 2rem;
            color: #0b1630;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
        }
        
        .roadmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .roadmap-card {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e2e6ff;
            transition: all 0.3s ease;
        }
        
        .roadmap-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15);
            border-color: #4361ee;
        }
        
        .roadmap-icon {
            font-size: 36px;
            color: #4361ee;
            margin-bottom: 15px;
        }
        
        .roadmap-card h3 {
            font-size: 1.3rem;
            color: #0b1630;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .roadmap-card p {
            color: #56607a;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .feedback-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #0b1630;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e6ff;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4361ee;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .submit-btn {
            padding: 12px 30px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            background: #3a0ca3;
            transform: translateY(-2px);
        }
        
        .ssl-badges {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border-radius: 12px;
            margin: 30px 0;
            border: 2px solid #e2e6ff;
        }
        
        .ssl-badges-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        .ssl-badge {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ssl-badge i {
            font-size: 2rem;
            color: #4361ee;
        }
        
        .ssl-badge-text h4 {
            color: #0b1630;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 3px;
        }
        
        .ssl-badge-text p {
            color: #56607a;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.6rem;
            }
            
            .editor-toolbar {
                flex-direction: column;
            }
            
            .toolbar-btn {
                width: 100%;
                justify-content: center;
            }
            
            .preview-container {
                padding: 10px;
            }
            
            .roadmap-grid {
                grid-template-columns: 1fr;
            }
            
            .ssl-badges-grid {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <script src="js/global-components.js"></script>
    <div id="global-header-placeholder"></div>
    <div id="global-breadcrumb-placeholder"></div>
    
    <main>
        <div class="container">
            <div class="page-header">
                <h1>Advanced PDF Editor Online Free - Real-Time PDF Editing</h1>
            </div>
            
            <div class="editor-toolbar">
                <button class="toolbar-btn" id="download-btn" disabled>
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="toolbar-btn secondary" id="ocr-btn">
                    <i class="fas fa-language"></i> OCR Edit
                </button>
                <button class="toolbar-btn secondary" id="add-text-btn">
                    <i class="fas fa-font"></i> Add Text
                </button>
                <button class="toolbar-btn secondary" id="add-image-btn">
                    <i class="fas fa-image"></i> Add Image
                </button>
                <button class="toolbar-btn secondary" id="highlight-btn">
                    <i class="fas fa-highlighter"></i> Highlight
                </button>
                <button class="toolbar-btn secondary" id="undo-btn" disabled>
                    <i class="fas fa-undo"></i> Undo
                </button>
                <button class="toolbar-btn secondary" id="redo-btn" disabled>
                    <i class="fas fa-redo"></i> Redo
                </button>
            </div>
            
            <div class="preview-section">
                <div class="preview-container" id="preview-container" style="display: flex; visibility: visible;">
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="pdf-page-wrapper" class="pdf-page-wrapper" style="display: block; visibility: visible;">
                        <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
                        <div id="text-layer" class="text-layer"></div>
                    </div>
                </div>
                
                <div class="page-navigation">
                    <button class="page-btn" id="prev-page" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span class="page-info">
                        Page <span id="page-num">1</span> of <span id="page-count">1</span>
                    </span>
                    <button class="page-btn" id="next-page" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="tools-roadmap">
                <h2>How Our PDF Editor Works</h2>
                <div class="roadmap-grid">
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <h3>Edit Every Word</h3>
                        <p>Click on any text in your PDF to edit it directly. Every word is fully editable with real-time preview, just like Adobe Acrobat Pro. Simply click, edit, and see changes instantly.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <h3>Advanced OCR</h3>
                        <p>Extract text from scanned PDFs using Google Cloud Vision API. Our OCR technology supports multiple languages and provides 100% accurate text recognition.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-paint-brush"></i>
                        </div>
                        <h3>Professional Tools</h3>
                        <p>Add text, images, highlights, annotations, change fonts, adjust colors, and more. All changes are visible in real-time with full A4 size preview.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <h3>Download & Save</h3>
                        <p>Once you're done editing, download your modified PDF instantly. Your original file remains untouched, and all edits are preserved.</p>
                    </div>
                </div>
            </div>
            
            <div class="tools-roadmap">
                <h2>Key Features & Characteristics</h2>
                <div class="roadmap-grid">
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>100% Free</h3>
                        <p>No hidden charges, no registration required. Edit PDFs completely free with unlimited usage and all features available.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Secure & Private</h3>
                        <p>Your files are processed securely using Google Cloud infrastructure. All files are automatically deleted after processing.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h3>Mobile Friendly</h3>
                        <p>Works perfectly on desktop, tablet, and mobile devices. Edit PDFs on the go from any device with responsive design.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3>Fast Processing</h3>
                        <p>Powered by Google Cloud infrastructure for lightning-fast editing and OCR processing with 100% accuracy and real-time updates.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <h3>Multi-Language OCR</h3>
                        <p>Extract text from scanned PDFs in multiple languages using advanced Google Cloud Vision API OCR technology with high accuracy.</p>
                    </div>
                    <div class="roadmap-card">
                        <div class="roadmap-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h3>Real-Time Preview</h3>
                        <p>See all your changes in real-time as you edit. Full A4 size preview with zoom controls for precise editing.</p>
                    </div>
                </div>
            </div>
            
            <div class="user-feedback">
                <h2>Share Your Feedback</h2>
                <div class="feedback-form">
                    <div class="form-group">
                        <label for="feedback-name">Your Name</label>
                        <input type="text" id="feedback-name" class="form-control" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label for="feedback-email">Email Address</label>
                        <input type="email" id="feedback-email" class="form-control" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="feedback-message">Your Feedback</label>
                        <textarea id="feedback-message" class="form-control" placeholder="Share your experience with our PDF editor"></textarea>
                    </div>
                    <button class="submit-btn" onclick="submitFeedback()">
                        <i class="fas fa-paper-plane"></i> Submit Feedback
                    </button>
                </div>
            </div>
            
            <div class="ssl-badges">
                <div class="ssl-badges-grid">
                    <div class="ssl-badge">
                        <i class="fas fa-shield-alt"></i>
                        <div class="ssl-badge-text">
                            <h4>SSL Secured</h4>
                            <p>256-bit Encryption</p>
                        </div>
                    </div>
                    <div class="ssl-badge">
                        <i class="fas fa-lock"></i>
                        <div class="ssl-badge-text">
                            <h4>100% Secure</h4>
                            <p>Files Auto-Deleted</p>
                        </div>
                    </div>
                    <div class="ssl-badge">
                        <i class="fas fa-check-circle"></i>
                        <div class="ssl-badge-text">
                            <h4>Privacy Protected</h4>
                            <p>No Data Storage</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="global-footer-placeholder"></div>
    
    <input type="file" id="image-input" accept="image/*" style="display: none;">
    
    <script src="js/mobile-menu-init.js"></script>
    <script>
        // Load auth.js only if we're not in file:// protocol (to avoid CORS errors)
        if (window.location.protocol !== 'file:') {
            const authScript = document.createElement('script');
            authScript.src = 'js/auth.js';
            authScript.type = 'module';
            authScript.onerror = function() {
                console.warn('Could not load auth.js - this is OK if you are not logged in');
            };
            document.head.appendChild(authScript);
        }
    </script>
    <script>
        // Prevent duplicate execution - wrap everything in IIFE
        (function() {
            if (window.pdfEditorInitialized) {
                console.warn('PDF Editor already initialized, skipping duplicate execution');
                return;
            }
            window.pdfEditorInitialized = true;
            
            // Set PDF.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            
            // Global variables - use window object to prevent scope issues
            // Check if already declared to prevent duplicate declaration error
            if (typeof window.pdfEditorVars === 'undefined') {
                window.pdfEditorVars = {
                    pdfDoc: null,
                    currentPage: 1,
                    totalPages: 1,
                    scale: 1.5,
                    textAnnotations: [],
                    annotationHistory: [],
                    redoHistory: [],
                    selectedTextElement: null,
                    activeTool: 'select'
                };
            }
            
            // Create local references for easier access (use const/let only once)
            const pdfDocRef = () => window.pdfEditorVars.pdfDoc;
            const setPdfDoc = (val) => { window.pdfEditorVars.pdfDoc = val; };
            const getCurrentPage = () => window.pdfEditorVars.currentPage;
            const setCurrentPage = (val) => { window.pdfEditorVars.currentPage = val; };
            const getTotalPages = () => window.pdfEditorVars.totalPages;
            const setTotalPages = (val) => { window.pdfEditorVars.totalPages = val; };
            const getScale = () => window.pdfEditorVars.scale;
            const setScale = (val) => { window.pdfEditorVars.scale = val; };
            const getTextAnnotations = () => window.pdfEditorVars.textAnnotations;
            const getAnnotationHistory = () => window.pdfEditorVars.annotationHistory;
            const getRedoHistory = () => window.pdfEditorVars.redoHistory;
            const getSelectedTextElement = () => window.pdfEditorVars.selectedTextElement;
            const setSelectedTextElement = (val) => { window.pdfEditorVars.selectedTextElement = val; };
            const getActiveTool = () => window.pdfEditorVars.activeTool;
            const setActiveTool = (val) => { window.pdfEditorVars.activeTool = val; };
            
            // For backward compatibility, create aliases
            let pdfDoc = pdfDocRef();
            let currentPage = getCurrentPage();
            let totalPages = getTotalPages();
            let scale = getScale();
            let textAnnotations = getTextAnnotations();
            let annotationHistory = getAnnotationHistory();
            let redoHistory = getRedoHistory();
            let selectedTextElement = getSelectedTextElement();
            let activeTool = getActiveTool();
        
        // DOM elements
        const previewContainer = document.getElementById('preview-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const pdfPageWrapper = document.getElementById('pdf-page-wrapper');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const textLayer = document.getElementById('text-layer');
        const pageNum = document.getElementById('page-num');
        const pageCount = document.getElementById('page-count');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const downloadBtn = document.getElementById('download-btn');
        
        // Ensure preview container is visible immediately
        if (previewContainer) {
            previewContainer.style.display = 'flex';
            previewContainer.style.visibility = 'visible';
        }
        if (pdfPageWrapper) {
            pdfPageWrapper.style.display = 'block';
            pdfPageWrapper.style.visibility = 'visible';
        }
        const ocrBtn = document.getElementById('ocr-btn');
        const addTextBtn = document.getElementById('add-text-btn');
        const addImageBtn = document.getElementById('add-image-btn');
        const highlightBtn = document.getElementById('highlight-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const imageInput = document.getElementById('image-input');
        
        // Additional DOM elements with null checks
        const imageScaleValue = document.getElementById('image-scale-value'); // For future image scale feature
        const highlightColorBtns = document.querySelectorAll('.highlight-color-btn'); // For future highlight colors feature
        
        // Load PDF from IndexedDB or sessionStorage
        async function loadPDF() {
            try {
                console.log('Starting PDF load process...');
                console.log('sessionStorage pdfFileURL:', sessionStorage.getItem('pdfFileURL') ? 'Found' : 'Not found');
                
                // Ensure preview container is visible immediately
                if (previewContainer) {
                    previewContainer.style.display = 'flex';
                    previewContainer.style.visibility = 'visible';
                }
                if (pdfPageWrapper) {
                    pdfPageWrapper.style.display = 'block';
                    pdfPageWrapper.style.visibility = 'visible';
                }
                if (loadingOverlay) loadingOverlay.style.display = 'flex';
                
                let pdfData = null;
                let fileName = 'document.pdf';
                
                // Try IndexedDB first
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('PDFEditorDB', 1);
                    
                    request.onerror = function() {
                        console.warn('IndexedDB error, trying sessionStorage');
                        loadFromSessionStorage().then(resolve).catch(reject);
                    };
                    
                    request.onsuccess = async function() {
                        try {
                            const db = request.result;
                            if (db.objectStoreNames.contains('pdfFiles')) {
                                const transaction = db.transaction(['pdfFiles'], 'readonly');
                                const store = transaction.objectStore('pdfFiles');
                                const getAllRequest = store.getAll();
                                
                                getAllRequest.onsuccess = async function() {
                                    try {
                                        const allFiles = getAllRequest.result;
                                        if (allFiles && allFiles.length > 0) {
                                            const latestFile = allFiles.sort((a, b) => {
                                                const idA = a.id || a.timestamp || 0;
                                                const idB = b.id || b.timestamp || 0;
                                                return idB - idA;
                                            })[0];
                                            
                                            if (latestFile && latestFile.data) {
                                                pdfData = latestFile.data;
                                                fileName = latestFile.name || 'document.pdf';
                                                await renderPDF(pdfData);
                                                resolve();
                                                return;
                                            }
                                        }
                                        // Fallback to sessionStorage
                                        await loadFromSessionStorage();
                                        resolve();
                                    } catch (error) {
                                        console.error('Error processing IndexedDB files:', error);
                                        await loadFromSessionStorage();
                                        resolve();
                                    }
                                };
                                
                                getAllRequest.onerror = function() {
                                    console.warn('Error getting files from IndexedDB, trying sessionStorage');
                                    loadFromSessionStorage().then(resolve).catch(reject);
                                };
                            } else {
                                // No object store, try sessionStorage
                                await loadFromSessionStorage();
                                resolve();
                            }
                        } catch (error) {
                            console.error('Error in IndexedDB success handler:', error);
                            loadFromSessionStorage().then(resolve).catch(reject);
                        }
                    };
                    
                    request.onupgradeneeded = function(event) {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('pdfFiles')) {
                            db.createObjectStore('pdfFiles', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            } catch (error) {
                console.error('Error loading PDF:', error);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                alert('Error loading PDF. Please upload a file again.');
                window.location.href = 'edit-pdf.html';
            }
        }
        
        async function loadFromSessionStorage() {
            const pdfFileURL = sessionStorage.getItem('pdfFileURL');
            console.log('Loading from sessionStorage, URL:', pdfFileURL ? 'Found' : 'Not found');
            
            if (pdfFileURL) {
                try {
                    console.log('Fetching PDF from Blob URL:', pdfFileURL);
                    
                    // Ensure preview is visible immediately
                    if (previewContainer) {
                        previewContainer.style.display = 'flex';
                        previewContainer.style.visibility = 'visible';
                    }
                    if (pdfPageWrapper) {
                        pdfPageWrapper.style.display = 'block';
                        pdfPageWrapper.style.visibility = 'visible';
                    }
                    
                    // Show loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'flex';
                    }
                    
                    const response = await fetch(pdfFileURL);
                    if (!response.ok) {
                        throw new Error('Failed to fetch PDF from Blob URL: ' + response.status);
                    }
                    const data = await response.arrayBuffer();
                    console.log('PDF data fetched successfully, size:', data.byteLength, 'bytes');
                    
                    // Render PDF immediately
                    await renderPDF(data);
                } catch (error) {
                    console.error('Error loading from sessionStorage:', error);
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    
                    // Try to show helpful error message
                    const errorMsg = error.message || 'Unknown error';
                    console.error('PDF loading error details:', errorMsg);
                    
                    // Don't redirect immediately - let user try again or upload new file
                    if (previewContainer) {
                        previewContainer.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #666;">
                                <h3>PDF Load Error</h3>
                                <p>${errorMsg}</p>
                                <button onclick="window.location.href='edit-pdf.html'" style="padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                                    Upload New PDF
                                </button>
                            </div>
                        `;
                    }
                }
            } else {
                console.error('No pdfFileURL found in sessionStorage');
                console.log('Available sessionStorage keys:', Object.keys(sessionStorage));
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                
                // Show helpful message
                if (previewContainer) {
                    previewContainer.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>No PDF Found</h3>
                            <p>Please upload a PDF file first.</p>
                            <button onclick="window.location.href='edit-pdf.html'" style="padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                                Upload PDF
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Render PDF
        async function renderPDF(pdfData) {
            try {
                if (!pdfjsLib) {
                    throw new Error('PDF.js library not loaded');
                }
                
                console.log('Starting PDF render, data size:', pdfData.byteLength || pdfData.length);
                
                // Ensure preview container is visible immediately
                if (previewContainer) {
                    previewContainer.style.display = 'flex';
                    previewContainer.style.visibility = 'visible';
                }
                
                const loadingTask = pdfjsLib.getDocument({ data: pdfData });
                pdfDoc = await loadingTask.promise;
                setPdfDoc(pdfDoc);
                totalPages = pdfDoc.numPages;
                setTotalPages(totalPages);
                
                console.log('PDF loaded successfully, total pages:', totalPages);
                
                if (pageCount) pageCount.textContent = totalPages;
                
                // Render first page immediately
                await renderPage(currentPage);
                
                // Ensure everything is visible
                if (pdfPageWrapper) {
                    pdfPageWrapper.style.display = 'block';
                    pdfPageWrapper.style.visibility = 'visible';
                }
                if (previewContainer) {
                    previewContainer.style.display = 'flex';
                    previewContainer.style.visibility = 'visible';
                }
                
                // Hide loading overlay after a brief moment to ensure smooth transition
                setTimeout(() => {
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                }, 100);
                
                if (downloadBtn) downloadBtn.disabled = false;
                
                updatePageButtons();
                
                console.log('PDF rendered successfully and visible');
            } catch (error) {
                console.error('Error rendering PDF:', error);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                alert('Error rendering PDF: ' + error.message);
            }
        }
        
        // Render specific page
        async function renderPage(pageNumber) {
            try {
                if (!pdfDoc) {
                    console.error('PDF document not loaded');
                    return;
                }
                
                if (!pdfCanvas || !textLayer) {
                    console.error('Canvas or text layer not found');
                    return;
                }
                
                const page = await pdfDoc.getPage(pageNumber);
                const viewport = page.getViewport({ scale: scale });
                
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;
                
                const context = pdfCanvas.getContext('2d');
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Extract and render text layer for editing
                const textContent = await page.getTextContent();
                renderTextLayer(textContent, viewport);
                
                // Update current page number
                currentPage = pageNumber;
                setCurrentPage(pageNumber);
                window.currentPage = pageNumber; // Sync with window object
                updatePageButtons();
            } catch (error) {
                console.error('Error rendering page:', error);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
        }
        
        // Render text layer for editing
        function renderTextLayer(textContent, viewport) {
            textLayer.innerHTML = '';
            textLayer.style.width = viewport.width + 'px';
            textLayer.style.height = viewport.height + 'px';
            
            textContent.items.forEach((item, index) => {
                const textDiv = document.createElement('div');
                textDiv.className = 'editable-text';
                textDiv.textContent = item.str;
                textDiv.style.left = item.transform[4] + 'px';
                textDiv.style.top = (viewport.height - item.transform[5]) + 'px';
                textDiv.style.fontSize = Math.abs(item.transform[0]) + 'px';
                textDiv.style.fontFamily = item.fontName || 'Arial';
                textDiv.dataset.index = index;
                
                // Make text editable
                textDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectTextElement(this);
                });
                
                textDiv.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    editTextElement(this);
                });
                
                textLayer.appendChild(textDiv);
            });
        }
        
        // Select text element
        function selectTextElement(element) {
            if (selectedTextElement) {
                selectedTextElement.classList.remove('selected');
            }
            selectedTextElement = element;
            element.classList.add('selected');
        }
        
        // Edit text element
        function editTextElement(element) {
            element.contentEditable = true;
            element.classList.add('editing');
            element.focus();
            
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            element.addEventListener('blur', function() {
                element.contentEditable = false;
                element.classList.remove('editing');
                saveAnnotation();
            }, { once: true });
        }
        
        // Save annotation
        function saveAnnotation() {
            annotationHistory.push(JSON.parse(JSON.stringify(textAnnotations)));
            redoHistory = [];
            updateUndoRedoButtons();
        }
        
        // Update undo/redo buttons
        function updateUndoRedoButtons() {
            undoBtn.disabled = annotationHistory.length === 0;
            redoBtn.disabled = redoHistory.length === 0;
        }
        
        // Page navigation
        function updatePageButtons() {
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            pageNum.textContent = currentPage;
        }
        
        // Page navigation event listeners (with null checks to prevent duplicate registration)
        if (prevPageBtn && !prevPageBtn.hasAttribute('data-listener-attached')) {
            prevPageBtn.setAttribute('data-listener-attached', 'true');
            prevPageBtn.addEventListener('click', async function() {
                if (currentPage > 1) {
                    currentPage--;
                    setCurrentPage(currentPage);
                    window.currentPage = currentPage;
                    await renderPage(currentPage);
                }
            });
        }
        
        if (nextPageBtn && !nextPageBtn.hasAttribute('data-listener-attached')) {
            nextPageBtn.setAttribute('data-listener-attached', 'true');
            nextPageBtn.addEventListener('click', async function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    setCurrentPage(currentPage);
                    window.currentPage = currentPage;
                    await renderPage(currentPage);
                }
            });
        }
        
        // Tool buttons (with null checks to prevent errors)
        if (ocrBtn && !ocrBtn.hasAttribute('data-listener-attached')) {
            ocrBtn.setAttribute('data-listener-attached', 'true');
            ocrBtn.addEventListener('click', async function() {
            if (!pdfDoc) return;
            
            try {
                loadingOverlay.style.display = 'flex';
                
                // Get current page as image
                const page = await pdfDoc.getPage(currentPage);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                const imageData = canvas.toDataURL('image/png');
                
                // Send to backend for OCR
                const response = await fetch('/api/pdf-ocr/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: imageData.split(',')[1] // Remove data:image/png;base64, prefix
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.text) {
                    // Add extracted text as editable elements
                    if (result.words && result.words.length > 0) {
                        result.words.forEach((word, index) => {
                            if (word.text && word.boundingBox) {
                                const textElement = document.createElement('div');
                                textElement.className = 'editable-text';
                                textElement.textContent = word.text;
                                
                                // Convert bounding box coordinates to canvas coordinates
                                const viewport = page.getViewport({ scale: scale });
                                const canvasRect = pdfCanvas.getBoundingClientRect();
                                const scaleX = canvasRect.width / viewport.width;
                                const scaleY = canvasRect.height / viewport.height;
                                
                                textElement.style.left = (word.boundingBox.x * scaleX) + 'px';
                                textElement.style.top = (word.boundingBox.y * scaleY) + 'px';
                                textElement.style.fontSize = '14px';
                                textElement.style.color = '#000000';
                                textElement.style.cursor = 'text';
                                
                                // Make editable
                                textElement.addEventListener('click', function() {
                                    editTextElement(textElement);
                                });
                                
                                textLayer.appendChild(textElement);
                            }
                        });
                        
                        saveAnnotation();
                        alert('OCR completed! Extracted ' + result.words.length + ' words. Click on any text to edit.');
                    } else {
                        // Fallback: show full text
                        const textElement = document.createElement('div');
                        textElement.className = 'editable-text';
                        textElement.textContent = result.text;
                        textElement.style.left = '50px';
                        textElement.style.top = '50px';
                        textElement.style.fontSize = '14px';
                        textElement.style.color = '#000000';
                        textElement.style.cursor = 'text';
                        textElement.addEventListener('click', function() {
                            editTextElement(textElement);
                        });
                        textLayer.appendChild(textElement);
                        saveAnnotation();
                        alert('OCR completed! Extracted text added. Click to edit.');
                    }
                } else {
                    alert('OCR failed: ' + (result.error || 'Unknown error'));
                }
                
                loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error('OCR error:', error);
                loadingOverlay.style.display = 'none';
                alert('Error performing OCR: ' + error.message);
            }
            });
        }
        
        if (addTextBtn && !addTextBtn.hasAttribute('data-listener-attached')) {
            addTextBtn.setAttribute('data-listener-attached', 'true');
            addTextBtn.addEventListener('click', function() {
                activeTool = 'text';
                alert('Click on the PDF to add text at that location.');
                
                // Add click listener to canvas for text insertion
                pdfCanvas.style.cursor = 'text';
                pdfCanvas.addEventListener('click', async function addTextHandler(e) {
                    if (activeTool !== 'text') {
                        pdfCanvas.removeEventListener('click', addTextHandler);
                        pdfCanvas.style.cursor = 'default';
                        return;
                    }
                    
                    const text = prompt('Enter text to add:');
                    if (!text) {
                        activeTool = 'select';
                        pdfCanvas.style.cursor = 'default';
                        pdfCanvas.removeEventListener('click', addTextHandler);
                        return;
                    }
                    
                    const rect = pdfCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Create editable text element
                    const textElement = document.createElement('div');
                    textElement.className = 'editable-text';
                    textElement.textContent = text;
                    textElement.style.left = x + 'px';
                    textElement.style.top = y + 'px';
                    textElement.style.fontSize = '16px';
                    textElement.style.color = '#000000';
                    textLayer.appendChild(textElement);
                    
                    // Make it editable
                    editTextElement(textElement);
                    
                    // Save annotation
                    saveAnnotation();
                    
                    activeTool = 'select';
                    pdfCanvas.style.cursor = 'default';
                    pdfCanvas.removeEventListener('click', addTextHandler);
                }, { once: false });
            });
        }
        
        if (addImageBtn && !addImageBtn.hasAttribute('data-listener-attached')) {
            addImageBtn.setAttribute('data-listener-attached', 'true');
            addImageBtn.addEventListener('click', function() {
                if (imageInput) imageInput.click();
            });
        }
        
        if (imageInput && !imageInput.hasAttribute('data-listener-attached')) {
            imageInput.setAttribute('data-listener-attached', 'true');
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        activeTool = 'image';
                        pdfCanvas.style.cursor = 'crosshair';
                        
                        // Add click listener to canvas for image insertion
                        pdfCanvas.addEventListener('click', async function addImageHandler(clickEvent) {
                            if (activeTool !== 'image') {
                                pdfCanvas.removeEventListener('click', addImageHandler);
                                pdfCanvas.style.cursor = 'default';
                                return;
                            }
                            
                            const rect = pdfCanvas.getBoundingClientRect();
                            const x = clickEvent.clientX - rect.left;
                            const y = clickEvent.clientY - rect.top;
                            
                            // Create image element
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.position = 'absolute';
                            img.style.left = x + 'px';
                            img.style.top = y + 'px';
                            img.style.maxWidth = '200px';
                            img.style.maxHeight = '200px';
                            img.style.cursor = 'move';
                            img.style.zIndex = '10';
                            textLayer.appendChild(img);
                            
                            // Make image draggable
                            let isDragging = false;
                            let startX, startY, initialX, initialY;
                            
                            img.addEventListener('mousedown', function(e) {
                                isDragging = true;
                                startX = e.clientX;
                                startY = e.clientY;
                                initialX = img.offsetLeft;
                                initialY = img.offsetTop;
                            });
                            
                            document.addEventListener('mousemove', function(e) {
                                if (isDragging) {
                                    const dx = e.clientX - startX;
                                    const dy = e.clientY - startY;
                                    img.style.left = (initialX + dx) + 'px';
                                    img.style.top = (initialY + dy) + 'px';
                                }
                            });
                            
                            document.addEventListener('mouseup', function() {
                                isDragging = false;
                            });
                            
                            // Save annotation
                            saveAnnotation();
                            
                            activeTool = 'select';
                            pdfCanvas.style.cursor = 'default';
                            pdfCanvas.removeEventListener('click', addImageHandler);
                        }, { once: false });
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select a valid image file');
                }
            });
        }
        
        if (highlightBtn && !highlightBtn.hasAttribute('data-listener-attached')) {
            highlightBtn.setAttribute('data-listener-attached', 'true');
            highlightBtn.addEventListener('click', function() {
                activeTool = 'highlight';
                if (selectedTextElement) {
                    selectedTextElement.style.backgroundColor = '#FFFF00';
                }
            });
        }
        
        if (undoBtn && !undoBtn.hasAttribute('data-listener-attached')) {
            undoBtn.setAttribute('data-listener-attached', 'true');
            undoBtn.addEventListener('click', function() {
                if (annotationHistory.length > 0) {
                    redoHistory.push(annotationHistory.pop());
                    // Restore previous state
                    updateUndoRedoButtons();
                }
            });
        }
        
        if (redoBtn && !redoBtn.hasAttribute('data-listener-attached')) {
            redoBtn.setAttribute('data-listener-attached', 'true');
            redoBtn.addEventListener('click', function() {
                if (redoHistory.length > 0) {
                    annotationHistory.push(redoHistory.pop());
                    // Restore next state
                    updateUndoRedoButtons();
                }
            });
        }
        
        if (downloadBtn && !downloadBtn.hasAttribute('data-listener-attached')) {
            downloadBtn.setAttribute('data-listener-attached', 'true');
            downloadBtn.addEventListener('click', async function() {
                if (!pdfDoc) {
                    alert('No PDF loaded');
                    return;
                }
                
                try {
                    loadingOverlay.style.display = 'flex';
                    
                    // Get current PDF data
                    const pdfFileURL = sessionStorage.getItem('pdfFileURL');
                    if (!pdfFileURL) {
                        throw new Error('PDF file not found in storage');
                    }
                    
                    const response = await fetch(pdfFileURL);
                    const pdfArrayBuffer = await response.arrayBuffer();
                    
                    // Collect all edits (text + images)
                    const edits = {
                        textEdits: [],
                        imageInserts: []
                    };
                    
                    // Get text annotations
                    const textElements = textLayer.querySelectorAll('.editable-text');
                    textElements.forEach((el, index) => {
                        const rect = el.getBoundingClientRect();
                        const canvasRect = pdfCanvas.getBoundingClientRect();
                        const scaleX = pdfCanvas.width / canvasRect.width;
                        const scaleY = pdfCanvas.height / canvasRect.height;
                        
                        edits.textEdits.push({
                            pageIndex: currentPage - 1,
                            x: (rect.left - canvasRect.left) * scaleX,
                            y: (canvasRect.height - (rect.top - canvasRect.top)) * scaleY,
                            text: el.textContent,
                            fontSize: parseInt(getComputedStyle(el).fontSize) || 12,
                            fontColor: [0, 0, 0]
                        });
                    });
                    
                    // Get image elements
                    const imageElements = textLayer.querySelectorAll('img');
                    imageElements.forEach((img) => {
                        const rect = img.getBoundingClientRect();
                        const canvasRect = pdfCanvas.getBoundingClientRect();
                        const scaleX = pdfCanvas.width / canvasRect.width;
                        const scaleY = pdfCanvas.height / canvasRect.height;
                        
                        edits.imageInserts.push({
                            pageIndex: currentPage - 1,
                            imageData: img.src.split(',')[1],
                            x: (rect.left - canvasRect.left) * scaleX,
                            y: (canvasRect.height - (rect.top - canvasRect.top)) * scaleY,
                            width: rect.width * scaleX,
                            height: rect.height * scaleY
                        });
                    });
                    
                    // Convert PDF to base64
                    const pdfBase64 = btoa(String.fromCharCode(...new Uint8Array(pdfArrayBuffer)));
                    
                    // Send to backend for editing
                    const editResponse = await fetch('/api/pdf/edit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            pdfData: pdfBase64,
                            edits: edits
                        })
                    });
                    
                    const editResult = await editResponse.json();
                    
                    if (editResult.success) {
                        // Download edited PDF
                        const editedPdfBase64 = editResult.pdfData.split(',')[1];
                        const editedPdfBytes = Uint8Array.from(atob(editedPdfBase64), c => c.charCodeAt(0));
                        const blob = new Blob([editedPdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = sessionStorage.getItem('pdfFileName') || 'edited-document.pdf';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('PDF downloaded successfully!');
                    } else {
                        throw new Error(editResult.error || 'PDF editing failed');
                    }
                    
                    loadingOverlay.style.display = 'none';
                } catch (error) {
                    console.error('Download error:', error);
                    loadingOverlay.style.display = 'none';
                    alert('Error downloading PDF: ' + error.message);
                }
            });
        }
        
        // Initialize highlight color buttons if they exist (for future feature)
        if (highlightColorBtns && highlightColorBtns.length > 0) {
            highlightColorBtns.forEach(btn => {
                if (!btn.hasAttribute('data-listener-attached')) {
                    btn.setAttribute('data-listener-attached', 'true');
                    btn.addEventListener('click', function() {
                        highlightColorBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const color = btn.dataset.color || '#FFFF00';
                        if (selectedTextElement) {
                            selectedTextElement.style.backgroundColor = color;
                        }
                    });
                }
            });
        }
        
        // Initialize image scale value display if it exists (for future feature)
        if (imageScaleValue) {
            // This will be used when image scale slider is added
            console.log('Image scale value element found, ready for future feature');
        }
        
        // Feedback submission
        function submitFeedback() {
            const name = document.getElementById('feedback-name').value;
            const email = document.getElementById('feedback-email').value;
            const message = document.getElementById('feedback-message').value;
            
            if (!name || !email || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            alert('Thank you for your feedback! We appreciate your input.');
            document.getElementById('feedback-name').value = '';
            document.getElementById('feedback-email').value = '';
            document.getElementById('feedback-message').value = '';
        }
        
        // Initialize on page load - load immediately for instant preview
        (function initPDFEditor() {
            function startPDFLoad() {
                console.log('startPDFLoad called, pdfjsLib available:', typeof pdfjsLib !== 'undefined');
                
                // Ensure preview container is visible immediately
                if (previewContainer) {
                    previewContainer.style.display = 'flex';
                    previewContainer.style.visibility = 'visible';
                }
                if (pdfPageWrapper) {
                    pdfPageWrapper.style.display = 'block';
                    pdfPageWrapper.style.visibility = 'visible';
                }
                
                // Wait for PDF.js to load
                if (typeof pdfjsLib === 'undefined') {
                    console.warn('PDF.js library not loaded yet, retrying...');
                    // Retry after a short delay in case script is still loading
                    setTimeout(() => {
                        if (typeof pdfjsLib !== 'undefined') {
                            console.log('PDF.js loaded, starting PDF load');
                            startPDFLoad();
                        } else {
                            console.error('PDF.js library failed to load after retry');
                            if (loadingOverlay) loadingOverlay.style.display = 'none';
                            alert('PDF.js library failed to load. Please refresh the page.');
                        }
                    }, 100);
                    return;
                }
                
                // Set PDF.js worker if not already set
                if (pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    console.log('PDF.js worker configured');
                }
                
                // Load PDF immediately - no delay for instant preview
                console.log('Calling loadPDF()...');
                loadPDF().catch(error => {
                    console.error('Failed to load PDF:', error);
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                });
            }
            
            // Start loading as soon as possible
            function init() {
                // Ensure DOM elements exist
                if (!previewContainer || !pdfCanvas) {
                    // Wait a bit if DOM not ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', init);
                        return;
                    }
                }
                startPDFLoad();
            }
            
            // Start immediately if DOM is ready, otherwise wait
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                // DOM already loaded, start immediately
                init();
            }
        })();
        })(); // Close the outer IIFE
    </script>
</body>
</html>

