<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>PDF to Excel Premium - OCR Conversion | High Accuracy Excel Export | easyjpgtopdf</title>
<meta name="description" content="Premium PDF to Excel conversion with OCR technology. High-accuracy table extraction for scanned PDFs, complex tables, and multi-page documents. Enterprise-grade Google Document AI processing.">
<meta name="keywords" content="pdf to excel premium, pdf to excel ocr, scanned pdf to excel, premium pdf converter, ocr pdf to excel, document ai excel, high accuracy pdf conversion">
<meta name="robots" content="index, follow">
<meta name="author" content="easyjpgtopdf">
<link rel="canonical" href="https://easyjpgtopdf.com/pdf-to-excel-premium.html">
<link rel="stylesheet" href="css/header.css">
<link href="css/footer.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    :root {
        --primary: #4361ee;
        --secondary: #3a0ca3;
        --accent: #4cc9f0;
        --light: #f8f9fa;
        --dark: #0f172a;
        --muted: #6b7280;
        --surface: #ffffff;
        --border: #e5e7eb;
        --success: #0f9d58;
        --danger: #dc2626;
    }
    body {
        background: #f5f7ff;
        min-height: 100vh;
        color: var(--dark);
        line-height: 1.6;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
        width: 100%;
    }
    .hero {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: #fff;
        padding: 48px 0;
        text-align: center;
    }
    .hero h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 12px;
    }
    .hero p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    .premium-section {
        padding: 60px 0;
    }
    .premium-card {
        background: var(--surface);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 24px;
    }
    .premium-card h2 {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 1.75rem;
    }
    .upload-area {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        background: var(--light);
        margin: 24px 0;
        transition: all 0.3s;
    }
    .upload-area.dragover {
        border-color: var(--primary);
        background: rgba(67, 97, 238, 0.05);
    }
    .upload-area i {
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 16px;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        border-radius: 30px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s ease;
        text-decoration: none;
        font-size: 1rem;
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: #fff;
        box-shadow: 0 4px 16px rgba(67, 97, 238, 0.3);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }
    .btn-secondary {
        background: var(--light);
        color: var(--dark);
        border: 1px solid var(--border);
    }
    .btn-secondary:hover {
        background: var(--border);
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--light);
        border-radius: 4px;
        overflow: hidden;
        margin: 20px 0;
        display: none;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        width: 0%;
        transition: width 0.3s;
    }
    .status-message {
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        display: none;
    }
    .status-message.success {
        background: rgba(15, 157, 88, 0.1);
        color: var(--success);
        border-left: 4px solid var(--success);
    }
    .status-message.error {
        background: rgba(220, 38, 38, 0.1);
        color: var(--danger);
        border-left: 4px solid var(--danger);
    }
    .status-message.info {
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary);
        border-left: 4px solid var(--primary);
    }
    .file-info {
        display: none;
        padding: 16px;
        background: var(--light);
        border-radius: 8px;
        margin: 16px 0;
    }
    .file-info.show {
        display: block;
    }
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 24px;
    }
    .back-link:hover {
        color: var(--secondary);
    }
    .credit-info {
        background: rgba(67, 97, 238, 0.1);
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        border-left: 4px solid var(--primary);
    }
    
    /* Breadcrumb Navigation */
    .breadcrumb-nav {
        padding: 15px 0;
        background: #f8f9ff;
        border-bottom: 1px solid #e2e6ff;
    }
    .breadcrumb-nav .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    .breadcrumb-nav ol {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 0;
        padding: 0;
        align-items: center;
    }
    .breadcrumb-nav a {
        color: #4361ee;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
    }
    .breadcrumb-nav a:hover {
        color: #3a0ca3;
    }
    .breadcrumb-nav span {
        margin: 0 8px;
        color: #9ca3af;
    }
    
    /* SSL Security Badge */
    .ssl-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: rgba(15, 157, 88, 0.1);
        color: var(--success);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 12px;
    }
    
    /* SEO Structured Content */
    .seo-content {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 24px;
    }
    .seo-section {
        background: var(--surface);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .seo-section h2 {
        color: var(--primary);
        font-size: 1.75rem;
        margin-bottom: 16px;
    }
    .seo-section h3 {
        color: var(--dark);
        font-size: 1.25rem;
        margin-top: 24px;
        margin-bottom: 12px;
    }
    .seo-section h4 {
        color: var(--muted);
        font-size: 1.1rem;
        margin-top: 16px;
        margin-bottom: 8px;
    }
    .seo-section p {
        color: var(--muted);
        line-height: 1.8;
        margin-bottom: 12px;
    }
    .seo-section ul {
        list-style: none;
        padding: 0;
    }
    .seo-section ul li {
        padding: 8px 0;
        padding-left: 24px;
        position: relative;
    }
    .seo-section ul li:before {
        content: "✓";
        position: absolute;
        left: 0;
        color: var(--success);
        font-weight: bold;
    }
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "PDF to Excel Premium - OCR Conversion | High Accuracy Excel Export",
  "description": "Premium PDF to Excel conversion with OCR technology. High-accuracy table extraction for scanned PDFs, complex tables, and multi-page documents using Google Document AI.",
  "url": "https://easyjpgtopdf.com/pdf-to-excel-premium.html",
  "inLanguage": "en-US",
  "isPartOf": {
    "@type": "WebSite",
    "name": "easyjpgtopdf",
    "url": "https://easyjpgtopdf.com"
  },
  "publisher": {
    "@type": "Organization",
    "name": "easyjpgtopdf",
    "url": "https://easyjpgtopdf.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://easyjpgtopdf.com/logo.png"
    }
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://easyjpgtopdf.com"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "PDF to Excel",
        "item": "https://easyjpgtopdf.com/pdf-to-excel.html"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": "Premium Conversion",
        "item": "https://easyjpgtopdf.com/pdf-to-excel-premium.html"
      }
    ]
  },
  "mainEntity": {
    "@type": "SoftwareApplication",
    "name": "PDF to Excel Premium Converter",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "description": "Pay per page conversion using credits"
    },
    "featureList": [
      "OCR Technology for scanned PDFs",
      "Complex table extraction",
      "Multi-page document support",
      "Google Document AI processing",
      "High accuracy conversion"
    ]
  }
}
</script>
</head>
<body>
<!-- Account Section (loaded by global-components.js) -->
<div id="account-section"></div>
<!-- Global Header with Account Bar -->
<div id="global-header-placeholder"></div>

<!-- Breadcrumb Navigation -->
<nav aria-label="Breadcrumb" class="breadcrumb-nav">
    <div class="container">
        <ol>
            <li><a href="index.html">Home</a></li>
            <li><span>|</span></li>
            <li><a href="pdf-to-excel.html">PDF to Excel</a></li>
            <li><span>|</span></li>
            <li><a href="pdf-to-excel-convert.html">Convert</a></li>
            <li><span>|</span></li>
            <li>Premium</li>
        </ol>
    </div>
</nav>

<div class="hero">
    <div class="container">
        <h1><i class="fas fa-star"></i> Premium PDF to Excel Conversion</h1>
        <p>High-accuracy OCR-powered conversion for scanned PDFs and complex tables</p>
        <div class="ssl-badge">
            <i class="fas fa-lock"></i> SSL Secured
        </div>
    </div>
</div>

<main class="premium-section">
    <div class="container">
        <a href="pdf-to-excel-convert.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Basic Conversion
        </a>

        <div class="premium-card">
            <h2><i class="fas fa-file-excel"></i> Upload PDF for Premium Conversion</h2>
            
            <div id="creditInfo" class="credit-info" style="display: none;">
                <strong>Your Credits:</strong> <span id="creditBalance">0</span>
                <br>
                <small>Premium conversion requires minimum 30 credits. Credits are deducted per page after successful conversion.</small>
            </div>

            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Drop PDF file here or click to browse</h3>
                <p style="color: var(--muted); margin-top: 8px;">Maximum file size: 100 MB</p>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>

            <div class="file-info" id="fileInfo">
                <strong>Selected File:</strong> <span id="fileName"></span>
                <br>
                <small>Size: <span id="fileSize"></span></small>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" id="convertBtn" disabled>
                    <i class="fas fa-magic"></i> Convert with Premium OCR
                </button>
                <button class="btn btn-secondary" id="cancelBtn" style="display: none;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>

        <div class="premium-card">
            <h2><i class="fas fa-info-circle"></i> Premium Features</h2>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                    <strong>OCR Technology:</strong> Extract text from scanned PDFs and images
                </li>
                <li style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                    <strong>Complex Tables:</strong> Handle merged cells, multi-line headers, and complex layouts
                </li>
                <li style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                    <strong>High Accuracy:</strong> Enterprise-grade table extraction with Google Document AI
                </li>
                <li style="padding: 12px 0;">
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                    <strong>Multi-Processor:</strong> Automatic processor selection based on document type
                </li>
            </ul>
        </div>
    </div>
</main>

<!-- SEO Content Section -->
<section class="seo-content">
    <div class="seo-section">
        <h2>Premium PDF to Excel Conversion with OCR Technology</h2>
        <p>Our premium PDF to Excel converter uses advanced OCR (Optical Character Recognition) technology powered by Google Document AI to extract tables and data from scanned PDFs, images, and complex documents with enterprise-grade accuracy.</p>
        
        <h3>Why Choose Premium PDF to Excel Conversion?</h3>
        <h4>Advanced OCR Processing</h4>
        <p>Unlike basic converters that only work with text-based PDFs, our premium service can extract data from scanned documents, images, and PDFs without selectable text. The OCR technology recognizes text, tables, and structures even from low-quality scans.</p>
        
        <h4>Complex Table Extraction</h4>
        <p>Handle complex table structures including:</p>
        <ul>
            <li>Merged cells and multi-line headers</li>
            <li>Nested tables and irregular layouts</li>
            <li>Multi-page tables with repeating headers</li>
            <li>Tables with images and annotations</li>
        </ul>
        
        <h4>Multi-Processor Intelligence</h4>
        <p>Our system automatically selects the best Document AI processor based on your document type:</p>
        <ul>
            <li><strong>Layout Parser:</strong> For scanned documents and image-heavy PDFs</li>
            <li><strong>Form Parser:</strong> For invoices, forms, and structured documents</li>
            <li><strong>Table Parser:</strong> For complex tables and spreadsheets</li>
        </ul>
        
        <h3>How Premium Conversion Works</h3>
        <h4>Step 1: Upload Your PDF</h4>
        <p>Upload your scanned PDF or complex document. Maximum file size is 100 MB.</p>
        
        <h4>Step 2: Automatic Processing</h4>
        <p>Our system analyzes your document and selects the optimal processor for best results.</p>
        
        <h4>Step 3: High-Accuracy Extraction</h4>
        <p>Google Document AI processes your document with enterprise-grade OCR technology.</p>
        
        <h4>Step 4: Download Excel File</h4>
        <p>Receive your converted Excel file with preserved formatting, structure, and data accuracy.</p>
        
        <h3>Credit System</h3>
        <p>Premium conversion uses a pay-per-page credit system. Credits are deducted only after successful conversion. Minimum 30 credits required to access premium features.</p>
        
        <h3>Security & Privacy</h3>
        <p>All conversions are processed securely with SSL encryption. Files are automatically deleted after processing. Your data privacy is our priority.</p>
    </div>
</section>

<!-- Footer -->
<div id="global-footer-placeholder"></div>

<!-- Load scripts in correct order - no defer for critical scripts -->
<script src="js/global-components.js"></script>
<!-- Firebase Authentication - Required for user login and credits -->
<script src="js/auth.js" type="module"></script>
<script>
// Load header and footer via global-components.js
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Premium page DOMContentLoaded - starting initialization');
    
    // CRITICAL: Wait for scripts to load first
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Ensure account section loads (before header)
    let accountSectionLoaded = false;
    if (typeof window.loadAccountSection === 'function') {
        window.loadAccountSection();
        accountSectionLoaded = true;
    } else {
        // Wait for global-components.js to load
        let attempts = 0;
        const checkAccountSection = setInterval(() => {
            attempts++;
            if (typeof window.loadAccountSection === 'function') {
                window.loadAccountSection();
                accountSectionLoaded = true;
                clearInterval(checkAccountSection);
            } else if (attempts >= 50) {
                clearInterval(checkAccountSection);
                console.warn('loadAccountSection not found after 5 seconds');
            }
        }, 100);
    }
    
    // Ensure auth UI is initialized (for account section visibility)
    let authUIInitialized = false;
    if (typeof window.initializeAuthUI === 'function') {
        window.initializeAuthUI();
        authUIInitialized = true;
    } else {
        // Wait for auth.js to load
        let attempts = 0;
        const checkAuthUI = setInterval(() => {
            attempts++;
            if (typeof window.initializeAuthUI === 'function') {
                window.initializeAuthUI();
                authUIInitialized = true;
                clearInterval(checkAuthUI);
            } else if (attempts >= 50) {
                clearInterval(checkAuthUI);
                console.warn('initializeAuthUI not found after 5 seconds');
            }
        }, 100);
    }
    
    // Global header is loaded by global-components.js
    // Footer is loaded via global-components.js
    if (typeof window.loadGlobalFooter === 'function') {
        window.loadGlobalFooter();
    } else {
        // Wait for global-components.js to load
        let attempts = 0;
        const checkFooter = setInterval(() => {
            attempts++;
            if (typeof window.loadGlobalFooter === 'function') {
                window.loadGlobalFooter();
                clearInterval(checkFooter);
            } else if (attempts >= 20) {
                clearInterval(checkFooter);
            }
        }, 100);
    }
    
    // CRITICAL: Wait for auth to be ready before checking credits
    // This ensures we get the correct user ID
    let authReady = false;
    if (window.auth && window.auth.currentUser) {
        authReady = true;
    } else {
        // Wait for auth.js to load and set window.auth
        for (let i = 0; i < 30; i++) {
            await new Promise(resolve => setTimeout(resolve, 100));
            if (window.auth) {
                // Wait for auth state to be determined
                if (window.auth.currentUser) {
                    authReady = true;
                    break;
                } else {
                    // Wait for onAuthStateChanged to fire
                    const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js");
                    await new Promise((resolve) => {
                        const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                            unsubscribe();
                            authReady = true;
                            resolve();
                        });
                        setTimeout(() => {
                            unsubscribe();
                            resolve();
                        }, 2000);
                    });
                    if (authReady) break;
                }
            }
        }
    }
    
    // CRITICAL: Check credits AFTER auth is ready
    creditsCheckPassed = await checkCredits();
    
    // Force account section to show if user is logged in
    // Multiple retries to ensure it shows
    const showAccountSection = () => {
        if (window.auth) {
            const user = window.auth.currentUser;
            if (user) {
                console.log('User logged in, showing account section:', user.uid);
                const accountSection = document.getElementById('account-section');
                if (accountSection) {
                    // Force show account section
                    accountSection.style.setProperty('display', 'block', 'important');
                    accountSection.style.setProperty('visibility', 'visible', 'important');
                    accountSection.removeAttribute('hidden');
                    accountSection.classList.remove('hidden');
                    
                    // Also ensure user menu is visible
                    const userMenu = accountSection.querySelector('#user-menu');
                    if (userMenu) {
                        userMenu.style.display = 'block';
                    }
                }
                // Force update UI
                if (typeof window.updateUI === 'function') {
                    window.updateUI(user);
                }
                // Also try to initialize auth UI again
                if (typeof window.initializeAuthUI === 'function') {
                    window.initializeAuthUI();
                }
                return true;
            }
        }
        return false;
    };
    
    // Try immediately
    if (!showAccountSection()) {
        // Retry after 500ms
        setTimeout(() => {
            if (!showAccountSection()) {
                // Retry after 1 second
                setTimeout(() => {
                    if (!showAccountSection()) {
                        // Final retry after 2 seconds
                        setTimeout(showAccountSection, 2000);
                    }
                }, 1000);
            }
        }, 500);
    }
    
    // Also listen for auth state changes
    if (window.auth) {
        import("https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js").then(({ onAuthStateChanged }) => {
            const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    console.log('Auth state changed - user logged in:', user.uid);
                    showAccountSection();
                }
            });
            // Keep listener for 10 seconds
            setTimeout(() => unsubscribe(), 10000);
        }).catch(err => console.warn('Could not import onAuthStateChanged:', err));
    }
    
    // Always initialize upload handlers, but they will check credits internally
    // This ensures upload area is clickable even if credits check is delayed
    await initializeUploadHandlers();
    
    // After credits check, update upload handlers state
    if (creditsCheckPassed) {
        console.log('✅ Credits check passed - enabling upload features');
        // Re-enable upload area
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        
        if (uploadArea) {
            uploadArea.style.pointerEvents = 'auto';
            uploadArea.style.opacity = '1';
            uploadArea.style.cursor = 'pointer';
            uploadArea.classList.remove('disabled');
        }
        if (fileInput) {
            fileInput.disabled = false;
        }
        if (convertBtn) {
            convertBtn.disabled = false;
        }
        
        // Load PDF from sessionStorage if available
        loadPdfFromSession();
    } else {
        console.warn('❌ Credits check failed - upload disabled');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        if (uploadArea) {
            uploadArea.style.opacity = '0.7';
            uploadArea.style.cursor = 'not-allowed';
        }
        if (fileInput) fileInput.disabled = true;
        if (convertBtn) convertBtn.disabled = true;
    }
});

// Load PDF from sessionStorage
async function loadPdfFromSession() {
    try {
        const stored = sessionStorage.getItem('pdfToExcelPremiumData');
        if (stored) {
            const data = JSON.parse(stored);
            const now = Date.now();
            
            // Check if data is not too old (5 minutes)
            if (now - data.timestamp < 5 * 60 * 1000) {
                // Convert base64 back to blob
                const binaryString = atob(data.data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });
                
                // Set file info
                document.getElementById('fileName').textContent = data.filename;
                document.getElementById('fileSize').textContent = formatFileSize(blob.size);
                document.getElementById('fileInfo').classList.add('show');
                
                // Store blob for conversion
                window.premiumPdfBlob = blob;
                window.premiumPdfFilename = data.filename;
                
                // Enable convert button
                document.getElementById('convertBtn').disabled = false;
                
                // Clear sessionStorage
                sessionStorage.removeItem('pdfToExcelPremiumData');
            }
        }
    } catch (error) {
        console.error('Error loading PDF from session:', error);
    }
}

// Check user credits and block access if insufficient
async function checkCredits() {
    try {
        const API_BASE_URL = 'https://pdf-to-excel-backend-iwumaktavq-uc.a.run.app';
        const MIN_REQUIRED_CREDITS = 30;
        
        // Get user ID - prefer Firebase auth, fallback to PDFExcelUserType
        let userId = 'anonymous';
        
        // First try Firebase auth (most reliable)
        if (window.auth && window.auth.currentUser) {
            userId = window.auth.currentUser.uid;
            console.log('Using Firebase auth user ID:', userId);
        } else if (window.auth) {
            // Wait for auth state if auth is ready but user not loaded yet
            const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js");
            await new Promise((resolve) => {
                let resolved = false;
                const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                    if (!resolved) {
                        resolved = true;
                        unsubscribe();
                        if (user && user.uid) {
                            userId = user.uid;
                            console.log('Got user ID from auth state change:', userId);
                        }
                        resolve();
                    }
                });
                setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        unsubscribe();
                        console.warn('Auth state change timeout, using fallback');
                        resolve();
                    }
                }, 2000);
            });
        }
        
        // Fallback to PDFExcelUserType if Firebase auth didn't provide user ID
        if (userId === 'anonymous' && window.PDFExcelUserType) {
            userId = await window.PDFExcelUserType.getUserId();
            console.log('Using PDFExcelUserType user ID:', userId);
        }
        
        // Log final user ID for debugging
        console.log('Final user ID for credits check:', userId);
        
        console.log(`Checking credits for user: ${userId}, API: ${API_BASE_URL}/api/credits`);
        
        const response = await fetch(`${API_BASE_URL}/api/credits`, {
            method: 'GET',
            headers: {
                'X-User-ID': userId
            }
        });
        
        console.log('Credits API response status:', response.status, response.statusText);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Credits API response data:', data);
            const credits = data.credits || 0;
            
            console.log(`User has ${credits} credits, minimum required: ${MIN_REQUIRED_CREDITS}`);
            
            // Update credit display
            const creditBalanceEl = document.getElementById('creditBalance');
            const creditInfoEl = document.getElementById('creditInfo');
            if (creditBalanceEl) {
                creditBalanceEl.textContent = credits;
            }
            if (creditInfoEl) {
                creditInfoEl.style.display = 'block';
            }
            
            // CRITICAL: Block page access if credits < 30
            if (credits < MIN_REQUIRED_CREDITS) {
                console.warn(`Access denied: User has ${credits} credits, need ${MIN_REQUIRED_CREDITS}`);
                // Hide all premium features
                const premiumCard = document.querySelector('.premium-card');
                if (premiumCard) {
                    premiumCard.style.display = 'none';
                }
                
                // Show access denied message
                const accessDeniedHTML = `
                    <div class="premium-card" style="text-align: center; padding: 60px 40px;">
                        <i class="fas fa-lock" style="font-size: 4rem; color: var(--danger); margin-bottom: 24px;"></i>
                        <h2 style="color: var(--danger); margin-bottom: 16px;">Access Restricted</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 24px; color: var(--muted);">
                            Premium conversion requires minimum <strong>${MIN_REQUIRED_CREDITS} credits</strong>.
                            <br>Your current balance: <strong>${credits} credits</strong>
                        </p>
                        <p style="margin-bottom: 32px; color: var(--muted);">
                            Please purchase credits to access premium features.
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <a href="pricing.html" class="btn btn-primary" style="text-decoration: none;">
                                <i class="fas fa-shopping-cart"></i> Purchase Credits
                            </a>
                            <a href="pdf-to-excel-convert.html" class="btn btn-secondary" style="text-decoration: none;">
                                <i class="fas fa-arrow-left"></i> Back to Basic Conversion
                            </a>
                        </div>
                    </div>
                `;
                
                // Insert access denied message before premium card
                const premiumSection = document.querySelector('.premium-section');
                if (premiumSection) {
                    premiumSection.insertAdjacentHTML('afterbegin', accessDeniedHTML);
                }
                
                // Disable all upload and conversion features
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const convertBtn = document.getElementById('convertBtn');
                
                if (uploadArea) uploadArea.style.pointerEvents = 'none';
                if (fileInput) fileInput.disabled = true;
                if (convertBtn) convertBtn.disabled = true;
                
                showStatus(`Insufficient credits. Minimum ${MIN_REQUIRED_CREDITS} credits required. You have ${credits}. Please purchase credits to continue.`, 'error');
                
                // Log access attempt
                console.warn(`Premium page access denied: User ${userId} has ${credits} credits (minimum ${MIN_REQUIRED_CREDITS} required)`);
                
                return false; // Access denied
            } else {
                // Credits sufficient - allow access
                console.log(`✅ Premium page access granted: User ${userId} has ${credits} credits (>= ${MIN_REQUIRED_CREDITS})`);
                console.log('Setting creditsCheckPassed = true');
                return true; // Access granted
            }
        } else {
            // If credits API fails, still block access for safety
            console.error('Failed to check credits, blocking access for safety');
            const premiumCard = document.querySelector('.premium-card');
            if (premiumCard) {
                premiumCard.style.display = 'none';
            }
            showStatus('Unable to verify credits. Please refresh the page or contact support.', 'error');
            return false;
        }
    } catch (error) {
        console.error('Error checking credits:', error);
        // On error, block access for safety
        const premiumCard = document.querySelector('.premium-card');
        if (premiumCard) {
            premiumCard.style.display = 'none';
        }
        showStatus('Error checking credits. Please refresh the page or contact support.', 'error');
        return false;
    }
}

// File upload handlers (only enable if credits check passes)
let creditsCheckPassed = false;

// Initialize upload handlers after credits check
async function initializeUploadHandlers() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    if (!uploadArea || !fileInput) {
        console.error('Upload area or file input not found');
        return;
    }
    
    console.log('Initializing upload handlers, creditsCheckPassed:', creditsCheckPassed);
    
    // Always add event handlers, but check credits inside
    // Click handler - Remove preventDefault to allow native file dialog
    uploadArea.addEventListener('click', (e) => {
        console.log('Upload area clicked, creditsCheckPassed:', creditsCheckPassed);
        // Don't prevent default - let the click work naturally
        if (creditsCheckPassed) {
            // Trigger file input click
            e.stopPropagation();
            fileInput.click();
        } else {
            e.preventDefault();
            e.stopPropagation();
            showStatus('Insufficient credits. Minimum 30 credits required. Please purchase credits to continue.', 'error');
        }
    });
    
    // Enable upload area visually if credits passed
    if (creditsCheckPassed) {
        uploadArea.style.pointerEvents = 'auto';
        uploadArea.style.opacity = '1';
        uploadArea.style.cursor = 'pointer';
        fileInput.disabled = false;
        if (convertBtn) convertBtn.disabled = false;
        console.log('Upload handlers enabled - credits check passed');
    } else {
        uploadArea.style.pointerEvents = 'auto'; // Still allow click to show error
        uploadArea.style.opacity = '0.7';
        uploadArea.style.cursor = 'not-allowed';
        fileInput.disabled = true;
        if (convertBtn) convertBtn.disabled = true;
        console.log('Upload handlers initialized but disabled - credits check failed');
    }
    
    // Drag and drop handlers (always add, check credits inside)
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
        console.log('File dropped, creditsCheckPassed:', creditsCheckPassed);
        if (!creditsCheckPassed) {
            showStatus('Insufficient credits. Minimum 30 credits required. Please purchase credits to continue.', 'error');
            return;
        }
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            handleFileSelect(files[0]);
        } else {
            showStatus('Please drop a PDF file.', 'error');
        }
    });
    
    // File input change handler (always add, check credits inside)
    fileInput.addEventListener('change', (e) => {
        console.log('File input changed, creditsCheckPassed:', creditsCheckPassed, 'Files:', e.target.files.length);
        // Re-check credits at the time of file selection (in case it changed)
        if (!creditsCheckPassed) {
            showStatus('Insufficient credits. Minimum 30 credits required. Please purchase credits to continue.', 'error');
            e.target.value = ''; // Clear selection
            return;
        }
        if (e.target.files && e.target.files.length > 0) {
            console.log('Calling handleFileSelect with file:', e.target.files[0].name);
            handleFileSelect(e.target.files[0]);
        } else {
            console.warn('No files selected');
        }
    });
}

function handleFileSelect(file) {
    if (file.type !== 'application/pdf') {
        showStatus('Please select a PDF file.', 'error');
        return;
    }
    
    if (file.size > 100 * 1024 * 1024) {
        showStatus('File size exceeds 100 MB limit.', 'error');
        return;
    }
    
    // Check credits before allowing file selection
    if (!creditsCheckPassed) {
        showStatus('Insufficient credits. Minimum 30 credits required. Please purchase credits to continue.', 'error');
        return;
    }
    
    window.premiumPdfBlob = file;
    window.premiumPdfFilename = file.name;
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').classList.add('show');
    const convertBtn = document.getElementById('convertBtn');
    if (convertBtn) convertBtn.disabled = false;
}

// Convert button handler
const convertBtn = document.getElementById('convertBtn');
if (convertBtn) {
    convertBtn.addEventListener('click', async function() {
        // Double-check credits before conversion
        if (!creditsCheckPassed) {
            showStatus('Insufficient credits. Minimum 30 credits required. Please purchase credits to continue.', 'error');
            return;
        }
        
        if (!window.premiumPdfBlob) {
            showStatus('Please select a PDF file first.', 'error');
            return;
        }
    
    convertBtn.disabled = true;
    cancelBtn.style.display = 'inline-flex';
    showProgress(0);
    showStatus('Uploading PDF and processing with Premium OCR...', 'info');
    
    try {
        const API_BASE_URL = 'https://pdf-to-excel-backend-iwumaktavq-uc.a.run.app';
        
        // Get user ID - prefer Firebase auth
        let userId = 'anonymous';
        let userType = null; // Don't default to 'free' - let backend handle
        
        // First try Firebase auth (most reliable)
        if (window.auth && window.auth.currentUser) {
            userId = window.auth.currentUser.uid;
        } else if (window.auth) {
            // Wait for auth state if auth is ready but user not loaded yet
            const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js");
            await new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                    unsubscribe();
                    if (user && user.uid) {
                        userId = user.uid;
                    }
                    resolve();
                });
                setTimeout(() => {
                    unsubscribe();
                    resolve();
                }, 1000);
            });
        }
        
        // Fallback to PDFExcelUserType if Firebase auth didn't provide user ID
        if (userId === 'anonymous' && window.PDFExcelUserType) {
            userId = await window.PDFExcelUserType.getUserId();
            userType = window.PDFExcelUserType.getUserType();
        }
        
        // Create FormData
        const fd = new FormData();
        const pdfFile = new File([window.premiumPdfBlob], window.premiumPdfFilename || 'document.pdf', { type: 'application/pdf' });
        fd.append('file', pdfFile);
        
        showProgress(30);
        
        // Build headers - only send X-User-Type if explicitly 'premium'
        // Don't send 'free' as it will block the request
        const headers = {
            'X-User-ID': userId
        };
        if (userType === 'premium') {
            headers['X-User-Type'] = 'premium';
        }
        // If userType is null or 'free', don't send header - backend will check credits instead
        
        // Call premium endpoint
        const response = await fetch(`${API_BASE_URL}/api/pdf-to-excel-docai`, {
            method: 'POST',
            headers: headers,
            body: fd
        });
        
        showProgress(70);
        
        const result = await response.json();
        
        if (result.insufficient_credits) {
            showStatus(`Insufficient credits. You need ${result.required} credits but only have ${result.available}. Please purchase credits.`, 'error');
            convertBtn.disabled = false;
            cancelBtn.style.display = 'none';
            hideProgress();
            return;
        }
        
        if (!response.ok || (result.status !== 'success' && !result.success)) {
            throw new Error(result.error || result.detail || result.message || 'Conversion failed');
        }
        
        showProgress(100);
        showStatus(`Success! Converted ${result.pagesProcessed || result.pagesConverted || 0} pages. Credits left: ${result.creditsLeft || 0}`, 'success');
        
        // Download Excel file
        setTimeout(() => {
            window.location.href = result.downloadUrl;
        }, 1000);
        
    } catch (error) {
        console.error('Premium conversion error:', error);
        showStatus('Conversion failed: ' + error.message, 'error');
        convertBtn.disabled = false;
        cancelBtn.style.display = 'none';
        hideProgress();
    }
    });
}

// Cancel button handler (already defined in initializeUploadHandlers, but adding here for safety)
if (typeof cancelBtn !== 'undefined' && cancelBtn) {
    cancelBtn.addEventListener('click', () => {
        window.premiumPdfBlob = null;
        window.premiumPdfFilename = null;
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) fileInfo.classList.remove('show');
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';
        const convertBtn = document.getElementById('convertBtn');
        if (convertBtn) convertBtn.disabled = true;
        cancelBtn.style.display = 'none';
        hideProgress();
        showStatus('', '');
    });
}

// Helper functions
function showStatus(message, type) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = 'status-message ' + type;
    statusEl.style.display = 'block';
}

function showProgress(percent) {
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.style.display = 'block';
    progressFill.style.width = percent + '%';
}

function hideProgress() {
    document.getElementById('progressBar').style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}
</script>

<script src="js/pdf-excel-user-type.js"></script>
</body>
</html>

