<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Background Style | easyjpgtopdf</title>
<link href="css/footer.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --dark: #1a214d;
      --muted: #6f7694;
      --surface: #ffffff;
      --border: rgba(20, 28, 72, 0.12);
      --chip-bg: rgba(67, 97, 238, 0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(180deg, #f3f4ff 0%, #f8f9ff 100%); color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; }
    header { background: var(--surface); box-shadow: 0 12px 30px rgba(14, 32, 86, 0.08); position: sticky; top: 0; z-index: 40; }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: 700; color: var(--primary); text-decoration: none; }
    .logo i { color: var(--secondary); }
    .nav-links { display: flex; gap: 18px; align-items: center; flex-wrap: nowrap; }
    .nav-links > a,
    .dropdown-toggle { display: inline-flex; align-items: center; gap: 6px; color: var(--dark); font-weight: 500; text-decoration: none; font-size: 0.95rem; padding: 8px 0; }
    .nav-links > a:hover,
    .nav-links > a.active,
    .dropdown > a:hover { color: var(--primary); }
    .dropdown { position: relative; }
    .dropdown-toggle::after { content: '\f107'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 0.75rem; }
    .dropdown-content { display: none; position: absolute; background: #fff; min-width: 220px; border-radius: 12px; box-shadow: 0 16px 40px rgba(14, 32, 86, 0.12); top: calc(100% + 8px); left: 0; padding: 12px 0; z-index: 30; }
    .dropdown-content a { display: block; padding: 10px 20px; color: var(--dark); white-space: nowrap; }
    .dropdown-content a:hover { background: rgba(67, 97, 238, 0.08); }
    .dropdown:hover .dropdown-content { display: block; }
    .btn-outline { background: transparent; border: 1px solid rgba(67, 97, 238, 0.35); color: var(--primary); }
    .btn-outline:hover { background: rgba(67, 97, 238, 0.08); }
    .auth-buttons { display: flex; gap: 10px; align-items: center; }
    .topbar { max-width: 1200px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .topbar h1 { font-size: 1.6rem; color: #131a48; }
    .breadcrumbs { display: flex; gap: 8px; align-items: center; font-size: 0.95rem; color: var(--muted); }
    .breadcrumbs a { color: var(--primary); text-decoration: none; }
    .stage { flex: 1; width: 100%; max-width: 1200px; margin: 36px auto; padding: 0 24px 60px; display: grid; grid-template-columns: minmax(320px, 1fr) minmax(360px, 420px); gap: 28px; align-items: start; }
    .panel { background: var(--surface); border-radius: 24px; padding: 28px; box-shadow: 0 22px 45px rgba(16, 30, 70, 0.08); border: 1px solid var(--border); }
    .panel h2 { font-size: 1.25rem; margin-bottom: 18px; color: #121a4c; display: flex; align-items: center; gap: 10px; }
    .preview-frame { border-radius: 20px; width: 8.6cm; height: 8.6cm; max-width: 100%; max-height: 100%; overflow: hidden; position: relative; background: #f1f1ff; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
    .preview-frame canvas { width: 100%; height: 100%; object-fit: contain; }
    .category-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    .tab-button { border-radius: 999px; padding: 8px 18px; border: 1px solid var(--border); background: var(--chip-bg); color: #243163; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
    .tab-button.active { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.2); }
    .tab-button:hover { transform: translateY(-1px); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(1.5cm, 1.5cm)); grid-auto-rows: 1.5cm; gap: 8px; width: 8.6cm; max-width: 100%; max-height: 8.6cm; margin: 0 auto 24px; padding-right: 6px; overflow-y: auto; justify-content: center; }
    .thumb { position: relative; width: 1.5cm; height: 1.5cm; border-radius: 10px; overflow: hidden; cursor: pointer; border: 2px solid transparent; box-shadow: 0 10px 20px rgba(18, 30, 60, 0.12); transition: transform 0.2s, border-color 0.2s; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .thumb span { position: absolute; bottom: 4px; left: 4px; right: 4px; text-align: center; background: rgba(15, 23, 42, 0.6); color: #fff; padding: 2px 4px; border-radius: 999px; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.03em; line-height: 1.2; }
    .thumb:hover { transform: translateY(-3px); }
    .thumb.selected { border-color: var(--primary); }
    .color-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 14px; }
    .color-chip { width: 100%; padding-bottom: 100%; border-radius: 16px; position: relative; cursor: pointer; border: 2px solid transparent; box-shadow: 0 12px 25px rgba(16, 32, 70, 0.08); }
    .color-chip .fill { position: absolute; inset: 0; border-radius: 14px; }
    .color-chip.selected { border-color: var(--primary); }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; border-radius: 999px; padding: 10px 22px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.25); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: #233150; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .status { font-size: 0.92rem; color: var(--muted); margin-top: 14px; min-height: 1.2rem; }
    .overlay-deck { width: 100%; max-width: 1200px; margin: 0 auto 60px; padding: 0 24px; }
    .overlay-panel { margin-top: 0; }
    .overlay-controls { background: rgba(67, 97, 238, 0.08); border: 1px solid rgba(67, 97, 238, 0.15); border-radius: 18px; padding: 16px 18px; display: flex; flex-direction: column; gap: 14px; }
    .overlay-controls header { display: flex; justify-content: space-between; align-items: center; color: #1a214d; font-weight: 600; font-size: 0.95rem; }
    .overlay-switch { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; }
    .overlay-fields { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .overlay-fields.hidden { display: none; }
    .overlay-fields label { display: flex; flex-direction: column; gap: 6px; font-size: 0.85rem; color: var(--muted); font-weight: 600; }
    .overlay-fields textarea { border: 1px solid rgba(20, 28, 72, 0.16); border-radius: 12px; padding: 10px 14px; font-size: 0.95rem; color: #1f2559; background: #fff; min-height: 90px; resize: vertical; }
    .overlay-fields input[type="color"] { width: 100%; height: 44px; border: 1px solid rgba(20, 28, 72, 0.16); border-radius: 12px; padding: 6px; background: #fff; }
    .overlay-fields select, .overlay-fields input[type="range"] { appearance: none; border: 1px solid rgba(20,28,72,0.16); border-radius: 12px; padding: 8px 12px; font-size: 0.95rem; color: #1f2559; background: #fff; }
    .overlay-fields input:disabled, .overlay-fields select:disabled { opacity: 0.5; cursor: not-allowed; }
    .overlay-range-value { font-weight: 600; color: #1f2559; font-size: 0.9rem; }
    .overlay-manual { display: flex; flex-direction: column; gap: 6px; }
    /* Download Modal Styles */
    .download-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 1000; align-items: center; justify-content: center; }
    .download-modal.active { display: flex; }
    .download-modal-content { background: #fff; border-radius: 20px; padding: 32px; max-width: 480px; width: 90%; box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3); }
    .download-modal-header { margin-bottom: 24px; }
    .download-modal-header h3 { font-size: 1.4rem; color: #1a214d; margin-bottom: 8px; }
    .download-modal-header p { color: var(--muted); font-size: 0.95rem; }
    .download-options { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .download-option { border: 2px solid var(--border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; background: #fff; }
    .download-option:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15); }
    .download-option.disabled { opacity: 0.6; cursor: not-allowed; background: #f5f5f5; }
    .download-option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .download-option-title { font-weight: 700; font-size: 1.1rem; color: #1a214d; }
    .download-option-badge { padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .download-option-badge.free { background: rgba(34, 197, 94, 0.15); color: #059669; }
    .download-option-badge.premium { background: rgba(67, 97, 238, 0.15); color: var(--primary); }
    .download-option-details { color: var(--muted); font-size: 0.9rem; line-height: 1.6; }
    .download-option-details strong { color: #1a214d; }
    .download-modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .download-modal-actions button { padding: 10px 20px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s; }
    .download-modal-actions button:hover { transform: translateY(-1px); }
    .download-modal-actions .btn-cancel { background: #f5f5f5; color: #666; }
    footer { background: #0d1530; color: #e8ecff; padding: 50px 0 30px; margin-top: auto; }
    .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 30px; margin-bottom: 30px; }
    .footer-grid h3 { margin-bottom: 12px; font-size: 1rem; }
    .footer-links { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .footer-links a { color: rgba(232, 236, 255, 0.75); text-decoration: none; font-size: 0.95rem; }
    .footer-links a:hover { color: #fff; }
    .footer-links i { margin-right: 6px; }
    .copyright { text-align: center; border-top: 1px solid rgba(232, 236, 255, 0.16); padding-top: 20px; font-size: 0.85rem; color: rgba(232,236,255,0.6); }
    @media (max-width: 980px) {
      .stage { grid-template-columns: 1fr; }
    }
  </style>
<link href="css/header.css" rel="stylesheet"/>
<link href="css/theme-modern.css" rel="stylesheet"/>
</head>
<body>
<header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo"><img src="images/logo.png" alt="Logo" style="height:54px;"></a>
                <div class="nav-links">
                    <div class="dropdown">
                        <a href="#">Convert to PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="jpg-to-pdf.html">JPG to PDF</a>
                            <a href="word-to-pdf.html">Word to PDF</a>
                            <a href="excel-to-pdf.html">Excel to PDF</a>
                            <a href="ppt-to-pdf.html">PowerPoint to PDF</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Convert from PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pdf-to-jpg.html">PDF to JPG</a>
                            <a href="pdf-to-word.html">PDF to Word</a>
                            <a href="pdf-to-excel.html">PDF to Excel</a>
                            <a href="pdf-to-ppt.html">PDF to PowerPoint</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Pdf Editor <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="merge-pdf.html">Merge PDF</a>
                            <a href="split-pdf.html">Split PDF</a>
                            <a href="compress-pdf.html">Compress PDF</a>
                            <a href="edit-pdf.html">Pdf Editor</a>
                            <a href="protect-pdf.html">Protect PDF</a>
                            <a href="unlock-pdf.html">Unlock PDF</a>
                            <a href="watermark-pdf.html">Watermark PDF</a>
                            <a href="crop-pdf.html">Crop PDF</a>
                            <a href="add-page-numbers.html">Add Page Numbers</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Image Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="image-repair.html">AI Image Repair</a>
                            <a href="image-compressor.html">Image Compressor</a>
                            <a href="image-resizer.html">Image Resizer</a>
                            <a href="image-editor.html">Image Editor</a>
                            <a href="background-remover.html">Image Background Remover</a>
                            <a href="ocr-image.html">OCR Image</a>
                            <a href="image-watermark.html">Image Watermark Tool</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Other Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="resume-maker.html">Resume Maker</a>
                            <a href="biodata-maker.html">Marrige Biodata-Data Maker</a>
                            <a href="ai-image-generator.html">AI Image Generator</a>
                            <a href="marriage-card.html">Marriage Card</a>
                            <a href="excel-unlocker/" target="_blank">Excel Unlocker</a>
                            <a href="protect-excel.html">Protect Excel Sheet</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">More <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pricing.html">Pricing</a>
                            <a href="blog.html">Blog/Articles</a>
                            <a href="https://apnaonlineservic.com" target="_blank">Shop-ApnaOnline</a>
                            <a href="https://aimathmaster.com" target="_blank">AI-Math Master</a>
                        </div>
                    </div>
                </div>
                <div class="auth-buttons">
                    <a href="login.html" class="auth-link">Sign In</a>
                    <a href="signup.html" class="auth-btn"><i class="fas fa-user-plus" aria-hidden="true"></i><span>Signup</span></a>
                </div>
                <div id="user-menu" class="user-menu" data-open="false">
                    <button id="user-menu-toggle" class="user-menu-toggle" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Account menu">
                        <span class="user-initial" aria-hidden="true">U</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown" hidden>
                        <a href="dashboard.html#dashboard-overview" data-user-nav="dashboard-overview"><i class="fas fa-user-circle"></i> Account Dashboard</a>
                        <a href="dashboard.html#dashboard-billing" data-user-nav="dashboard-billing"><i class="fas fa-file-invoice"></i> Billing Details</a>
                        <a href="dashboard.html#dashboard-payments" data-user-nav="dashboard-payments"><i class="fas fa-wallet"></i> Payment History</a>
                        <a href="dashboard.html#dashboard-orders" data-user-nav="dashboard-orders"><i class="fas fa-clipboard-list"></i> Orders &amp; Subscriptions</a>
                        <a href="accounts.html#login"><i class="fas fa-user-cog"></i> Account Center</a>
                        <button type="button" id="logout-button" class="dropdown-logout"><i class="fas fa-sign-out-alt"></i> Sign out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
<main class="stage">
<section class="panel">
<h2><i class="fas fa-eye"></i> Live Preview</h2>
<div class="preview-frame">
<canvas id="previewCanvas"></canvas>
</div>
<div class="status" id="status"></div>
<div class="actions">
<button class="btn btn-outline" id="backToPreview"><i class="fas fa-arrow-left"></i> Back to Workspace</button>
<button class="btn btn-outline" disabled="" id="resetBackground"><i class="fas fa-undo"></i> Reset</button>
<button class="btn btn-primary" disabled="" id="downloadImage"><i class="fas fa-download"></i> Download</button>
</div>
</section>
<section class="panel">
<h2><i class="fas fa-magic"></i> Pick a Background</h2>
<div class="category-tabs">
<button class="tab-button active" data-tab="magic">Magic Photos</button>
<button class="tab-button" data-tab="photos">Cityscapes</button>
<button class="tab-button" data-tab="tech">Tech &amp; Infra</button>
<button class="tab-button" data-tab="colors">Solid Colours</button>
<button class="tab-button" data-tab="transparent">Transparent</button>
</div>
<div class="tab-content" data-tab="magic">
<div class="grid" id="magicGrid"></div>
</div>
<div class="tab-content" data-tab="photos" hidden="">
<div class="grid" id="photoGrid"></div>
</div>
<div class="tab-content" data-tab="tech" hidden="">
<div class="grid" id="techGrid"></div>
</div>
<div class="tab-content" data-tab="colors" hidden="">
<div class="color-grid" id="colorGrid"></div>
</div>
<div class="tab-content" data-tab="transparent" hidden="">
<p style="color:var(--muted);">Set background to transparent and download instantly.</p>
</div>
</section>
</main>
<div class="overlay-deck">
<section class="panel overlay-panel">
<div class="overlay-controls">

<div class="overlay-fields hidden" id="overlayFields">
<label>
            Text (multiline supported)
            <textarea id="overlayText" placeholder="Enter caption"></textarea>
</label>
<label>
            Font Family
            <select id="overlayFont">
<option value="'Segoe UI', sans-serif">Segoe UI</option>
<option value="'Poppins', sans-serif">Poppins</option>
<option value="'Roboto', sans-serif">Roboto</option>
<option value="'Montserrat', sans-serif">Montserrat</option>
<option value="'Playfair Display', serif">Playfair Display</option>
</select>
</label>
<label>
            Font Weight
            <select id="overlayWeight">
<option value="400">Regular</option>
<option value="500">Medium</option>
<option selected="" value="600">Semi Bold</option>
<option value="700">Bold</option>
<option value="800">Extra Bold</option>
</select>
</label>
<label>
            Font Size
            <div style="display:flex;align-items:center;gap:10px;">
<input id="overlaySize" max="96" min="16" type="range" value="42"/>
<span class="overlay-range-value" id="overlaySizeValue">42px</span>
</div>
</label>
<label>
            Position
            <select id="overlayPosition">
<option value="top-left">Top Left</option>
<option value="top-right">Top Right</option>
<option selected="" value="center">Center</option>
<option value="bottom-left">Bottom Left</option>
<option value="bottom-right">Bottom Right</option>
<option value="bottom-center">Bottom Center</option>
<option value="manual">Manual (use sliders)</option>
</select>
</label>
<label class="overlay-manual hidden" id="overlayManualX">
            Horizontal Offset
            <div style="display:flex;align-items:center;gap:10px;">
<input id="overlayOffsetX" max="100" min="-100" type="range" value="0"/>
<span class="overlay-range-value" id="overlayOffsetXValue">0%</span>
</div>
</label>
<label class="overlay-manual hidden" id="overlayManualY">
            Vertical Offset
            <div style="display:flex;align-items:center;gap:10px;">
<input id="overlayOffsetY" max="100" min="-100" type="range" value="0"/>
<span class="overlay-range-value" id="overlayOffsetYValue">0%</span>
</div>
</label>
<label>
            Text Colour
            <input id="overlayColor" type="color" value="#ffffff"/>
</label>
<label>
            Shadow Strength
            <div style="display:flex;align-items:center;gap:10px;">
<input id="overlayShadow" max="30" min="0" type="range" value="12"/>
<span class="overlay-range-value" id="overlayShadowValue">12px</span>
</div>
</label>
</div>
</div>
</section>
</div>
<!-- Download Modal -->
<div id="downloadModal" class="download-modal">
  <div class="download-modal-content">
    <div class="download-modal-header">
      <h3><i class="fas fa-download"></i> Choose Download Size</h3>
      <p>Select your preferred download option</p>
    </div>
    <div class="download-options" id="downloadOptions">
      <!-- Options will be populated by JavaScript -->
    </div>
    <div class="download-modal-actions">
      <button class="btn-cancel" onclick="closeDownloadModal()">Cancel</button>
    </div>
  </div>
</div>
<script type="module">
    // Import Firebase modules (optional - works without Firebase for file:// protocol)
    let auth = null;
    let db = null;
    let getDoc = null;
    let doc = null;
    let onAuthStateChanged = null;
    
    // Try to load Firebase, but don't fail if file:// protocol
    const isLocalFile = window.location.protocol === 'file:';
    
    if (!isLocalFile) {
      try {
        const firebaseInit = await import('./js/firebase-init.js');
        const firestore = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
        
        auth = firebaseInit.auth;
        db = firebaseInit.db;
        getDoc = firestore.getDoc;
        doc = firestore.doc;
        onAuthStateChanged = firebaseAuth.onAuthStateChanged;
        
        console.log('? Firebase loaded successfully');
      } catch (error) {
        console.warn('?? Firebase not available (file:// protocol or network issue):', error.message);
      }
    } else {
      console.log('?? Running on file:// protocol - Firebase disabled (download will work without auth)');
    }

    const STORAGE_KEYS = {
      original: 'bgRemover:original',
      foreground: 'bgRemover:foreground',
      filename: 'bgRemover:filename',
      dimensions: 'bgRemover:dimensions'
    };

    // Limits - Same as background-workspace.html
    const FREE_UPLOAD_LIMIT = 10 * 1024 * 1024; // 10 MB - Free upload limit
    const FREE_DOWNLOAD_LIMIT = 500 * 1024; // 500 KB - Free download limit
    const FREE_PREVIEW_LIMIT = 100 * 1024; // 100 KB - Free preview without compression
    const FREE_PREVIEW_MAX = 400 * 1024; // 400 KB - Max preview size for free users

    let currentUser = null;
    let userSubscription = null;

    // Check user subscription status (only if Firebase available)
    async function checkUserSubscription(user) {
      if (!user || !auth || !db || !doc || !getDoc) return null;
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists()) {
          const data = userDoc.data();
          const plan = data.plan || 'free';
          const subscriptionEnd = data.subscriptionEnd || null;
          const isPremium = plan === 'premium' || plan === 'pro';
          
          // Check if subscription is valid (not expired)
          let isValid = false;
          if (isPremium && subscriptionEnd) {
            const endDate = new Date(subscriptionEnd);
            const now = new Date();
            isValid = endDate > now;
          }
          
          return {
            plan: plan,
            isPremium: isPremium,
            isValid: isValid,
            subscriptionEnd: subscriptionEnd
          };
        }
      } catch (error) {
        console.error('Error checking subscription:', error);
      }
      return null;
    }

    // Monitor auth state (only if Firebase available)
    if (auth && onAuthStateChanged) {
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          userSubscription = await checkUserSubscription(user);
        } else {
          userSubscription = null;
        }
      });
    } else {
      console.log('?? Running without authentication - all features available');
    }

    const fallbackBackgrounds = {
      magic: [
        { label: 'Aurora Night', url: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Mountain Sunrise', url: 'https://images.unsplash.com/photo-1500534623283-312aade485b7?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Golden Forest', url: 'https://images.unsplash.com/photo-1470770903676-69b98201ea1c?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Desert Dream', url: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Lavender Field', url: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80&sat=-20' },
        { label: 'Sea Mist', url: 'https://images.unsplash.com/photo-1474871256005-c5f7eb1d77f1?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Canyon Glow', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Foggy Pines', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Snow Valley', url: 'https://images.unsplash.com/photo-1508261305430-1e1c5237c11f?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Moody Lake', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Cherry Blossoms', url: 'https://images.unsplash.com/photo-1494475673543-6a6a27143b22?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Palm Horizon', url: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Beach Sunset', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Autumn Path', url: 'https://images.unsplash.com/photo-1476041800959-2f6bb412c8ce?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Starry Ridge', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&sat=-30' },
        { label: 'Emerald Hills', url: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'River Glow', url: 'https://images.unsplash.com/photo-1477414348463-c0eb7f1359b6?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Purple Mountains', url: 'https://images.unsplash.com/photo-1500534625967-5b1fd4700f39?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Rolling Clouds', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&sat=-50' },
        { label: 'Glacier Lagoon', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&hue=190' },
        { label: 'Tropical Blush', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&sat=-10' },
        { label: 'Winter Sunrise', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&hue=0' }
      ],
      photos: [
        { label: 'New York Skyline', url: 'https://images.unsplash.com/photo-1534447677768-be436bb09401?auto=format&fit=crop&w=1600&q=80' },
        { label: 'London Bridge', url: 'https://images.unsplash.com/photo-1498887960847-2a25ef84c54b?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Paris Eiffel', url: 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Tokyo Lights', url: 'https://images.unsplash.com/photo-1549693578-d683be217e58?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Dubai Skyline', url: 'https://images.unsplash.com/photo-1533104816931-20fa691ff6ca?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Singapore Marina', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Sydney Opera', url: 'https://images.unsplash.com/photo-1506976785307-8732e854ad89?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Hong Kong', url: 'https://images.unsplash.com/photo-1505767641034-1b3f0a7ab1d2?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Barcelona Streets', url: 'https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1600&q=80' },
        { label: 'San Francisco', url: 'https://images.unsplash.com/photo-1465446751832-9c63a0470b97?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Seoul Skyline', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-20' },
        { label: 'Shanghai Tower', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&hue=210' },
        { label: 'Amsterdam Canals', url: 'https://images.unsplash.com/photo-1444676632488-26a136c45b9b?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Rome Sunrise', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-60' },
        { label: 'Los Angeles', url: 'https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1600&q=80&hue=15' },
        { label: 'Rio de Janeiro', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&hue=5' },
        { label: 'Berlin Lights', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&sat=-10' },
        { label: 'Istanbul', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&hue=30' },
        { label: 'Cape Town', url: 'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Moscow', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&hue=340' },
        { label: 'Vancouver', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&sat=-80' },
        { label: 'Mumbai', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-30' }
      ],
      tech: [
        { label: 'Data Center', url: 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Neon Grid', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Modern Office', url: 'https://images.unsplash.com/photo-1498050108023-c5249f4df085?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Blue Circuit', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80&sat=-60' },
        { label: 'Server Aisle', url: 'https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Drone City', url: 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Futuristic Lobby', url: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80&hue=200' },
        { label: 'Cyber Lines', url: 'https://images.unsplash.com/photo-1535223289827-42f1e9919769?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Innovation Hub', url: 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1600&q=80&sat=-30' },
        { label: 'Neon Tunnel', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&hue=280' },
        { label: 'VR Experience', url: 'https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1600&q=80&sat=-40' },
        { label: 'Innovation Lab', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&sat=-20' },
        { label: 'Neon Bridge', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&sat=-20' },
        { label: 'Tech Expo', url: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80&hue=300' },
        { label: 'Smart City', url: 'https://images.unsplash.com/photo-1535223289827-42f1e9919769?auto=format&fit=crop&w=1600&q=80&sat=-45' },
        { label: 'AI Circuit', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-70' },
        { label: 'Digital Wave', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80&hue=220' },
        { label: 'Tech Vibes', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80&hue=340' },
        { label: 'Quantum Lab', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-15' },
        { label: 'Hologram Hall', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80&hue=180' },
        { label: 'Innovation Bridge', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&sat=-5' },
        { label: 'Satellite View', url: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1600&q=80&sat=-70' },
        { label: 'IoT Hub', url: 'https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=1600&q=80' },
        { label: 'Digital Aurora', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80&sat=-5' },
        { label: 'Smart Grid', url: 'https://images.unsplash.com/photo-1526481280695-3c469928b67b?auto=format&fit=crop&w=1600&q=80&hue=250' }
      ]
    };

    const colorPalette = [
      { label: 'Transparent', value: 'transparent' },
      { label: 'Pure White', value: '#ffffff' },
      { label: 'Charcoal', value: '#111827' },
      { label: 'Sky Blue', value: '#bfdbfe' },
      { label: 'Sunset', value: '#fb7185' },
      { label: 'Mint', value: '#bbf7d0' },
      { label: 'Lavender', value: '#c4b5fd' },
      { label: 'Peach', value: '#fed7aa' },
      { label: 'Slate', value: '#475569' },
      { label: 'Golden', value: '#facc15' },
      { label: 'Emerald', value: '#34d399' }
    ];

    const previewCanvas = document.getElementById('previewCanvas');
    const statusEl = document.getElementById('status');
    const resetBtn = document.getElementById('resetBackground');
    const downloadBtn = document.getElementById('downloadImage');
    const backToPreview = document.getElementById('backToPreview');

    let previewContext = previewCanvas.getContext('2d');
    let originalDataUrl = sessionStorage.getItem(STORAGE_KEYS.original);
    let foregroundDataUrl = sessionStorage.getItem(STORAGE_KEYS.foreground);
    let dimensions = sessionStorage.getItem(STORAGE_KEYS.dimensions);

    if (!originalDataUrl || !foregroundDataUrl || !dimensions) {
      statusEl.textContent = 'Missing image data. Please upload again.';
      resetBtn.disabled = true;
      downloadBtn.disabled = true;
    }

    if (dimensions) {
      const { width, height } = JSON.parse(dimensions);
      previewCanvas.width = width;
      previewCanvas.height = height;
    }

    const backgroundImage = new Image();
    const foregroundImage = new Image();
    const overlayToggle = document.getElementById('overlayToggle');
    const overlayFields = document.getElementById('overlayFields');
    const overlayTextInput = document.getElementById('overlayText');
    const overlayFontSelect = document.getElementById('overlayFont');
    const overlayWeightSelect = document.getElementById('overlayWeight');
    const overlaySizeRange = document.getElementById('overlaySize');
    const overlaySizeValue = document.getElementById('overlaySizeValue');
    const overlayPositionSelect = document.getElementById('overlayPosition');
    const overlayColorInput = document.getElementById('overlayColor');
    const overlayShadowRange = document.getElementById('overlayShadow');
    const overlayShadowValue = document.getElementById('overlayShadowValue');
    const overlayOffsetX = document.getElementById('overlayOffsetX');
    const overlayOffsetY = document.getElementById('overlayOffsetY');
    const overlayOffsetXValue = document.getElementById('overlayOffsetXValue');
    const overlayOffsetYValue = document.getElementById('overlayOffsetYValue');
    const overlayManualX = document.getElementById('overlayManualX');
    const overlayManualY = document.getElementById('overlayManualY');
    const overlayState = {
      enabled: false,
      text: '',
      fontFamily: "'Segoe UI', sans-serif",
      fontWeight: 600,
      fontSize: 42,
      position: 'center',
      color: '#ffffff',
      shadow: 12,
      offsetX: 0,
      offsetY: 0
    };

    function clearStatus() {
      statusEl.textContent = '';
    }

    function setStatus(message) {
      statusEl.textContent = message;
    }

    async function loadImage(image, src) {
      return new Promise((resolve, reject) => {
        image.crossOrigin = 'anonymous';
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = src;
      });
    }

    // Compress image to reduce size (for free users) - UPDATED to match background-workspace.html
    async function compressImageForFree(dataURL, targetSizeKB = 500) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          const originalSize = Math.ceil((dataURL.split(',')[1].length * 0.75) / 1024);
          
          // If already under limit, return as is
          if (originalSize <= targetSizeKB) {
            resolve({ dataURL, width, height, size: originalSize * 1024 });
            return;
          }
          
          // Calculate scale to reduce size
          const scale = Math.sqrt(targetSizeKB / originalSize) * 0.9; // 90% to be safe
          width = Math.round(width * scale);
          height = Math.round(height * scale);
          
          // Ensure minimum dimensions
          if (width < 200) width = 200;
          if (height < 200) height = 200;
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // High quality resize
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to PNG with compression
          let compressedDataURL = canvas.toDataURL('image/png', 0.92);
          let compressedSize = Math.ceil((compressedDataURL.split(',')[1].length * 0.75) / 1024);
          
          // If still too large, reduce quality further
          if (compressedSize > targetSizeKB) {
            const quality = (targetSizeKB / compressedSize) * 0.9;
            compressedDataURL = canvas.toDataURL('image/png', Math.max(0.7, quality));
            compressedSize = Math.ceil((compressedDataURL.split(',')[1].length * 0.75) / 1024);
          }
          
          resolve({
            dataURL: compressedDataURL,
            width: width,
            height: height,
            size: compressedSize * 1024,
            compressed: true,
            originalSize: originalSize * 1024
          });
        };
        img.src = dataURL;
      });
    }
    
    // Compress preview for faster background styling (free users) - Same as background-workspace.html
    async function compressPreviewForRemoval(dataURL) {
      const originalSize = Math.ceil((dataURL.split(',')[1].length * 0.75));
      const originalSizeKB = originalSize / 1024;
      
      console.log('?? Original size:', originalSizeKB.toFixed(0), 'KB');
      
      // If under 100 KB, use as is
      if (originalSize <= FREE_PREVIEW_LIMIT) {
        console.log('? Using original size (under 100 KB)');
        return { dataURL, compressed: false, originalSize };
      }
      
      // Compress to 400 KB for faster editing
      console.log('?? Compressing preview to 400 KB for faster editing...');
      const compressed = await compressImageForFree(dataURL, 400);
      console.log('? Preview compressed to:', (compressed.size / 1024).toFixed(0), 'KB');
      
      return {
        dataURL: compressed.dataURL,
        compressed: true,
        originalSize: originalSize,
        compressedSize: compressed.size
      };
    }

    // Get image dimensions and size info - Same as background-workspace.html
    function getImageInfo(dataURL) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const base64Data = dataURL.split(',')[1];
          const size = Math.ceil(base64Data.length * 0.75);
          resolve({
            width: img.width,
            height: img.height,
            size: size,
            sizeMB: (size / (1024 * 1024)).toFixed(2),
            sizeKB: (size / 1024).toFixed(0)
          });
        };
        img.src = dataURL;
      });
    }

    function applyOverlay() {
      if (!overlayState.enabled || !overlayState.text.trim()) return;
      const ctx = previewContext;
      ctx.save();
      ctx.font = `${overlayState.fontWeight} ${overlayState.fontSize}px ${overlayState.fontFamily}`;
      ctx.fillStyle = overlayState.color;
      const lines = overlayState.text.split(/\n/).map((line) => line.trimEnd());
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const shadow = overlayState.shadow;
      ctx.shadowColor = shadow > 0 ? 'rgba(0,0,0,0.45)' : 'transparent';
      ctx.shadowBlur = shadow;
      const padding = overlayState.fontSize * 0.6;
      let x = previewCanvas.width / 2;
      let y = previewCanvas.height / 2;
      if (overlayState.position === 'top-left') {
        ctx.textAlign = 'left';
        x = padding;
        y = padding;
      } else if (overlayState.position === 'top-right') {
        ctx.textAlign = 'right';
        x = previewCanvas.width - padding;
        y = padding;
      } else if (overlayState.position === 'bottom-left') {
        ctx.textAlign = 'left';
        x = padding;
        y = previewCanvas.height - padding;
      } else if (overlayState.position === 'bottom-right') {
        ctx.textAlign = 'right';
        x = previewCanvas.width - padding;
        y = previewCanvas.height - padding;
      } else if (overlayState.position === 'bottom-center') {
        ctx.textAlign = 'center';
        x = previewCanvas.width / 2;
        y = previewCanvas.height - padding;
      } else if (overlayState.position === 'manual') {
        ctx.textAlign = 'center';
        x = previewCanvas.width / 2 + (overlayState.offsetX / 100) * (previewCanvas.width / 2);
        y = previewCanvas.height / 2 + (overlayState.offsetY / 100) * (previewCanvas.height / 2);
      }
      const lineHeight = overlayState.fontSize * 1.2;
      const startY = y - ((lines.length - 1) / 2) * lineHeight;
      lines.forEach((line, index) => {
        ctx.fillText(line, x, startY + index * lineHeight);
      });
      ctx.restore();
    }

    async function drawComposite(background) {
      if (!foregroundDataUrl) return;
      clearStatus();
      if (typeof background !== 'undefined') {
        currentBackgroundRef = background;
      }
      previewContext.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

      if (background === 'transparent') {
        // draw checkerboard pattern
        const size = 40;
        for (let y = 0; y < previewCanvas.height; y += size) {
          for (let x = 0; x < previewCanvas.width; x += size) {
            previewContext.fillStyle = ((x / size + y / size) % 2 === 0) ? '#f1f5f9' : '#e2e8f0';
            previewContext.fillRect(x, y, size, size);
          }
        }
      } else if (typeof background === 'string') {
        previewContext.fillStyle = background;
        previewContext.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
      } else if (background instanceof HTMLImageElement) {
        previewContext.drawImage(background, 0, 0, previewCanvas.width, previewCanvas.height);
      }

      previewContext.drawImage(foregroundImage, 0, 0, previewCanvas.width, previewCanvas.height);
      applyOverlay();
      downloadBtn.disabled = false;
      resetBtn.disabled = false;
    }

    async function init() {
      if (!foregroundDataUrl || !dimensions) {
        console.error('Missing data:', { foregroundDataUrl: !!foregroundDataUrl, dimensions: !!dimensions });
        setStatus('Missing image data. Please go back and process the image again.');
        return;
      }
      try {
        // Check if user is premium
        let isPremium = false;
        if (auth && currentUser) {
          if (!userSubscription) {
            userSubscription = await checkUserSubscription(currentUser);
          }
          isPremium = userSubscription && 
                     (userSubscription.plan === 'premium' || userSubscription.plan === 'pro') && 
                     userSubscription.isValid;
        }
        
        // For free users, compress preview for faster background styling
        let previewUrl = foregroundDataUrl;
        if (!isPremium && foregroundDataUrl) {
          try {
            const previewData = await compressPreviewForRemoval(foregroundDataUrl);
            if (previewData.compressed) {
              previewUrl = previewData.dataURL;
              setStatus('Preview optimized for faster editing (400 KB). Original quality saved for download.');
              setTimeout(() => {
                setStatus('Background set to transparent. Choose a new style.');
              }, 3000);
            }
          } catch (compressErr) {
            console.warn('Compression failed, using original:', compressErr);
            previewUrl = foregroundDataUrl;
          }
        }
        
        if (previewUrl) {
          await loadImage(foregroundImage, previewUrl);
          await drawComposite('transparent');
          if (isPremium || !previewUrl || previewUrl === foregroundDataUrl) {
            setStatus('Background set to transparent. Choose a new style.');
          }
        } else {
          throw new Error('No preview URL available');
        }
      } catch (err) {
        console.error('Failed to load foreground', err);
        setStatus('Failed to load the removed background. Please go back to workspace and process again.');
      }
    }

    function renderGrid(containerId, items) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.src = item.url;
        img.alt = item.label;
        const label = document.createElement('span');
        label.textContent = item.label;
        div.appendChild(img);
        div.appendChild(label);
        div.addEventListener('click', async () => {
          setStatus('Applying backgroundâ¦');
          try {
            await loadImage(backgroundImage, item.url + '&auto=compress&fit=crop&w=1200&q=80');
            document.querySelectorAll('.thumb').forEach((el) => el.classList.remove('selected'));
            div.classList.add('selected');
            await drawComposite(backgroundImage);
            setStatus(`Background set to ${item.label}.`);
          } catch (err) {
            console.error('Background load failed', err);
            setStatus('Unable to load that background. Please try another.');
          }
        });
        container.appendChild(div);
      });
    }

    function renderColours() {
      const container = document.getElementById('colorGrid');
      container.innerHTML = '';
      colorPalette.forEach((entry) => {
        if (entry.value === 'transparent') return; // handled in transparent tab
        const chip = document.createElement('div');
        chip.className = 'color-chip';
        const fill = document.createElement('div');
        fill.className = 'fill';
        fill.style.background = entry.value;
        chip.appendChild(fill);
        chip.addEventListener('click', () => {
          document.querySelectorAll('.color-chip').forEach((el) => el.classList.remove('selected'));
          chip.classList.add('selected');
          drawComposite(entry.value);
          setStatus(`Background colour set to ${entry.label}.`);
        });
        container.appendChild(chip);
      });
    }

    document.querySelectorAll('.tab-button').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach((panel) => {
          panel.hidden = panel.dataset.tab !== btn.dataset.tab;
        });
        if (btn.dataset.tab === 'transparent') {
          drawComposite('transparent');
          setStatus('Background set to transparent.');
        }
      });
    });

    resetBtn.addEventListener('click', () => {
      document.querySelectorAll('.thumb').forEach((el) => el.classList.remove('selected'));
      document.querySelectorAll('.color-chip').forEach((el) => el.classList.remove('selected'));
      drawComposite('transparent');
      setStatus('Reset to transparent background.');
      if (overlayToggle.checked) {
        overlayToggle.checked = false;
        overlayFields.classList.add('hidden');
        Object.assign(overlayState, { enabled: false, text: '' });
        overlayTextInput.value = '';
      }
    });

    // Modal functions
    function showDownloadModal() {
      const modal = document.getElementById('downloadModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    function closeDownloadModal() {
      const modal = document.getElementById('downloadModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Expose closeDownloadModal globally for onclick handler
    window.closeDownloadModal = closeDownloadModal;

    // Close modal on background click
    const downloadModal = document.getElementById('downloadModal');
    if (downloadModal) {
      downloadModal.addEventListener('click', (e) => {
        if (e.target === downloadModal) {
          closeDownloadModal();
        }
      });
    }

    // Handle download with modal showing two options - UPDATED to match background-workspace.html
    async function handleDownload() {
      // Get the current canvas image as data URL
      const resultDataURL = previewCanvas.toDataURL('image/png', 1.0);
      
      // Get ORIGINAL high-quality image from storage (not preview)
      const originalResultURL = sessionStorage.getItem(STORAGE_KEYS.foreground) || resultDataURL;
      
      // Get image info from ORIGINAL quality
      const imageInfo = await getImageInfo(originalResultURL);
      const originalSize = imageInfo.size;
      const originalSizeKB = parseInt(imageInfo.sizeKB);
      
      console.log('?? Download requested');
      console.log('   Original size:', originalSizeKB, 'KB');
      console.log('   Dimensions:', imageInfo.width, 'x', imageInfo.height);
      
      // Check if user is premium (must be logged in with active Pro plan)
      let isPremium = false;
      if (auth && currentUser) {
        if (!userSubscription) {
          userSubscription = await checkUserSubscription(currentUser);
        }
        // Only active Pro plan users are premium
        isPremium = userSubscription && 
                   (userSubscription.plan === 'premium' || userSubscription.plan === 'pro') && 
                   userSubscription.isValid;
      }
      
      console.log('   User type:', isPremium ? 'Premium' : 'Free');
      
      // Calculate compressed size info (will be used for Free option)
      let compressedInfo = null;
      if (originalSizeKB > 500) {
        setStatus('?? Calculating compressed size...');
        const compressed = await compressImageForFree(originalResultURL, 500);
        compressedInfo = {
          dataURL: compressed.dataURL,
          width: compressed.width,
          height: compressed.height,
          size: compressed.size,
          sizeKB: (compressed.size / 1024).toFixed(0),
          sizeMB: (compressed.size / (1024 * 1024)).toFixed(2)
        };
        clearStatus();
      }
      
      // Build modal options
      const downloadOptions = document.getElementById('downloadOptions');
      downloadOptions.innerHTML = '';
      
      // Option 1: Compressed (Free) - Always available, under 500 KB
      const freeOption = document.createElement('div');
      freeOption.className = 'download-option';
      freeOption.innerHTML = `
        <div class="download-option-header">
          <div class="download-option-title">Compressed Size</div>
          <span class="download-option-badge free">FREE</span>
        </div>
        <div class="download-option-details">
          ${compressedInfo ? 
            `<strong>${compressedInfo.sizeKB} KB</strong> (${compressedInfo.sizeMB} MB)<br>` +
            `${compressedInfo.width} × ${compressedInfo.height} pixels<br>` +
            `<small>Auto-compressed to under 500 KB</small>` :
            `<strong>${imageInfo.sizeKB} KB</strong> (${imageInfo.sizeMB} MB)<br>` +
            `${imageInfo.width} × ${imageInfo.height} pixels<br>` +
            `<small>Already under 500 KB limit</small>`
          }
        </div>
      `;
      freeOption.addEventListener('click', async () => {
        closeDownloadModal();
        await downloadCompressed(resultDataURL, imageInfo, compressedInfo);
      });
      downloadOptions.appendChild(freeOption);
      
      // Option 2: Original/High Quality (Premium) - Only for Pro users
      const premiumOption = document.createElement('div');
      premiumOption.className = 'download-option';
      if (!isPremium) {
        premiumOption.classList.add('disabled');
      }
      premiumOption.innerHTML = `
        <div class="download-option-header">
          <div class="download-option-title">Original / High Quality</div>
          <span class="download-option-badge premium">PRO</span>
        </div>
        <div class="download-option-details">
          <strong>${imageInfo.sizeKB} KB</strong> (${imageInfo.sizeMB} MB)<br>
          ${imageInfo.width} × ${imageInfo.height} pixels<br>
          ${!isPremium ? 
            `<small style="color: #dc2626;">?? Requires active Pro/Premium plan</small>` :
            `<small style="color: #059669;">? Full quality, no compression</small>`
          }
        </div>
      `;
      premiumOption.addEventListener('click', async () => {
        if (isPremium) {
          closeDownloadModal();
          await downloadOriginal(originalResultURL, imageInfo);
        } else {
          // Show upgrade message
          const message = `Original Quality Download\n\n` +
                         `Size: ${imageInfo.sizeKB} KB (${imageInfo.sizeMB} MB)\n` +
                         `Dimensions: ${imageInfo.width} × ${imageInfo.height} pixels\n\n` +
                         `Free users: Max 500 KB (compressed)\n` +
                         `Your file: ${imageInfo.sizeKB} KB\n\n` +
                         `Upgrade to Pro/Premium for:\n` +
                         `? Unlimited download size\n` +
                         `? Original quality (no compression)\n` +
                         `? HD resolution\n` +
                         `? Faster processing`;
          
          if (!auth || !currentUser) {
            if (confirm(message + '\n\nLogin now to upgrade?')) {
              window.location.href = 'login.html';
            }
          } else {
            if (confirm(message + '\n\nView pricing plans?')) {
              window.location.href = 'pricing.html';
            }
          }
        }
      });
      downloadOptions.appendChild(premiumOption);
      
      // Show modal
      showDownloadModal();
    }

    // Download compressed version (Free) - UPDATED to match background-workspace.html
    async function downloadCompressed(resultDataURL, originalInfo, compressedInfo) {
      // Get original quality from storage
      const originalResultURL = sessionStorage.getItem(STORAGE_KEYS.foreground) || resultDataURL;
      
      let downloadDataURL = originalResultURL;
      let downloadInfo = originalInfo;
      let wasCompressed = false;
      
      // If file is > 500 KB, compress it
      if (parseInt(originalInfo.sizeKB) > 500) {
        if (compressedInfo && compressedInfo.dataURL) {
          // Use pre-calculated compressed version
          downloadDataURL = compressedInfo.dataURL;
          downloadInfo = compressedInfo;
          wasCompressed = true;
        } else {
          // Compress now
          setStatus('?? Compressing to 500 KB...');
          const compressed = await compressImageForFree(originalResultURL, 500);
          downloadDataURL = compressed.dataURL;
          downloadInfo = {
            width: compressed.width,
            height: compressed.height,
            size: compressed.size,
            sizeKB: (compressed.size / 1024).toFixed(0),
            sizeMB: (compressed.size / (1024 * 1024)).toFixed(2)
          };
          wasCompressed = true;
          clearStatus();
        }
      }
      
      // Download
      const link = document.createElement('a');
      const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-styled.png';
      const baseName = filename.replace(/\.[^/.]+$/, '') || 'background-styled';
      link.href = downloadDataURL;
      link.download = wasCompressed ? `${baseName}-free.png` : (filename.endsWith('.png') ? filename : `${baseName}.png`);
      link.click();
      
      const sizeLabel = wasCompressed ? `${downloadInfo.sizeKB} KB (compressed from ${originalInfo.sizeKB} KB)` : `${downloadInfo.sizeKB} KB`;
      setStatus(`? Downloaded ${sizeLabel} - Free tier`);
      setTimeout(() => clearStatus(), 4000);
    }

    // Download original/high quality version (Premium)
    async function downloadOriginal(resultDataURL, imageInfo) {
      // Download original version
      const link = document.createElement('a');
      const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-styled.png';
      link.href = resultDataURL;
      link.download = filename.endsWith('.png') ? filename : `${filename.replace(/\.[^/.]+$/, '') || 'background-styled'}.png`;
      link.click();
      
      setStatus(`? Downloaded (${imageInfo.sizeKB} KB, ${imageInfo.width}×${imageInfo.height}px) - Premium`);
      setTimeout(() => clearStatus(), 4000);
    }

    downloadBtn.addEventListener('click', handleDownload);

    backToPreview.addEventListener('click', () => {
      window.location.href = 'background-workspace.html';
    });

    overlayToggle.addEventListener('change', () => {
      overlayState.enabled = overlayToggle.checked;
      overlayFields.classList.toggle('hidden', !overlayState.enabled);
      if (overlayState.enabled) {
        overlayTextInput.focus();
      } else {
        overlayState.text = '';
        overlayTextInput.value = '';
      }
      drawComposite(currentBackgroundRef ?? 'transparent');
    });

    function updateOverlayAndRender() {
      overlayState.text = overlayTextInput.value;
      overlayState.fontFamily = overlayFontSelect.value;
      overlayState.fontWeight = Number(overlayWeightSelect.value);
      overlayState.fontSize = Number(overlaySizeRange.value);
      overlayState.position = overlayPositionSelect.value;
      overlayState.offsetX = Number(overlayOffsetX.value);
      overlayState.offsetY = Number(overlayOffsetY.value);
      overlayState.color = overlayColorInput.value;
      overlayState.shadow = Number(overlayShadowRange.value);
      overlaySizeValue.textContent = `${overlayState.fontSize}px`;
      overlayShadowValue.textContent = `${overlayState.shadow}px`;
      overlayOffsetXValue.textContent = `${overlayState.offsetX}%`;
      overlayOffsetYValue.textContent = `${overlayState.offsetY}%`;
      drawComposite(currentBackgroundRef ?? 'transparent');
    }

    overlayTextInput.addEventListener('input', updateOverlayAndRender);
    overlayFontSelect.addEventListener('change', updateOverlayAndRender);
    overlayWeightSelect.addEventListener('change', updateOverlayAndRender);
    overlaySizeRange.addEventListener('input', updateOverlayAndRender);
    overlayPositionSelect.addEventListener('change', updateOverlayAndRender);
    overlayOffsetX.addEventListener('input', updateOverlayAndRender);
    overlayOffsetY.addEventListener('input', updateOverlayAndRender);
    overlayColorInput.addEventListener('input', updateOverlayAndRender);
    overlayShadowRange.addEventListener('input', updateOverlayAndRender);

    let currentBackgroundRef = 'transparent';

    function toggleManualControls() {
      const isManual = overlayState.position === 'manual';
      overlayManualX.classList.toggle('hidden', !isManual);
      overlayManualY.classList.toggle('hidden', !isManual);
    }

    overlayPositionSelect.addEventListener('change', () => {
      overlayState.position = overlayPositionSelect.value;
      toggleManualControls();
    });

    overlayOffsetX.addEventListener('input', () => {
      overlayOffsetXValue.textContent = `${overlayOffsetX.value}%`;
    });
    overlayOffsetY.addEventListener('input', () => {
      overlayOffsetYValue.textContent = `${overlayOffsetY.value}%`;
    });

    toggleManualControls();

    renderGrid('magicGrid', fallbackBackgrounds.magic);
    renderGrid('photoGrid', fallbackBackgrounds.photos);
    renderGrid('techGrid', fallbackBackgrounds.tech);
    renderColours();
    init();

  const footerYearEl = document.getElementById('footerYear');
  if (footerYearEl) footerYearEl.textContent = new Date().getFullYear();
  </script>
    
<script src="js/auth.js" type="module">

    <footer>
        <div class="container footer-inner">
            <div class="footer-company-links">
                <span>Company</span>
                <a href="index.html#about">About Us</a>
                <a href="index.html#contact">Contact</a>
                <a href="pricing.html">Pricing</a>
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="terms-of-service.html">Terms of Service</a>
                <a href="dmca-en.html">DMCA</a>
                <a href="blog.html">Blog</a>
            </div>
            <p class="footer-brand-line">&copy; easyjpgtopdf &mdash; Free PDF &amp; Image Tools for everyone. All rights reserved.</p>
            <p class="footer-credits">
                Thanks to Font Awesome, Google Fonts, jsPDF, pdf.js, pdf-lib, Mammoth, Tesseract.js, IMG.LY, Firebase, Unsplash photographers, and every open-source contributor powering this site.
                <a href="attributions.html">See full acknowledgements</a>.
            </p>
        </div>
    </footer>
</body>
</html>
