<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Payment Method - PDF to JPG, JPG to PDF, Free PDF Converter | easyjpgtopdf</title>
  <meta name="description" content="Secure payment gateway for PDF to JPG, JPG to PDF converter, free PDF converter, and free image resizer tools. Purchase credits to access premium features.">
  <meta name="keywords" content="pdf to jpg, jpg to pdf, free pdf converter, free image resizer, payment method, razorpay, secure payment">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://easyjpgtopdf.com/payment-method.html">
  <link rel="sitemap" type="application/xml" href="sitemap.xml">
  <link rel="stylesheet" href="css/footer.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/theme-modern.css">
  <link rel="stylesheet" href="css/voice-assistant.css">
  <script src="js/voice-assistant.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #f5f7ff;
      --bg-secondary: #ffffff;
      --text-primary: #0b1630;
      --text-secondary: #56607a;
      --border-color: #e2e6ff;
    }
    
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2b2b2b;
      --text-primary: #e5e5e5;
      --text-secondary: #9ca3af;
      --border-color: #3a3a3a;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }
    
    main {
      flex: 1;
      padding: 40px 24px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .payment-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .payment-header h1 {
      font-size: 2.5rem;
      color: var(--text-primary);
      margin-bottom: 12px;
    }
    
    .payment-header p {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }
    
    .plan-summary {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      border: 2px solid var(--border-color);
      margin-bottom: 32px;
      text-align: center;
    }
    
    .plan-summary h2 {
      font-size: 1.5rem;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .plan-summary .price {
      font-size: 2rem;
      font-weight: 700;
      color: #4361ee;
      margin: 8px 0;
    }
    
    .plan-summary .credits {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-top: 8px;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    
    .payment-method-card {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 32px 24px;
      border-radius: 16px;
      border: 2px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
      cursor: pointer;
      text-align: center;
      position: relative;
    }
    
    .payment-method-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(67, 97, 238, 0.15);
      border-color: #4361ee;
    }
    
    .payment-method-card.active {
      border-color: #4361ee;
      background: rgba(67, 97, 238, 0.05);
    }
    
    .payment-method-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .payment-method-card .method-icon {
      font-size: 3rem;
      color: #4361ee;
      margin-bottom: 16px;
    }
    
    .payment-method-card.disabled .method-icon {
      color: var(--text-secondary);
    }
    
    .payment-method-card h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .payment-method-card p {
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    
    .payment-method-card .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 8px;
    }
    
    .status-badge.active {
      background: #22c55e;
      color: white;
    }
    
    .status-badge.inactive {
      background: #9ca3af;
      color: white;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 32px;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
      text-align: center;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: #fff;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
      width: 100%;
      margin-top: 16px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 24px;
      color: #4361ee;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }
    
    .back-link:hover {
      color: #3a0ca3;
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .ssl-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 2px solid #22c55e;
      border-radius: 8px;
      color: #22c55e;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 20px;
    }
    
    .ssl-badge i {
      font-size: 1.2rem;
    }
    
    .related-tools {
      margin: 60px 0 40px;
      padding: 40px;
      background: var(--bg-secondary);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .related-tools h2 {
      font-size: 2rem;
      color: #4361ee;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .related-tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .related-tool-link {
      display: block;
      padding: 20px;
      background: #f8f9ff;
      border-radius: 12px;
      text-decoration: none;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 2px solid transparent;
    }
    
    .related-tool-link:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(67,97,238,0.2);
      border-color: #4361ee;
    }
    
    .related-tool-link i {
      font-size: 2rem;
      color: #4361ee;
      margin-bottom: 10px;
    }
    
    .related-tool-link h4 {
      font-size: 1.1rem;
      color: #0b1630;
      margin: 0;
    }
    
    .seo-content {
      margin: 40px 0;
      padding: 30px;
      background: var(--bg-secondary);
      border-radius: 12px;
      line-height: 1.8;
      color: var(--text-secondary);
    }
    
    .seo-content h2 {
      color: var(--text-primary);
      font-size: 1.8rem;
      margin-bottom: 16px;
    }
    
    .seo-content h3 {
      color: var(--text-primary);
      font-size: 1.4rem;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    
    .seo-content h4 {
      color: var(--text-primary);
      font-size: 1.2rem;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .payment-methods {
        grid-template-columns: 1fr;
      }
      
      .payment-header h1 {
        font-size: 2rem;
      }
    }
  </style>
  
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Payment Method - PDF to JPG, JPG to PDF, Free PDF Converter | easyjpgtopdf",
    "description": "Secure payment gateway for PDF to JPG, JPG to PDF converter, free PDF converter, and free image resizer tools. Purchase credits to access premium features.",
    "url": "https://easyjpgtopdf.com/payment-method.html",
    "inLanguage": "en-US",
    "isPartOf": {
      "@type": "WebSite",
      "name": "easyjpgtopdf",
      "url": "https://easyjpgtopdf.com"
    },
    "publisher": {
      "@type": "Organization",
      "name": "easyjpgtopdf",
      "url": "https://easyjpgtopdf.com"
    },
    "mainEntity": {
      "@type": "Service",
      "name": "PDF to JPG, JPG to PDF Converter",
      "description": "Free PDF converter and image resizer tools with secure payment options",
      "provider": {
        "@type": "Organization",
        "name": "easyjpgtopdf"
      },
      "areaServed": "Worldwide",
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "PDF and Image Tools",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "PDF to JPG Converter"
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "JPG to PDF Converter"
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Free PDF Converter"
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Free Image Resizer"
            }
          }
        ]
      }
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://easyjpgtopdf.com/index.html"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Pricing",
          "item": "https://easyjpgtopdf.com/pricing.html"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Payment Method",
          "item": "https://easyjpgtopdf.com/payment-method.html"
        }
      ]
    }
  }
  </script>
</head>
<body>
  <div id="global-header-placeholder"></div>

  <nav aria-label="Breadcrumb" style="padding: 15px 0; background: #f8f9ff; border-bottom: 1px solid #e2e6ff;">
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <ol style="list-style: none; display: flex; flex-wrap: wrap; gap: 10px; margin: 0; padding: 0; align-items: center;">
        <li><a href="index.html" style="color: #4361ee; text-decoration: none; font-weight: 500;">Home</a></li>
        <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
        <li><a href="pricing.html" style="color: #56607a; font-weight: 500; text-decoration: none;">Pricing</a></li>
        <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
        <li><span style="color: #56607a;">Payment Method</span></li>
      </ol>
    </div>
  </nav>

  <main>
    <div class="container">
      <a href="pricing.html" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Pricing
      </a>
      
      <div class="payment-header">
        <h1>PDF to JPG, JPG to PDF - Free PDF Converter & Image Resizer Payment</h1>
        <h2>Secure Payment Gateway for Premium Tools</h2>
        <p>Choose your preferred payment gateway to purchase credits for PDF to JPG, JPG to PDF converter, free PDF converter, and free image resizer tools</p>
        <div class="ssl-badge">
          <i class="fas fa-lock"></i>
          <span>SSL Secured - 256-bit Encryption</span>
        </div>
      </div>

      <div id="error-container"></div>

      <div id="plan-summary" class="plan-summary" style="display: none;">
        <h2 id="plan-name">Plan Name</h2>
        <div class="price" id="plan-price">$0</div>
        <div class="credits" id="plan-credits">0 Credits</div>
      </div>

      <div class="payment-methods">
        <!-- Razorpay Payment Method -->
        <div class="payment-method-card active" id="razorpay-card" data-method="razorpay">
          <div class="method-icon">
            <i class="fas fa-credit-card"></i>
          </div>
          <h3>Razorpay</h3>
          <p>Secure payment gateway supporting multiple payment options</p>
          <span class="status-badge active">Active</span>
          <button class="btn btn-primary" id="razorpay-btn" disabled>
            Pay with Razorpay
          </button>
        </div>

        <!-- Stripe Payment Method -->
        <div class="payment-method-card disabled" id="stripe-card" data-method="stripe">
          <div class="method-icon">
            <i class="fab fa-stripe"></i>
          </div>
          <h3>Stripe</h3>
          <p>International payment gateway (Coming Soon)</p>
          <span class="status-badge inactive">Inactive</span>
          <button class="btn btn-primary" disabled>
            Pay with Stripe
          </button>
        </div>
      </div>
      
      <!-- SEO Content Section -->
      <div class="seo-content">
        <h2>Free PDF Converter and Image Tools</h2>
        <p>Access our comprehensive suite of free PDF converter and image processing tools. Convert PDF to JPG, JPG to PDF, resize images, and more with our secure payment system.</p>
        
        <h3>PDF to JPG Converter</h3>
        <p>Convert PDF files to high-quality JPG images instantly. Our PDF to JPG converter supports batch processing and maintains image quality throughout the conversion process.</p>
        
        <h3>JPG to PDF Converter</h3>
        <p>Transform your JPG images into professional PDF documents. Our JPG to PDF converter allows you to combine multiple images into a single PDF file with customizable settings.</p>
        
        <h4>Free PDF Converter Features</h4>
        <p>Our free PDF converter offers unlimited access to basic conversion features. Upgrade to premium plans for advanced features like batch processing, high-resolution output, and priority support.</p>
        
        <h4>Free Image Resizer</h4>
        <p>Resize your images without losing quality. Our free image resizer supports multiple formats and provides precise control over dimensions and aspect ratios.</p>
      </div>
      
      <!-- Related Tools Section -->
      <section class="related-tools">
        <h2>
          <i class="fas fa-tools" style="margin-right: 10px;"></i>
          More Related Tools
        </h2>
        <div class="related-tools-grid">
          <a href="jpg-to-pdf.html" class="related-tool-link">
            <i class="fas fa-file-pdf"></i>
            <h4>JPG to PDF</h4>
          </a>
          
          <a href="pdf-to-word.html" class="related-tool-link">
            <i class="fas fa-file-word"></i>
            <h4>PDF to Word</h4>
          </a>
          
          <a href="resume-maker.html" class="related-tool-link">
            <i class="fas fa-file-alt"></i>
            <h4>Resume Maker</h4>
          </a>
          
          <a href="background-remover.html" class="related-tool-link">
            <i class="fas fa-magic"></i>
            <h4>Background Remover</h4>
          </a>
        </div>
      </section>
    </div>
  </main>

  <div id="global-footer-placeholder"></div>

  <script type="module">
    // Auth script
    const isLocalFileProtocol = window.location.protocol === 'file:';
    if (!isLocalFileProtocol) {
      import('./js/auth.js').catch(err => {
        console.error('‚ùå Failed to load auth.js:', err);
      });
    }
  </script>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script type="module">
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Use existing auth instance from auth.js module instead of creating new one
    let auth;
    let authReady = false;
    
    (async function() {
      try {
        // Method 1: Try to import auth from auth.js (preferred - uses existing instance)
        try {
          const authModule = await import('./js/auth.js');
          if (authModule && authModule.auth) {
            auth = authModule.auth;
            console.log('‚úÖ Using auth instance from auth.js module');
            
            // Wait for auth state to be ready
            await new Promise((resolve) => {
              const unsubscribe = onAuthStateChanged(auth, (user) => {
                authReady = true;
                unsubscribe();
                console.log('Auth state ready, user:', user ? user.uid : 'null');
                resolve();
              });
              setTimeout(() => {
                authReady = true;
                unsubscribe();
                resolve();
              }, 2000);
            });
            return; // Successfully initialized
          }
        } catch (e) {
          console.warn('Could not import auth.js, trying fallback:', e);
        }
        
        // Method 2: Try firebase-init.js
        try {
          const firebaseInit = await import('./js/firebase-init.js');
          if (firebaseInit && firebaseInit.auth) {
            auth = firebaseInit.auth;
            console.log('‚úÖ Using auth instance from firebase-init.js');
            authReady = true;
            return; // Successfully initialized
          }
        } catch (e) {
          console.warn('Could not import firebase-init.js, trying sessionStorage:', e);
        }
        
        // Method 3: Fallback to sessionStorage (last resort)
        const firebaseConfig = JSON.parse(sessionStorage.getItem('firebaseConfig') || '{}');
        if (firebaseConfig.apiKey) {
          const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          console.log('‚ö†Ô∏è Using new auth instance from sessionStorage (fallback)');
          
          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              authReady = true;
              unsubscribe();
              resolve();
            });
            setTimeout(() => {
              authReady = true;
              unsubscribe();
              resolve();
            }, 2000);
          });
        } else {
          console.warn('No Firebase config found, auth features will be limited');
          authReady = true;
        }
      } catch (e) {
        console.error('Firebase initialization error:', e);
        authReady = true;
      }
    })();

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan');
    const credits = urlParams.get('credits');
    const price = urlParams.get('price');

    // Validate required parameters
    if (!plan || !credits || !price) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = `
        <div class="error-message">
          <strong>Error:</strong> Missing plan information. Please select a plan from the pricing page.
          <br><a href="pricing.html" style="color: #4361ee; text-decoration: underline;">Go to Pricing</a>
        </div>
      `;
    } else {
      // Display plan summary
      const planSummary = document.getElementById('plan-summary');
      const planName = document.getElementById('plan-name');
      const planPrice = document.getElementById('plan-price');
      const planCredits = document.getElementById('plan-credits');
      
      const planNames = {
        'pro': 'PRO Plan',
        'pro-plus': 'PRO+ Plan',
        'super-premium': 'Super Premium Plan'
      };
      
      planName.textContent = planNames[plan] || plan.toUpperCase();
      planPrice.textContent = `$${parseFloat(price).toFixed(2)}`;
      planCredits.textContent = `${parseInt(credits).toLocaleString()} Credit Points`;
      planSummary.style.display = 'block';
      
      // Enable Razorpay button
      const razorpayBtn = document.getElementById('razorpay-btn');
      razorpayBtn.disabled = false;
    }

    // Helper function to get current user ID
    async function getCurrentUserId() {
      console.log('üîç getCurrentUserId() called');
      console.log('Auth ready:', authReady);
      console.log('Auth instance:', auth);
      
      // Ensure we have the correct auth instance
      if (!auth) {
        console.log('‚ö†Ô∏è No auth instance, trying to get from modules...');
        try {
          const authModule = await import('./js/auth.js');
          if (authModule && authModule.auth) {
            auth = authModule.auth;
            console.log('‚úÖ Got auth from auth.js module');
          }
        } catch (e) {
          console.warn('Could not get auth from auth.js:', e);
        }
      }
      
      // Wait for auth to be ready
      if (!authReady) {
        console.log('‚è≥ Waiting for auth to be ready...');
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      // Try multiple methods to get user ID
      if (auth) {
        // Method 1: Direct access
        const user = auth.currentUser;
        if (user && user.uid) {
          console.log('‚úÖ User found via direct access:', user.uid);
          return user.uid;
        }
        
        console.log('‚è≥ No direct user, waiting for auth state...');
        // Method 2: Wait for auth state
        return new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            if (user && user.uid) {
              console.log('‚úÖ User found via auth state:', user.uid);
              resolve(user.uid);
            } else {
              console.log('‚ùå No user in auth state');
              resolve(null);
            }
          });
          setTimeout(() => {
            unsubscribe();
            // Final check
            if (auth && auth.currentUser && auth.currentUser.uid) {
              console.log('‚úÖ User found in final check:', auth.currentUser.uid);
              resolve(auth.currentUser.uid);
            } else {
              console.log('‚ùå No user found after timeout');
              resolve(null);
            }
          }, 3000);
        });
      }
      
      // Try importing auth module as fallback
      try {
        console.log('‚ö†Ô∏è Trying auth module as fallback...');
        const authModule = await import('./js/auth.js');
        if (authModule && authModule.auth) {
          const authInstance = authModule.auth;
          if (authInstance.currentUser && authInstance.currentUser.uid) {
            console.log('‚úÖ User found in auth module:', authInstance.currentUser.uid);
            return authInstance.currentUser.uid;
          }
          
          // Wait for auth state from module
          const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          return new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(authInstance, (user) => {
              unsubscribe();
              if (user && user.uid) {
                console.log('‚úÖ User found via auth module state:', user.uid);
                resolve(user.uid);
              } else {
                console.log('‚ùå No user in auth module state');
                resolve(null);
              }
            });
            setTimeout(() => {
              unsubscribe();
              if (authInstance.currentUser && authInstance.currentUser.uid) {
                console.log('‚úÖ User found in auth module final check:', authInstance.currentUser.uid);
                resolve(authInstance.currentUser.uid);
              } else {
                console.log('‚ùå No user found in auth module after timeout');
                resolve(null);
              }
            }, 2000);
          });
        }
      } catch (e) {
        console.warn('Could not import auth module:', e);
      }
      
      console.log('‚ùå No user found, returning null');
      return null;
    }
    
    // Helper to get auth token
    async function getAuthToken() {
      if (!auth || !authReady) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      if (auth && auth.currentUser) {
        return await auth.currentUser.getIdToken();
      }
      
      // Try auth module
      try {
        const authModule = await import('./js/auth.js');
        if (authModule && authModule.auth && authModule.auth.currentUser) {
          return await authModule.auth.currentUser.getIdToken();
        }
      } catch (e) {
        console.warn('Could not get token from auth module:', e);
      }
      
      return null;
    }

    // Razorpay payment handler
    document.getElementById('razorpay-btn').addEventListener('click', async function() {
      if (!plan || !credits || !price) {
        alert('Missing plan information. Please go back and select a plan.');
        return;
      }

      const btn = this;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        console.log('üöÄ Starting payment process...');
        console.log('Auth ready:', authReady);
        console.log('Auth instance:', auth);
        
        // Ensure we have the correct auth instance
        if (!auth) {
          console.log('‚ö†Ô∏è No auth instance, trying to get from modules...');
          try {
            const authModule = await import('./js/auth.js');
            if (authModule && authModule.auth) {
              auth = authModule.auth;
              console.log('‚úÖ Got auth from auth.js module');
            }
          } catch (e) {
            console.warn('Could not get auth from auth.js:', e);
          }
        }
        
        // Wait longer for auth to be ready
        if (!authReady) {
          console.log('‚è≥ Waiting for auth to be ready...');
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
        
        // Additional wait to ensure auth is fully initialized
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Check if user is logged in - try multiple methods
        let userId = await getCurrentUserId();
        console.log('User ID from getCurrentUserId:', userId);
        
        // Double check with direct auth access
        if (!userId && auth) {
          if (auth.currentUser && auth.currentUser.uid) {
            userId = auth.currentUser.uid;
            console.log('‚úÖ User ID from direct auth access:', userId);
          } else {
            // Try auth module again
            try {
              const authModule = await import('./js/auth.js');
              if (authModule && authModule.auth && authModule.auth.currentUser) {
                userId = authModule.auth.currentUser.uid;
                console.log('‚úÖ User ID from auth module:', userId);
              }
            } catch (e) {
              console.warn('Auth module check failed:', e);
            }
          }
        }
        
        // If still no userId, wait a bit more and check again
        if (!userId) {
          console.log('‚è≥ Still no userId, waiting and checking again...');
          await new Promise(resolve => setTimeout(resolve, 1000));
          userId = await getCurrentUserId();
          
          if (!userId && auth && auth.currentUser) {
            userId = auth.currentUser.uid;
            console.log('‚úÖ User ID after retry:', userId);
          }
        }
        
        if (!userId) {
          console.log('‚ùå No user found, redirecting to login');
          // Store pending purchase and redirect to login
          sessionStorage.setItem('pendingCreditPurchase', JSON.stringify({
            plan,
            credits: parseInt(credits),
            price: parseFloat(price),
            timestamp: Date.now(),
            returnTo: window.location.href
          }));
          window.location.href = `login.html?returnTo=${encodeURIComponent(window.location.href)}`;
          return;
        }

        console.log('‚úÖ User authenticated, proceeding with payment:', userId);
        // User is logged in - proceed with payment
        await initiateRazorpayPayment(userId, plan, parseInt(credits), parseFloat(price));
      } catch (error) {
        console.error('Error initiating payment:', error);
        alert('Failed to start payment. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Pay with Razorpay';
      }
    });

    // Initiate Razorpay payment
    async function initiateRazorpayPayment(userId, plan, credits, price) {
      try {
        // Wait for auth to be ready
        if (!auth || !authReady) {
          await new Promise(resolve => setTimeout(resolve, 1500));
        }
        
        // Get user token - try multiple methods
        let user = auth?.currentUser;
        let token = null;
        
        // Method 1: Direct auth access
        if (user) {
          try {
            token = await user.getIdToken();
          } catch (e) {
            console.warn('Failed to get token from currentUser:', e);
          }
        }
        
        // Method 2: Wait for auth state if not available
        if (!user && auth) {
          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (u) => {
              unsubscribe();
              user = u;
              resolve();
            });
            setTimeout(() => {
              unsubscribe();
              if (auth && auth.currentUser) {
                user = auth.currentUser;
              }
              resolve();
            }, 2000);
          });
          
          if (user) {
            try {
              token = await user.getIdToken();
            } catch (e) {
              console.warn('Failed to get token after auth state:', e);
            }
          }
        }
        
        // Method 3: Try auth module
        if (!token) {
          try {
            const authModule = await import('./js/auth.js');
            if (authModule && authModule.auth && authModule.auth.currentUser) {
              user = authModule.auth.currentUser;
              token = await user.getIdToken();
            }
          } catch (e) {
            console.warn('Auth module token fetch failed:', e);
          }
        }
        
        if (!token || !user) {
          throw new Error('User not authenticated. Please sign in again.');
        }
        
        // Create order via backend
        const API_BASE_URL = window.location.origin.includes('localhost') 
          ? 'http://localhost:3000' 
          : (window.location.origin.includes('easyjpgtopdf.com') 
              ? 'https://pdf-to-word-converter-iwumaktavq-uc.a.run.app'
              : window.location.origin);
        
        console.log('Creating order with:', { plan, credits, price, userId });
        console.log('API URL:', `${API_BASE_URL}/api/credits/create-order`);
        console.log('Token available:', !!token);
        
        const response = await fetch(`${API_BASE_URL}/api/credits/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            plan,
            credits,
            amount: price,
            currency: 'USD'
          })
        });

        console.log('Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          let error;
          try {
            error = JSON.parse(errorText);
          } catch (e) {
            error = { message: errorText || `Failed to create order (${response.status})` };
          }
          throw new Error(error.error || error.message || `Failed to create order (${response.status})`);
        }

        const orderData = await response.json();
        
        if (!orderData.success || !orderData.order) {
          throw new Error('Invalid order response from server');
        }

        console.log('Order created:', orderData);

        // Get Razorpay key
        const razorpayKey = orderData.key_id || orderData.key || '';
        
        if (!razorpayKey) {
          throw new Error('Razorpay key not found. Please contact support.');
        }

        if (!window.Razorpay) {
          throw new Error('Razorpay SDK not loaded. Please refresh the page.');
        }

        // Open Razorpay checkout
        const options = {
          key: razorpayKey,
          amount: orderData.order.amount,
          currency: orderData.order.currency || 'INR',
          name: 'easyjpgtopdf',
          description: `${plan.toUpperCase()} - ${credits} Credit Points`,
          order_id: orderData.order.id,
          prefill: {
            email: user.email || '',
            name: user.displayName || user.email || ''
          },
          theme: {
            color: '#4361ee'
          },
          handler: async function(paymentResponse) {
            console.log('Payment successful:', paymentResponse);
            // Payment successful - verify and add credits
            await verifyAndAddCredits(userId, paymentResponse, orderData.order.id, plan, credits, price);
          },
          modal: {
            ondismiss: function() {
              console.log('Payment cancelled by user');
              const btn = document.getElementById('razorpay-btn');
              btn.disabled = false;
              btn.textContent = 'Pay with Razorpay';
            }
          }
        };

        const razorpay = new Razorpay(options);
        razorpay.open();
        
      } catch (error) {
        console.error('Payment error:', error);
        alert(error.message || 'Failed to initiate payment. Please try again.');
        const btn = document.getElementById('razorpay-btn');
        btn.disabled = false;
        btn.textContent = 'Pay with Razorpay';
      }
    }

    // Verify payment and add credits
    async function verifyAndAddCredits(userId, paymentResponse, orderId, plan, credits, price) {
      try {
        // Wait for auth
        if (!auth || !authReady) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // Get token using helper function
        let token = await getAuthToken();
        
        // If token not available, try direct access
        if (!token) {
          let user = auth?.currentUser;
          if (!user && auth) {
            await new Promise((resolve) => {
              const unsubscribe = onAuthStateChanged(auth, (u) => {
                unsubscribe();
                user = u;
                resolve();
              });
              setTimeout(() => {
                unsubscribe();
                if (auth && auth.currentUser) {
                  user = auth.currentUser;
                }
                resolve();
              }, 2000);
            });
          }
          
          if (user) {
            token = await user.getIdToken();
          }
        }
        
        if (!token) {
          throw new Error('User not authenticated');
        }
        
        const API_BASE_URL = window.location.origin.includes('localhost') 
          ? 'http://localhost:3000' 
          : (window.location.origin.includes('easyjpgtopdf.com') 
              ? 'https://pdf-to-word-converter-iwumaktavq-uc.a.run.app'
              : window.location.origin);
        
        console.log('Verifying payment:', { orderId, paymentId: paymentResponse.razorpay_payment_id });
        
        const response = await fetch(`${API_BASE_URL}/api/credits/verify-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            razorpay_payment_id: paymentResponse.razorpay_payment_id,
            razorpay_order_id: paymentResponse.razorpay_order_id,
            razorpay_signature: paymentResponse.razorpay_signature,
            orderId,
            plan,
            credits,
            amount: price
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          let error;
          try {
            error = JSON.parse(errorText);
          } catch (e) {
            error = { message: errorText || 'Payment verification failed' };
          }
          throw new Error(error.error || error.message || 'Payment verification failed');
        }

        const result = await response.json();
        
        if (result.success) {
          // Get current credit balance from result
          const currentBalance = result.credits || result.receipt?.creditsBalance || 0;
          const creditsAdded = result.receipt?.credits || credits;
          
          // Show success message
          const successMsg = `Payment successful! ${creditsAdded} credits have been added to your account.\n\nYour current balance: ${currentBalance} credits`;
          
          // Redirect to receipt page with payment details (if receipt data available)
          if (result.receipt) {
            const receiptParams = new URLSearchParams({
              payment_id: result.receipt.paymentId,
              order_id: result.receipt.orderId,
              amount: result.receipt.amount,
              currency: result.receipt.currency,
              credits: result.receipt.credits,
              plan: result.receipt.plan,
              balance: result.receipt.creditsBalance,
              expires_at: result.receipt.expiresAt ? new Date(result.receipt.expiresAt).toISOString() : '',
              type: 'credit_purchase'
            });
            
            // Redirect to receipt page (receipt page will show success message)
            window.location.href = `payment-receipt.html?${receiptParams.toString()}`;
          } else {
            // Fallback: show success message and redirect to dashboard
            alert(successMsg);
            // Redirect to dashboard after 2 seconds to allow user to see the message
            setTimeout(() => {
              window.location.href = 'dashboard.html#dashboard-credits';
            }, 2000);
          }
        } else {
          throw new Error(result.error || result.message || 'Payment verification failed');
        }
      } catch (error) {
        console.error('Verification error:', error);
        alert(`Payment verification failed: ${error.message}. Please contact support if credits were deducted.`);
      }
    }

    // Check for pending purchase after login
    window.addEventListener('load', async () => {
      if (!authReady) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      const pending = sessionStorage.getItem('pendingCreditPurchase');
      if (pending) {
        try {
          const data = JSON.parse(pending);
          if (Date.now() - data.timestamp < 5 * 60 * 1000) {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            let userId = await getCurrentUserId();
            
            if (!userId && auth && auth.currentUser) {
              userId = auth.currentUser.uid;
            }
            
            if (userId) {
              sessionStorage.removeItem('pendingCreditPurchase');
              // Reload page with plan parameters
              if (data.plan && data.credits && data.price) {
                window.location.href = `payment-method.html?plan=${data.plan}&credits=${data.credits}&price=${data.price}`;
              }
            }
          } else {
            sessionStorage.removeItem('pendingCreditPurchase');
          }
        } catch (e) {
          console.error('Error processing pending purchase:', e);
          sessionStorage.removeItem('pendingCreditPurchase');
        }
      }
    });
  </script>
  
  <script src="/js/global-components.js"></script>
  <script type="module" src="/js/auth.js"></script>
</body>
</html>

