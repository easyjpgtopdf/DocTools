<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Background Workspace | easyjpgtopdf</title>
<link href="css/footer.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script type="importmap">
    {
      "imports": {
        "onnxruntime-web": "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.21.0/dist/ort.min.mjs"
      }
    }
  </script>
<style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --dark: #212529;
      --muted: #7a7f8c;
      --surface: #ffffff;
      --border: rgba(18, 20, 58, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(180deg, #f3f4ff 0%, #f8f9ff 100%); color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--surface); box-shadow: 0 12px 30px rgba(14, 32, 86, 0.1); position: sticky; top: 0; z-index: 20; }
    .topbar .inner { max-width: 1200px; margin: 0 auto; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; gap: 18px; }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 700; font-size: 20px; color: var(--primary); text-decoration: none; }
    .quick-links { display: flex; gap: 10px; flex-wrap: wrap; }
    .quick-links a { text-decoration: none; padding: 8px 16px; border-radius: 999px; border: 1px solid var(--border); color: #253156; font-weight: 600; background: rgba(67, 97, 238, 0.08); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
    .quick-links a:hover { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; transform: translateY(-1px); box-shadow: 0 12px 24px rgba(67, 97, 238, 0.2); }
    main { flex: 1; width: 100%; max-width: 1200px; margin: 36px auto; padding: 0 24px 48px; display: grid; grid-template-columns: 1fr 40%; gap: 32px; align-items: start; }
    .panel { background: var(--surface); border-radius: 24px; padding: 28px; box-shadow: 0 20px 45px rgba(15, 30, 70, 0.08); }
    .panel h2 { font-size: 1.35rem; margin-bottom: 18px; display: flex; gap: 12px; align-items: center; color: #171f4d; }
    .preview-stage { position: relative; width: 8.5cm; height: 6cm; max-width: 100%; max-height: 100%; margin: 0 auto; border-radius: 18px; background: repeating-conic-gradient(#e5e9ff 0deg 25deg, #f8f9ff 25deg 50deg); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .preview-original, .preview-result { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; transition: opacity 0.6s ease; }
    .preview-result { opacity: 0; }
    .preview-stage.revealed .preview-result { opacity: 1; }
    .preview-stage.revealed .preview-original { opacity: 0; }
    .preview-overlay { position: absolute; inset: 0; background: rgba(17, 24, 39, 0.55); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: #fff; font-weight: 600; letter-spacing: 0.03em; transition: opacity 0.4s ease; }
    .preview-stage.revealed .preview-overlay { opacity: 0; pointer-events: none; }
    .preview-stage.empty .preview-overlay { display: none; }
    .preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; text-align: center; color: var(--muted); font-weight: 600; letter-spacing: 0.03em; }
    .preview-placeholder.hidden { display: none; }
    .preview-spinner { width: 34px; height: 34px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .actions { margin-top: 24px; display: flex; flex-wrap: wrap; gap: 14px; align-items: center; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 22px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.25); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: #233050; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .status-card { display: flex; flex-direction: column; gap: 18px; color: var(--muted); font-size: 0.95rem; line-height: 1.6; }
    .status-card strong { color: #1e254d; font-size: 1.05rem; }
    #addMoreFiles { min-width: 48px; padding: 10px; }
    #fileGallery { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .gallery-download-btn:hover { background: rgba(67,97,238,1) !important; transform: scale(1.1); }
    footer { text-align: center; padding: 24px 16px 40px; font-size: 0.85rem; color: var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
      .actions { justify-content: center; }
    }
  </style>
<link href="css/header.css" rel="stylesheet"/>
<link href="css/theme-modern.css" rel="stylesheet"/>
</head>
<body>
<header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo"><img src="images/logo.png" alt="Logo" style="height:54px;"></a>
                <div class="nav-links">
                    <div class="dropdown">
                        <a href="#">Convert to PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="jpg-to-pdf.html">JPG to PDF</a>
                            <a href="word-to-pdf.html">Word to PDF</a>
                            <a href="excel-to-pdf.html">Excel to PDF</a>
                            <a href="ppt-to-pdf.html">PowerPoint to PDF</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Convert from PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pdf-to-jpg.html">PDF to JPG</a>
                            <a href="pdf-to-word.html">PDF to Word</a>
                            <a href="pdf-to-excel.html">PDF to Excel</a>
                            <a href="pdf-to-ppt.html">PDF to PowerPoint</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Pdf Editor <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="merge-pdf.html">Merge PDF</a>
                            <a href="split-pdf.html">Split PDF</a>
                            <a href="compress-pdf.html">Compress PDF</a>
                            <a href="edit-pdf.html">Pdf Editor</a>
                            <a href="protect-pdf.html">Protect PDF</a>
                            <a href="unlock-pdf.html">Unlock PDF</a>
                            <a href="watermark-pdf.html">Watermark PDF</a>
                            <a href="crop-pdf.html">Crop PDF</a>
                            <a href="add-page-numbers.html">Add Page Numbers</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Image Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="image-repair.html">AI Image Repair</a>
                            <a href="image-compressor.html">Image Compressor</a>
                            <a href="image-resizer.html">Image Resizer</a>
                            <a href="image-editor.html">Image Editor</a>
                            <a href="background-remover.html">Image Background Remover</a>
                            <a href="ocr-image.html">OCR Image</a>
                            <a href="image-watermark.html">Image Watermark Tool</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Design Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="resume-maker.html">Resume Maker</a>
                            <a href="biodata-maker.html">Marrige Biodata-Data Maker</a>
                            <a href="ai-image-generator.html">AI Image Generator</a>
                            <a href="marriage-card.html">Marriage Card</a>
                            <a href="excel-unlocker/" target="_blank">Excel Unlocker</a>
                            <a href="protect-excel.html">Protect Excel Sheet</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">More <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pricing.html">Pricing</a>
                            <a href="blog.html">Blog/Articles</a>
                            <a href="https://apnaonlineservic.com" target="_blank">Shop-ApnaOnline</a>
                            <a href="https://aimathmaster.com" target="_blank">AI-Math Master</a>
                        </div>
                    </div>
                </div>
                <div class="auth-buttons">
                    <a href="login.html" class="auth-link">Sign In</a>
                    <a href="signup.html" class="auth-btn"><i class="fas fa-user-plus" aria-hidden="true"></i><span>Signup</span></a>
                </div>
                <div id="user-menu" class="user-menu" data-open="false">
                    <button id="user-menu-toggle" class="user-menu-toggle" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Account menu">
                        <span class="user-initial" aria-hidden="true">U</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown" hidden>
                        <a href="dashboard.html#dashboard-overview" data-user-nav="dashboard-overview"><i class="fas fa-user-circle"></i> Account Dashboard</a>
                        <a href="dashboard.html#dashboard-billing" data-user-nav="dashboard-billing"><i class="fas fa-file-invoice"></i> Billing Details</a>
                        <a href="dashboard.html#dashboard-payments" data-user-nav="dashboard-payments"><i class="fas fa-wallet"></i> Payment History</a>
                        <a href="dashboard.html#dashboard-orders" data-user-nav="dashboard-orders"><i class="fas fa-clipboard-list"></i> Orders &amp; Subscriptions</a>
                        <a href="accounts.html#login"><i class="fas fa-user-cog"></i> Account Center</a>
                        <button type="button" id="logout-button" class="dropdown-logout"><i class="fas fa-sign-out-alt"></i> Sign out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
<main>
<section class="panel">
<h2><i class="fas fa-wand-magic-sparkles"></i> Background Removed</h2>
<div class="preview-stage" id="previewStage">
<img alt="Original" class="preview-original" hidden="" id="previewOriginal"/>
<img alt="Result" class="preview-result" hidden="" id="previewResult"/>
<div class="preview-overlay" id="previewOverlay">
<div class="preview-spinner"></div>
<span>AI Processing...</span>
</div>
<div class="preview-placeholder hidden" id="previewPlaceholder">
<i class="fas fa-image" style="font-size:3rem;opacity:0.3;"></i>
<span>No image loaded</span>
</div>
</div>
<div class="actions">
<button class="btn btn-outline" disabled="" id="backgroundChange">
<i class="fas fa-palette"></i> Change Background
        </button>
<button class="btn btn-primary" disabled="" id="downloadPng">
<i class="fas fa-download"></i> Download PNG
        </button>
<button class="btn btn-primary" id="addMoreFiles" title="Add more images">
<i class="fas fa-plus"></i>
        </button>
</div>
<!-- File Preview Gallery (like remove.bg) -->
<div id="fileGallery" style="display: none; margin-top: 24px; padding: 16px; background: rgba(67,97,238,0.05); border-radius: 12px;">
  <h3 style="margin-bottom: 12px; font-size: 1rem; color: #1e254d;">Processed Files</h3>
  <div id="galleryContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;"></div>
</div>
</section>
<section class="panel">
<h2><i class="fas fa-info-circle"></i> Processing Info</h2>
<div class="status-card" id="statusMessage"></div>
<!-- Animated Demo from background-remover.html -->
<div style="margin: 16px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(67,97,238,0.15);">
  <img src="images/bg-removal-city-demo.svg" alt="Background Removal Demo" style="width: 100%; height: auto; display: block;">
</div>
<div class="status-card">
<strong>‚úì Smart Processing System</strong>
<p>‚Ä¢ <strong>0-2 MB</strong>: IMG.LY AI (Browser) - Free</p>
<p>‚Ä¢ <strong>2+ MB</strong>: Google Cloud Run (Rembg U¬≤-Net) - Premium</p>
<p>‚Ä¢ Free Upload: Up to 10 MB</p>
<p>‚Ä¢ Free Download: Up to 500 KB (compressed)</p>
<p>‚Ä¢ Premium: Unlimited upload & download</p>
</div>
</section>
</main>
<script type="module">
    // Import Firebase modules (optional - works without Firebase for file:// protocol)
    let auth = null;
    let db = null;
    let getDoc = null;
    let doc = null;
    let onAuthStateChanged = null;
    
    // Try to load Firebase, but don't fail if file:// protocol
    const isLocalFile = window.location.protocol === 'file:';
    
    if (!isLocalFile) {
      try {
        const firebaseInit = await import('./js/firebase-init.js');
        const firestore = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const firebaseAuth = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
        
        auth = firebaseInit.auth;
        db = firebaseInit.db;
        getDoc = firestore.getDoc;
        doc = firestore.doc;
        onAuthStateChanged = firebaseAuth.onAuthStateChanged;
        
        console.log('‚úÖ Firebase loaded successfully');
      } catch (error) {
        console.warn('‚ö†Ô∏è Firebase not available (file:// protocol or network issue):', error.message);
      }
    } else {
      console.log('‚ÑπÔ∏è Running on file:// protocol - Firebase disabled (upload will work without auth)');
    }

    const STORAGE_KEYS = {
      original: 'bgRemover:original',
      filename: 'bgRemover:filename',
      foreground: 'bgRemover:foreground',
      dimensions: 'bgRemover:dimensions'
    };

    // Limits - Updated
    const FREE_UPLOAD_LIMIT = 10 * 1024 * 1024; // 10 MB - Free upload limit
    const FREE_DOWNLOAD_LIMIT = 500 * 1024; // 500 KB - Free download limit
    const IMGLY_MAX_SIZE = 2 * 1024 * 1024; // 2 MB - use imagly up to this

    const previewStage = document.getElementById('previewStage');
    const previewOriginal = document.getElementById('previewOriginal');
    const previewResult = document.getElementById('previewResult');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const backgroundChangeBtn = document.getElementById('backgroundChange');
    const downloadBtn = document.getElementById('downloadPng');
    const statusMessage = document.getElementById('statusMessage');

    let resultCanvas = null;
    let resultContext = null;
    let resultDataURL = null;
    let removeBackgroundFn = null;
    let preloadFn = null;
    let modelPreloaded = false;
    let libraryLoading = false;
    let currentUser = null;
    let userSubscription = null;

    // Check user subscription status (only if Firebase available)
    async function checkUserSubscription(user) {
      if (!user || !auth || !db || !doc || !getDoc) return null;
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists()) {
          const data = userDoc.data();
          const plan = data.plan || 'free';
          const subscriptionEnd = data.subscriptionEnd || null;
          const isPremium = plan === 'premium' || plan === 'pro';
          
          // Check if subscription is valid (not expired)
          let isValid = false;
          if (isPremium && subscriptionEnd) {
            const endDate = new Date(subscriptionEnd);
            const now = new Date();
            isValid = endDate > now;
          }
          
          return {
            plan: plan,
            isPremium: isPremium,
            isValid: isValid,
            subscriptionEnd: subscriptionEnd
          };
        }
      } catch (error) {
        console.error('Error checking subscription:', error);
      }
      return null;
    }

    // Monitor auth state (only if Firebase available)
    if (auth && onAuthStateChanged) {
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          userSubscription = await checkUserSubscription(user);
        } else {
          userSubscription = null;
        }
      });
    } else {
      console.log('‚ÑπÔ∏è Running without authentication - all features available');
    }

    // Load IMG.LY library
    async function ensureLibraryLoaded() {
      if (removeBackgroundFn) return true;
      if (libraryLoading) {
        while (libraryLoading) {
          await new Promise(r => setTimeout(r, 100));
        }
        return !!removeBackgroundFn;
      }

      try {
        libraryLoading = true;
        console.log('üöÄ Loading AI library...');
        ({ removeBackground: removeBackgroundFn, preload: preloadFn } = await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.7.0/dist/index.mjs'));
        console.log('‚úÖ AI library loaded successfully!');
        libraryLoading = false;
        return true;
      } catch (err) {
        libraryLoading = false;
        console.error('‚ùå Failed to load AI library:', err);
        showError('AI library failed to load. Please check your internet connection and refresh the page.');
        return false;
      }
    }

    function dataURLToBlob(dataURL) {
      const [meta, encoded] = dataURL.split(',');
      const mimeMatch = meta.match(/data:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/png';
      const binary = atob(encoded);
      const len = binary.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) buffer[i] = binary.charCodeAt(i);
      return new Blob([buffer], { type: mime });
    }

    async function blobFromSource(source, meta) {
      if (!source) return null;
      if (source.startsWith('data:')) {
        return dataURLToBlob(source);
      }
      if (source.startsWith('blob:')) {
        return await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', source);
          xhr.responseType = 'blob';
          xhr.onload = () => {
            const responseBlob = xhr.response;
            if (responseBlob && meta?.type && responseBlob.type !== meta.type) {
              resolve(responseBlob.slice(0, responseBlob.size, meta.type));
            } else {
              resolve(responseBlob);
            }
          };
          xhr.onerror = () => reject(new Error('Failed to read blob URL.'));
          xhr.send();
        });
      }
      const response = await fetch(source);
      return await response.blob();
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function showError(message) {
      statusMessage.innerHTML = `<div style="padding:16px;border-radius:14px;background:rgba(220,38,38,0.12);color:#7f1d1d;font-weight:600;">${message}</div>`;
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    function ensureCanvas(width, height) {
      if (!resultCanvas) {
        resultCanvas = document.createElement('canvas');
        resultContext = resultCanvas.getContext('2d');
      }
      resultCanvas.width = width;
      resultCanvas.height = height;
    }

    // Google Cloud Run API URL - Connected to u2net rembg backend
    // Verify connection: Open this URL in browser to check if backend is running
    const CLOUDRUN_API_URL = 'https://bg-remover-api-iwumaktavq-uc.a.run.app/remove-background';
    
    // Test backend connection on load
    async function testBackendConnection() {
      try {
        const response = await fetch(CLOUDRUN_API_URL.replace('/remove-background', '/health'), {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Google Cloud Run Backend Connected:', data);
          console.log('‚úÖ Using u2net rembg model:', data.model || 'u2net');
          return true;
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Backend not reachable (will use browser processing):', error.message);
      }
      return false;
    }
    
    // Test connection immediately
    testBackendConnection();
    
    // Smart routing based on file size
    function getProcessingConfig(fileSize) {
      const sizeMB = fileSize / (1024 * 1024);
      
      // Tier 1: IMG.LY (Browser AI) - 0 to 2 MB
      if (fileSize <= IMGLY_MAX_SIZE) {
        return {
          useBackend: false,
          model: 'medium',
          quality: 1.0,
          description: 'IMG.LY AI - Professional Quality',
          message: `Processing ${sizeMB.toFixed(1)} MB with IMG.LY AI`,
          tier: 'imagly',
          info: '‚ö° Fast & Free - Professional quality'
        };
      } 
      // Tier 2: Google Cloud Run (Rembg U¬≤-Net) - Above 2 MB
      else {
        return {
          useBackend: true,
          backendUrl: CLOUDRUN_API_URL,
          timeout: 300000,
          description: 'Google Cloud Run - Rembg U¬≤-Net',
          message: `Processing ${sizeMB.toFixed(1)} MB with Cloud AI (Premium)`,
          tier: 'cloudrun',
          info: '‚òÅÔ∏è Premium Processing - Rembg U¬≤-Net Latest',
          quality: 1.0
        };
      }
    }

    // Process image using Google Cloud Run backend
    async function processWithBackend(dataURL, backendUrl, config) {
      try {
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">‚òÅÔ∏è Uploading to Google Cloud AI...</div>`;
        
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 180000);
        
        const response = await fetch(backendUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ imageData: dataURL }),
          signal: controller.signal
        });
        
        clearTimeout(timeout);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">‚ú® Processing with professional AI...</div>`;
        
        const result = await response.json();
        
        if (result.success && result.resultImage) {
          return { 
            success: true, 
            dataUrl: result.resultImage, 
            processedWith: result.processedWith || config.description,
            outputSize: result.outputSize,
            outputSizeMB: result.outputSizeMB
          };
        } else {
          throw new Error(result.error || 'Processing failed on server');
        }
      } catch (error) {
        console.error('‚ùå Backend processing error:', error);
        
        if (error.name === 'AbortError') {
          return { success: false, error: 'Request timeout. File too large or server busy.' };
        }
        
        return { success: false, error: error.message || 'Server connection failed' };
      }
    }

    async function processImage(dataURL) {
      clearStatus();
      previewPlaceholder.classList.add('hidden');
      previewStage.classList.remove('revealed');
      previewStage.classList.remove('empty');
      
      // IMMEDIATE PREVIEW - Show original image instantly
      try {
        previewOriginal.hidden = false;
        previewOriginal.src = dataURL;
        previewOverlay.style.opacity = 1;
      } catch (err) {
        console.warn('Preview display error:', err);
      }
      
      try {
        const fileSize = Number(sessionStorage.getItem('bgRemover:originalSize') || 0);
        const config = getProcessingConfig(fileSize);
        
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">${config.message}...</div>`;

        let resultUrl = null;
        let processingMethod = 'IMG.LY AI';

        // Route 1: Backend Processing (2+ MB files)
        if (config.useBackend) {
          statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">${config.info}</div>`;
          
          const backendResult = await processWithBackend(dataURL, config.backendUrl, config);
          
          if (backendResult.success) {
            resultUrl = backendResult.dataUrl;
            processingMethod = backendResult.processedWith || config.description;
            console.log('‚úÖ Backend processing successful:', {
              tier: config.tier,
              outputSize: backendResult.outputSizeMB || 'unknown'
            });
          } else {
            throw new Error(`Backend processing failed: ${backendResult.error}`);
          }
        }
        // Route 2: Browser processing with IMG.LY (0-2 MB)
        else {
          const libraryReady = await ensureLibraryLoaded();
          if (!libraryReady || !removeBackgroundFn) {
            showError('AI library not loaded. Please refresh the page and try again.');
            return;
          }

          // Preload model if needed
          if (!modelPreloaded && typeof preloadFn === 'function') {
            console.log('‚è≥ Preloading AI model...');
            statusMessage.innerHTML = '<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">‚è≥ Loading AI model (one-time, 30-45 sec)...</div>';
            try {
              await preloadFn({ 
                publicPath: 'https://staticimgly.com/@imgly/background-removal-data/1.7.0/dist/',
                model: config.model
              });
              modelPreloaded = true;
              console.log('‚úÖ AI model preloaded!');
            } catch (err) {
              console.warn('‚ö†Ô∏è Preload failed, will load during processing:', err);
            }
          }

          const blob = await blobFromSource(dataURL, {
            type: sessionStorage.getItem('bgRemover:originalType') || 'image/png',
            size: fileSize
          });
          
          if (!blob) throw new Error('Unable to read uploaded image.');
          
          const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'photo.png';
          const fileForProcessing = new File([blob], filename, { type: blob.type || 'image/png' });

          // Process with EXACT remove.bg quality settings
          const result = await removeBackgroundFn(fileForProcessing, {
            publicPath: 'https://staticimgly.com/@imgly/background-removal-data/1.7.0/dist/',
            model: 'medium',  // Remove.bg uses medium model for best quality/speed balance
            output: { 
              format: 'image/png', 
              quality: 1.0,  // Maximum quality like remove.bg
              type: 'foreground'
            },
            postprocessMask: {
              featherRadius: 0,    // Remove.bg uses 0 for sharp edges
              smooth: 0             // Remove.bg uses 0 for no smoothing
            },
            device: 'cpu',
            progress: (key, current, total) => {
              const percent = Math.round((current / total) * 100);
              statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">üé® Processing ${percent}%...</div>`;
            }
          });

          const resultBlob = result instanceof Blob ? result : await result.blob();
          resultUrl = await blobToDataURL(resultBlob);
        }
        
        if (!resultUrl) {
          throw new Error('Failed to generate result image');
        }
        
        // Store original high-quality result for download
        sessionStorage.setItem(STORAGE_KEYS.foreground, resultUrl);

        const foregroundImage = new Image();
        foregroundImage.crossOrigin = 'anonymous';
        foregroundImage.src = resultUrl;
        await foregroundImage.decode();

        // OPTIMIZE PREVIEW - Reduce size for display (max 800px width, compressed)
        const maxPreviewWidth = 800;
        const maxPreviewHeight = 600;
        let previewWidth = foregroundImage.width;
        let previewHeight = foregroundImage.height;
        
        // Calculate scale if image is too large
        if (previewWidth > maxPreviewWidth || previewHeight > maxPreviewHeight) {
          const scale = Math.min(maxPreviewWidth / previewWidth, maxPreviewHeight / previewHeight);
          previewWidth = Math.round(previewWidth * scale);
          previewHeight = Math.round(previewHeight * scale);
        }
        
        // Create optimized preview canvas
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = previewWidth;
        previewCanvas.height = previewHeight;
        const previewCtx = previewCanvas.getContext('2d');
        previewCtx.imageSmoothingEnabled = true;
        previewCtx.imageSmoothingQuality = 'high';
        previewCtx.drawImage(foregroundImage, 0, 0, previewWidth, previewHeight);
        
        // Compressed preview for display (reduces size significantly)
        const optimizedPreview = previewCanvas.toDataURL('image/png', 0.85);
        
        previewResult.hidden = false;
        previewResult.src = optimizedPreview; // Use optimized preview for display

        // Store full quality for download
        ensureCanvas(foregroundImage.width, foregroundImage.height);
        resultContext.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
        resultContext.drawImage(foregroundImage, 0, 0, resultCanvas.width, resultCanvas.height);
        resultDataURL = resultCanvas.toDataURL('image/png', 1.0); // Full quality for download

        sessionStorage.setItem(STORAGE_KEYS.dimensions, JSON.stringify({ width: resultCanvas.width, height: resultCanvas.height }));
        previewOverlay.style.opacity = 0;
        requestAnimationFrame(() => previewStage.classList.add('revealed'));
        backgroundChangeBtn.disabled = false;
        downloadBtn.disabled = false;
        
        // Add to gallery automatically after processing
        const imageInfo = await getImageInfo(resultDataURL);
        const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed.png';
        addToGallery(resultDataURL, filename, imageInfo);
        
        const sizeInMB = (fileSize / (1024 * 1024)).toFixed(1);
        const methodLabel = processingMethod || config.description;
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">‚úì Background removed! (${sizeInMB} MB processed with ${methodLabel})</div>`;
        setTimeout(() => clearStatus(), 4000);
        
      } catch (error) {
        console.error('Background removal failed', error);
        let errorMsg = 'Failed to remove background. ';
        if (error.message && error.message.includes('fetch')) {
          errorMsg += 'Network error. Please check your connection and try again.';
        } else if (error.message && error.message.includes('memory')) {
          errorMsg += 'Image too complex. Try a smaller or simpler image.';
        } else {
          errorMsg += error.message || 'Please try uploading a different image.';
        }
        showError(errorMsg);
        previewStage.classList.add('empty');
        previewOverlay.style.opacity = 0;
        previewPlaceholder.classList.remove('hidden');
      }
    }

    // Compress image to reduce size (for free users)
    async function compressImageForFree(dataURL, targetSizeKB = 500) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          const originalSize = Math.ceil((dataURL.split(',')[1].length * 0.75) / 1024);
          
          // If already under limit, return as is
          if (originalSize <= targetSizeKB) {
            resolve({ dataURL, width, height, size: originalSize * 1024 });
            return;
          }
          
          // Calculate scale to reduce size
          const scale = Math.sqrt(targetSizeKB / originalSize) * 0.9; // 90% to be safe
          width = Math.round(width * scale);
          height = Math.round(height * scale);
          
          // Ensure minimum dimensions
          if (width < 200) width = 200;
          if (height < 200) height = 200;
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // High quality resize
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to PNG with compression
          let compressedDataURL = canvas.toDataURL('image/png', 0.92);
          let compressedSize = Math.ceil((compressedDataURL.split(',')[1].length * 0.75) / 1024);
          
          // If still too large, reduce quality further
          if (compressedSize > targetSizeKB) {
            const quality = (targetSizeKB / compressedSize) * 0.9;
            compressedDataURL = canvas.toDataURL('image/png', Math.max(0.7, quality));
            compressedSize = Math.ceil((compressedDataURL.split(',')[1].length * 0.75) / 1024);
          }
          
          resolve({
            dataURL: compressedDataURL,
            width: width,
            height: height,
            size: compressedSize * 1024,
            compressed: true
          });
        };
        img.src = dataURL;
      });
    }

    // Get image dimensions and size info
    function getImageInfo(dataURL) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const base64Data = dataURL.split(',')[1];
          const size = Math.ceil(base64Data.length * 0.75);
          resolve({
            width: img.width,
            height: img.height,
            size: size,
            sizeMB: (size / (1024 * 1024)).toFixed(2),
            sizeKB: (size / 1024).toFixed(0)
          });
        };
        img.src = dataURL;
      });
    }

    // Check download size and subscription before download
    async function handleDownload() {
      if (!resultDataURL) {
        showError('No processed image available. Please wait for processing to complete.');
        return;
      }

      // Get original image info (size and dimensions)
      const originalInfo = await getImageInfo(resultDataURL);
      const originalSize = originalInfo.size;
      const originalSizeKB = parseInt(originalInfo.sizeKB);
      
      // Check if user is premium (must be logged in with active Pro plan)
      let isPremium = false;
      if (auth && currentUser) {
        if (!userSubscription) {
          userSubscription = await checkUserSubscription(currentUser);
        }
        // Only active Pro plan users are premium
        isPremium = userSubscription && 
                   (userSubscription.plan === 'premium' || userSubscription.plan === 'pro') && 
                   userSubscription.isValid;
      }
      
      // FIXED: If file is ‚â§ 500 KB, allow free download (no compression needed)
      if (originalSizeKB <= 500) {
        // Free download - direct (no compression)
        const link = document.createElement('a');
        const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed.png';
        link.href = resultDataURL;
        link.download = filename.endsWith('.png') ? filename : `${filename.replace(/\.[^/.]+$/, '') || 'background-removed'}.png`;
        link.click();
        
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">‚úì Downloaded (${originalInfo.sizeKB} KB, ${originalInfo.width}√ó${originalInfo.height}px)</div>`;
        setTimeout(() => clearStatus(), 4000);
        
        // Add to gallery
        addToGallery(resultDataURL, filename, originalInfo);
        return;
      }
      
      // File > 500 KB - Check premium status
      if (!isPremium) {
        // Not premium - show message and require Pro plan
        const message = `Download size: ${originalInfo.sizeKB} KB (${originalInfo.sizeMB} MB)\n` +
                       `Image dimensions: ${originalInfo.width} √ó ${originalInfo.height} pixels\n\n` +
                       `Free download limit: 500 KB\n` +
                       `Your file (${originalInfo.sizeKB} KB) exceeds the free limit.\n\n` +
                       `To download files larger than 500 KB, you need:\n` +
                       `‚Ä¢ Active Pro/Premium plan\n` +
                       `‚Ä¢ Must be logged in`;
        
        if (!auth || !currentUser) {
          // Not logged in
          if (confirm(message + '\n\nLogin now?')) {
            window.location.href = 'login.html';
          }
        } else {
          // Logged in but no active Pro plan
          if (confirm(message + '\n\nGo to pricing page to upgrade?')) {
            window.location.href = 'pricing.html';
          }
        }
        return;
      }
      
      // Premium user with active Pro plan - allow download
      // Show size options for premium users
      const message = `Download Options:\n\n` +
                     `Original: ${originalInfo.sizeKB} KB (${originalInfo.sizeMB} MB)\n` +
                     `Dimensions: ${originalInfo.width} √ó ${originalInfo.height} pixels\n\n` +
                     `Choose download option:`;
      
      const choice = confirm(message + '\n\nOK = Original Size\nCancel = Compressed (500 KB)');
      
      let downloadDataURL = resultDataURL;
      let downloadInfo = originalInfo;
      
      if (!choice) {
        // User wants compressed version
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">‚öôÔ∏è Compressing image...</div>`;
        const compressed = await compressImageForFree(resultDataURL, 500);
        downloadDataURL = compressed.dataURL;
        downloadInfo = {
          width: compressed.width,
          height: compressed.height,
          size: compressed.size,
          sizeKB: (compressed.size / 1024).toFixed(0),
          sizeMB: (compressed.size / (1024 * 1024)).toFixed(2)
        };
      }
      
      // Download selected version
      const link = document.createElement('a');
      const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed.png';
      const baseName = filename.replace(/\.[^/.]+$/, '') || 'background-removed';
      link.href = downloadDataURL;
      link.download = choice ? filename : `${baseName}-compressed.png`;
      link.click();
      
      statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">‚úì Downloaded (${downloadInfo.sizeKB} KB, ${downloadInfo.width}√ó${downloadInfo.height}px)</div>`;
      setTimeout(() => clearStatus(), 4000);
      
      // Add to gallery
      addToGallery(downloadDataURL, choice ? filename : `${baseName}-compressed.png`, downloadInfo);
    }

    // File Gallery Functions (like remove.bg)
    let processedFiles = [];
    
    function addToGallery(dataURL, filename, imageInfo) {
      const fileData = {
        id: Date.now(),
        dataURL: dataURL,
        filename: filename,
        info: imageInfo,
        timestamp: new Date()
      };
      
      processedFiles.push(fileData);
      updateGallery();
    }
    
    function updateGallery() {
      const gallery = document.getElementById('fileGallery');
      const container = document.getElementById('galleryContainer');
      
      if (processedFiles.length === 0) {
        gallery.style.display = 'none';
        return;
      }
      
      gallery.style.display = 'block';
      container.innerHTML = '';
      
      processedFiles.forEach((file, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'position: relative; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;';
        card.innerHTML = `
          <img src="${file.dataURL}" alt="${file.filename}" style="width: 100%; height: 80px; object-fit: cover;">
          <div style="padding: 8px; font-size: 0.75rem; color: #666;">
            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${file.filename.substring(0, 15)}${file.filename.length > 15 ? '...' : ''}</div>
            <div>${file.info.width}√ó${file.info.height}</div>
            <div>${file.info.sizeKB} KB</div>
          </div>
          <button class="gallery-download-btn" data-index="${index}" style="position: absolute; top: 4px; right: 4px; background: rgba(67,97,238,0.9); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.7rem;">
            <i class="fas fa-download"></i>
          </button>
        `;
        
        // Click to download
        card.querySelector('.gallery-download-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          await downloadFileWithCompression(file.dataURL, file.filename, file.info);
        });
        
        container.appendChild(card);
      });
    }
    
    async function downloadFileWithCompression(dataURL, filename, imageInfo) {
      // Check if user is premium
      let isPremium = false;
      if (auth && currentUser) {
        if (!userSubscription) {
          userSubscription = await checkUserSubscription(currentUser);
        }
        isPremium = userSubscription && userSubscription.isPremium && userSubscription.isValid;
      }
      
      const fileSize = imageInfo.size || Math.ceil((dataURL.split(',')[1].length * 0.75));
      
      // For free users: compress if exceeds limit
      if (!isPremium && fileSize > FREE_DOWNLOAD_LIMIT) {
        const compressed = await compressImageForFree(dataURL, 500);
        const baseName = filename.replace(/\.[^/.]+$/, '') || 'background-removed';
        const link = document.createElement('a');
        link.href = compressed.dataURL;
        link.download = `${baseName}-compressed.png`;
        link.click();
        return;
      }
      
      // For premium users or files under limit: direct download
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = filename.endsWith('.png') ? filename : `${filename.replace(/\.[^/.]+$/, '') || 'background-removed'}.png`;
      link.click();
    }

    // Add more files button handler
    document.getElementById('addMoreFiles').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/png,image/jpeg,image/jpg';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Check upload limit - ALWAYS enforce 10 MB limit regardless of auth state
        if (file.size > FREE_UPLOAD_LIMIT) {
          // If auth is available, check premium status
          if (auth && currentUser) {
            if (!userSubscription) {
              userSubscription = await checkUserSubscription(currentUser);
            }
            
            // Premium users can upload unlimited
            if (userSubscription && userSubscription.isPremium && userSubscription.isValid) {
              // Premium user - allow upload
            } else {
              // Not premium - show limit message
              const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
              if (confirm(`File size: ${sizeMB} MB\nFree upload limit: 10 MB\n\nYou need Premium subscription for files larger than 10 MB. Go to pricing page?`)) {
                window.location.href = 'pricing.html';
              }
              return;
            }
          } else {
            // No auth or not logged in - enforce limit
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            if (confirm(`File size: ${sizeMB} MB\nFree upload limit: 10 MB\n\nUpgrade to Premium for unlimited uploads. Go to pricing page?`)) {
              window.location.href = 'pricing.html';
            }
            return;
          }
        }
        
        // Process new file
        const dataURL = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        sessionStorage.setItem(STORAGE_KEYS.original, dataURL);
        sessionStorage.setItem(STORAGE_KEYS.filename, file.name || 'photo.png');
        sessionStorage.setItem('bgRemover:originalType', file.type);
        sessionStorage.setItem('bgRemover:originalSize', file.size.toString());
        sessionStorage.removeItem('bgRemover:foreground');
        sessionStorage.removeItem('bgRemover:dimensions');
        
        // Reload to process new file
        window.location.reload();
      };
      input.click();
    });

    // Initialize gallery
    updateGallery();
    
    // Initialize
    const storedOriginal = sessionStorage.getItem(STORAGE_KEYS.original);
    if (!storedOriginal) {
      previewStage.classList.add('empty');
      previewPlaceholder.classList.remove('hidden');
      showError('No image found. Please upload a file first.');
      backgroundChangeBtn.disabled = true;
      downloadBtn.disabled = true;
    } else {
      processImage(storedOriginal);
    }

    backgroundChangeBtn.addEventListener('click', () => {
      if (backgroundChangeBtn.disabled) return;
      window.location.href = 'background-style.html';
    });

    downloadBtn.addEventListener('click', handleDownload);

    document.getElementById('footerYear').textContent = new Date().getFullYear();
  </script>
<footer>
<div class="container footer-inner">
<div class="footer-company-links">
<span>Company</span>
<a href="index.html#about">About Us</a>
<a href="index.html#contact">Contact</a>
<a href="privacy-policy.html">Privacy Policy</a>
<a href="terms-of-service.html">Terms of Service</a>
</div>
<p class="footer-brand-line">¬© easyjpgtopdf ‚Äî Free PDF &amp; Image Tools for everyone.</p>
<p class="footer-credits">
                Thanks to Font Awesome, Google Fonts, jsPDF, pdf.js, pdf-lib, Mammoth, Tesseract.js, IMG.LY, Firebase, Unsplash photographers, and every open-source contributor powering this site.
                <a href="attributions.html">See full acknowledgements</a>.
            </p>
</div>
</footer>
<script type="module">
  const isLocalFileProtocol = window.location.protocol === 'file:';
  if (isLocalFileProtocol) {
    console.warn('‚ö†Ô∏è auth.js skipped on file:// protocol to avoid CORS errors.');
  } else {
    import('./js/auth.js').catch(err => {
      console.error('‚ùå Failed to load auth.js:', err);
    });
  }
</script>
</body>
</html>