<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Background Removal Workspace - Edit & Download Transparent Images | easyjpgtopdf</title>
    <meta name="description" content="Background removal workspace. Edit and download transparent PNG images. Remove background from image online. Free AI background remover tool with instant processing.">
    <meta name="keywords" content="background removal workspace, remove background, transparent image, background remover, remove image background, ai background remover, transparent png, background removal tool, free background remover">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Background Removal Workspace - Edit & Download Transparent Images">
    <meta property="og:description" content="Edit and download transparent PNG images. Remove background from image online with AI.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://easyjpgtopdf.com/background-workspace.html">
<link href="css/footer.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script type="importmap">
    {
      "imports": {
        "onnxruntime-web": "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.21.0/dist/ort.min.mjs"
      }
    }
  </script>
<style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --dark: #212529;
      --muted: #7a7f8c;
      --surface: #ffffff;
      --border: rgba(18, 20, 58, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(180deg, #f3f4ff 0%, #f8f9ff 100%); color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--surface); box-shadow: 0 12px 30px rgba(14, 32, 86, 0.1); position: sticky; top: 0; z-index: 20; }
    .topbar .inner { max-width: 1200px; margin: 0 auto; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; gap: 18px; }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 700; font-size: 20px; color: var(--primary); text-decoration: none; }
    .quick-links { display: flex; gap: 10px; flex-wrap: wrap; }
    .quick-links a { text-decoration: none; padding: 8px 16px; border-radius: 999px; border: 1px solid var(--border); color: #253156; font-weight: 600; background: rgba(67, 97, 238, 0.08); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
    .quick-links a:hover { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; transform: translateY(-1px); box-shadow: 0 12px 24px rgba(67, 97, 238, 0.2); }
    main { flex: 1; width: 100%; max-width: 1200px; margin: 36px auto; padding: 0 24px 48px; display: grid; grid-template-columns: 1fr 40%; gap: 32px; align-items: start; }
    .panel { background: var(--surface); border-radius: 24px; padding: 28px; box-shadow: 0 20px 45px rgba(15, 30, 70, 0.08); }
    .panel h2 { font-size: 1.35rem; margin-bottom: 18px; display: flex; gap: 12px; align-items: center; color: #171f4d; }
    .preview-stage { position: relative; width: 8.5cm; height: 6cm; max-width: 100%; max-height: 100%; margin: 0 auto; border-radius: 18px; background: repeating-conic-gradient(#e5e9ff 0deg 25deg, #f8f9ff 25deg 50deg); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .preview-original, .preview-result { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; transition: opacity 0.6s ease; }
    .preview-result { opacity: 0; }
    .preview-stage.revealed .preview-result { opacity: 1; }
    .preview-stage.revealed .preview-original { opacity: 0; }
    .preview-overlay { position: absolute; inset: 0; background: rgba(17, 24, 39, 0.55); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: #fff; font-weight: 600; letter-spacing: 0.03em; transition: opacity 0.4s ease; }
    .preview-stage.revealed .preview-overlay { opacity: 0; pointer-events: none; }
    .preview-stage.empty .preview-overlay { display: none; }
    .preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; text-align: center; color: var(--muted); font-weight: 600; letter-spacing: 0.03em; }
    .preview-placeholder.hidden { display: none; }
    .preview-spinner { width: 34px; height: 34px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .actions { margin-top: 24px; display: flex; flex-wrap: wrap; gap: 14px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 22px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.25); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: #233050; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .status-card { display: flex; flex-direction: column; gap: 18px; color: var(--muted); font-size: 0.95rem; line-height: 1.6; }
    .status-card strong { color: #1e254d; font-size: 1.05rem; }
    footer { text-align: center; padding: 24px 16px 40px; font-size: 0.85rem; color: var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
      .actions { justify-content: center; }
    }
  </style>
<link href="css/header.css" rel="stylesheet"/>
<link href="css/theme-modern.css" rel="stylesheet"/>
</head>
<body>
<header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo"><img src="images/logo.png" alt="Logo" style="height:54px;"></a>
                <div class="nav-links">
                    <div class="dropdown">
                        <a href="#">Convert to PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="jpg-to-pdf.html">JPG to PDF</a>
                            <a href="word-to-pdf.html">Word to PDF</a>
                            <a href="excel-to-pdf.html">Excel to PDF</a>
                            <a href="ppt-to-pdf.html">PowerPoint to PDF</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Convert from PDF <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pdf-to-jpg.html">PDF to JPG</a>
                            <a href="pdf-to-word.html">PDF to Word</a>
                            <a href="pdf-to-excel.html">PDF to Excel</a>
                            <a href="pdf-to-ppt.html">PDF to PowerPoint</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Pdf Editor <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="merge-pdf.html">Merge PDF</a>
                            <a href="split-pdf.html">Split PDF</a>
                            <a href="compress-pdf.html">Compress PDF</a>
                            <a href="edit-pdf.html">Pdf Editor</a>
                            <a href="protect-pdf.html">Protect PDF</a>
                            <a href="unlock-pdf.html">Unlock PDF</a>
                            <a href="watermark-pdf.html">Watermark PDF</a>
                            <a href="crop-pdf.html">Crop PDF</a>
                            <a href="add-page-numbers.html">Add Page Numbers</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Image Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="image-repair.html">AI Image Repair</a>
                            <a href="image-compressor.html">Image Compressor</a>
                            <a href="image-resizer.html">Image Resizer</a>
                            <a href="image-editor.html">Image Editor</a>
                            <a href="background-remover.html">Image Background Remover</a>
                            <a href="ocr-image.html">OCR Image</a>
                            <a href="image-watermark.html">Image Watermark Tool</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">Other Tools <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="resume-maker.html">Resume Maker</a>
                            <a href="biodata-maker.html">Marrige Biodata-Data Maker</a>
                            <a href="ai-image-generator.html">AI Image Generator</a>
                            <a href="marriage-card.html">Marriage Card</a>
                            <a href="excel-unlocker/" target="_blank">Excel Unlocker</a>
                            <a href="protect-excel.html">Protect Excel Sheet</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#">More <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="pricing.html">Pricing</a>
                            <a href="blog.html">Blog/Articles</a>
                        </div>
                    </div>
                </div>
                
                <div id="user-menu" class="user-menu" data-open="false">
                    <button id="user-menu-toggle" class="user-menu-toggle" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Account menu">
                        <span class="user-initial" aria-hidden="true">U</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown" hidden>
                        <a href="dashboard.html#dashboard-overview" data-user-nav="dashboard-overview"><i class="fas fa-user-circle"></i> Account Dashboard</a>
                        <a href="dashboard.html#dashboard-billing" data-user-nav="dashboard-billing"><i class="fas fa-file-invoice"></i> Billing Details</a>
                        <a href="dashboard.html#dashboard-payments" data-user-nav="dashboard-payments"><i class="fas fa-wallet"></i> Payment History</a>
                        <a href="dashboard.html#dashboard-orders" data-user-nav="dashboard-orders"><i class="fas fa-clipboard-list"></i> Orders &amp; Subscriptions</a>
                        <a href="accounts.html#login"><i class="fas fa-user-cog"></i> Account Center</a>
                        <button type="button" id="logout-button" class="dropdown-logout"><i class="fas fa-sign-out-alt"></i> Sign out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <nav aria-label="Breadcrumb" style="padding: 15px 0; background: #f8f9ff; border-bottom: 1px solid #e2e6ff;">
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
            <ol style="list-style: none; display: flex; flex-wrap: wrap; gap: 10px; margin: 0; padding: 0; align-items: center;">
                <li><a href="index.html" style="color: #4361ee; text-decoration: none; font-weight: 500; transition: color 0.3s;" onmouseover="this.style.color='#3a0ca3'" onmouseout="this.style.color='#4361ee'">Home</a></li>
                <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
                <li><a href="login.html" style="color: #56607a; font-weight: 500; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#4361ee'" onmouseout="this.style.color='#56607a'">Sign In</a></li>
                <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
                <li><a href="signup.html" style="color: #56607a; font-weight: 500; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#4361ee'" onmouseout="this.style.color='#56607a'">Signup</a></li>
            </ol>
        </div>
    </nav>
<main>
<section class="panel">
<h1>Free AI Background Remover - Remove Background from Image</h1>
<div class="preview-stage" id="previewStage">
<img alt="Original" class="preview-original" hidden="" id="previewOriginal"/>
<img alt="Result" class="preview-result" hidden="" id="previewResult"/>
<div class="preview-overlay" id="previewOverlay">
<div class="preview-spinner"></div>
<span>AI Processing...</span>
</div>
<div class="preview-placeholder hidden" id="previewPlaceholder">
<i class="fas fa-image" style="font-size:3rem;opacity:0.3;"></i>
<span>No image loaded</span>
</div>
</div>
<div class="actions">
<button class="btn btn-outline" disabled="" id="backgroundChange">
<i class="fas fa-palette"></i> Change Background
        </button>
<button class="btn btn-outline" disabled="" id="downloadPng">
<i class="fas fa-download"></i> Download Free (512px)
        </button>
<button class="btn btn-primary" disabled="" id="downloadPremium">
<i class="fas fa-crown"></i> Download Premium HD
        </button>
<button class="btn btn-primary" id="newUploadBtn" style="margin-left: 8px;">
<i class="fas fa-plus"></i> New Upload
        </button>
</div>
</section>
<section class="panel">
<h2>Processing Information</h2>
<div class="status-card" id="statusMessage"></div>
<!-- Animated Demo -->
<div style="margin: 16px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(67,97,238,0.15);">
<img alt="AI Processing Demo" src="images/bg-removal-jungle-demo.svg" style="width: 100%; height: auto; display: block;"/>
</div>
<div class="status-card">
<strong>? Professional AI Processing</strong>
<p>ï¿½ Fast and accurate background removal</p>
<p>ï¿½ Automatic processing for optimal results</p>
<p>ï¿½ Professional quality output</p>
<p>ï¿½ Unlimited uploads and downloads</p>
<p>ï¿½ High-quality transparent PNG output</p>
</div>
</section>
</main>
<script type="module">
    const STORAGE_KEYS = {
      original: 'bgRemover:original',
      filename: 'bgRemover:filename',
      foreground: 'bgRemover:foreground',
      dimensions: 'bgRemover:dimensions'
    };

    const previewStage = document.getElementById('previewStage');
    const previewOriginal = document.getElementById('previewOriginal');
    const previewResult = document.getElementById('previewResult');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const backgroundChangeBtn = document.getElementById('backgroundChange');
    const downloadBtn = document.getElementById('downloadPng');
    const downloadPremiumBtn = document.getElementById('downloadPremium');
    const statusMessage = document.getElementById('statusMessage');

    let resultCanvas = null;
    let resultContext = null;
    let resultDataURL = null;
    
    // IMG.LY library REMOVED - Using backend only for best quality

    function dataURLToBlob(dataURL) {
      const [meta, encoded] = dataURL.split(',');
      const mimeMatch = meta.match(/data:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/png';
      const binary = atob(encoded);
      const len = binary.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) buffer[i] = binary.charCodeAt(i);
      return new Blob([buffer], { type: mime });
    }

    async function blobFromSource(source, meta) {
      if (!source) return null;
      if (source.startsWith('data:')) {
        return dataURLToBlob(source);
      }
      if (source.startsWith('blob:')) {
        return await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', source);
          xhr.responseType = 'blob';
          xhr.onload = () => {
            const responseBlob = xhr.response;
            if (responseBlob && meta?.type && responseBlob.type !== meta.type) {
              resolve(responseBlob.slice(0, responseBlob.size, meta.type));
            } else {
              resolve(responseBlob);
            }
          };
          xhr.onerror = () => reject(new Error('Failed to read blob URL.'));
          xhr.send();
        });
      }
      const response = await fetch(source);
      return await response.blob();
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function showError(message) {
      statusMessage.innerHTML = `<div style="padding:16px;border-radius:14px;background:rgba(220,38,38,0.12);color:#7f1d1d;font-weight:600;">${message}</div>`;
    }

    function showStatus(message) {
      statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">${message}</div>`;
      setTimeout(() => {
        if (statusMessage.textContent?.includes(message)) {
          clearStatus();
        }
      }, 3000);
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    function ensureCanvas(width, height) {
      if (!resultCanvas) {
        resultCanvas = document.createElement('canvas');
        resultContext = resultCanvas.getContext('2d');
      }
      resultCanvas.width = width;
      resultCanvas.height = height;
    }

    // ============================================
    // HIGH QUALITY AI BACKGROUND REMOVER
    // Professional AI Processing System
    // ============================================
    // Use proxy endpoint for processing
    // ============================================
    
    // Device Fingerprinting
    function generateDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + 'x' + screen.height,
          new Date().getTimezoneOffset(),
          canvas.toDataURL()
        ].join('|');
        
        deviceId = btoa(fingerprint).substring(0, 32);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    }
    
    const DEVICE_ID = generateDeviceId();
    
    // Get user info (from auth or session)
    async function getUserInfo() {
      try {
        // Import Firebase app and getAuth
        const { app } = await import('./js/firebase-init.js').catch(() => ({}));
        if (!app) {
          throw new Error('Firebase app not initialized');
        }
        
        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
        const auth = getAuth(app);
        
        if (!auth) {
          throw new Error('Firebase auth not available');
        }
        
        // Check if user is already authenticated
        if (auth.currentUser) {
          try {
            const token = await auth.currentUser.getIdToken();
            console.log('âœ… User authenticated:', auth.currentUser.uid);
            return {
              userId: auth.currentUser.uid,
              userType: 'premium',
              authToken: token
            };
          } catch (tokenError) {
            console.warn('Failed to get token:', tokenError);
          }
        }
        
        // Wait for auth state to be ready (async check)
        // Use a promise that resolves when auth state is known
        return new Promise((resolve) => {
          let resolved = false;
          let unsubscribeFn = null;
          
          const timeout = setTimeout(() => {
            if (!resolved) {
              resolved = true;
              if (unsubscribeFn) unsubscribeFn();
              resolve({
                userId: 'anonymous',
                userType: 'free',
                authToken: null
              });
            }
          }, 1000); // 1 second timeout
          
          unsubscribeFn = auth.onAuthStateChanged(async (user) => {
            if (resolved) return;
            
            clearTimeout(timeout);
            resolved = true;
            if (unsubscribeFn) unsubscribeFn();
            
            if (user) {
              try {
                const token = await user.getIdToken();
                console.log('âœ… User authenticated (from onAuthStateChanged):', user.uid);
                resolve({
                  userId: user.uid,
                  userType: 'premium',
                  authToken: token
                });
              } catch (tokenError) {
                console.warn('Failed to get token:', tokenError);
                resolve({
                  userId: 'anonymous',
                  userType: 'free',
                  authToken: null
                });
              }
            } else {
              resolve({
                userId: 'anonymous',
                userType: 'free',
                authToken: null
              });
            }
          });
        });
        
      } catch (e) {
        console.warn('Auth check failed:', e);
        // Fallback to free user
        return {
          userId: 'anonymous',
          userType: 'free',
          authToken: null
        };
      }
    }
    
    // Check user's credit balance
    async function checkCreditBalance(userInfo) {
      try {
        if (!userInfo.userId || userInfo.userId === 'anonymous' || !userInfo.authToken) {
          return { success: false, credits: 0, unlimited: false };
        }
        
        const API_BASE_URL = window.location.origin;
        const response = await fetch(`${API_BASE_URL}/api/credits/balance?userId=${userInfo.userId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${userInfo.authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          console.warn('Failed to check credit balance:', response.status);
          return { success: false, credits: 0, unlimited: false };
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            success: true,
            credits: data.credits || 0,
            unlimited: data.unlimited || false
          };
        }
        
        return { success: false, credits: 0, unlimited: false };
      } catch (error) {
        console.error('Error checking credit balance:', error);
        return { success: false, credits: 0, unlimited: false };
      }
    }
    
    // API Configuration - Using BiRefNet GPU backend
    const PROXY_API_URL = '/api/background-remove-birefnet';
    const PROXY_HEALTH_URL = '/api/background-remove-birefnet/health';
    const PROXY_USAGE_URL = '/api/background-remove-birefnet/usage';
    const API_VERSION = 'birefnet-gpu-1.0'; // Cache busting version
    
    // Test backend connection on load (using proxy to avoid CORS)
    async function testBackendConnection() {
      try {
        const userInfo = await getUserInfo();
        const response = await fetch(PROXY_HEALTH_URL, {
          method: 'GET',
          headers: { 
            'Accept': 'application/json',
            'X-User-ID': userInfo.userId,
            'X-User-Type': userInfo.userType,
            'X-Device-ID': DEVICE_ID
          }
        });
        if (response.ok) {
          const data = await response.json();
          console.log('? Backend Connected:', data);
          console.log('? Using AI model:', data.model || 'default');
          return true;
        } else {
          console.warn('?? Backend health check failed:', response.status);
        }
      } catch (error) {
        console.warn('?? Backend health check failed:', error.message);
        console.log('?? Backend will be tested on first request.');
      }
      return false;
    }
    
    // Test connection immediately
    testBackendConnection();
    
    // All processing uses backend (through proxy)
    function getProcessingConfig(fileSize) {
      const sizeMB = fileSize / (1024 * 1024);
      
      // All files processed via backend (through proxy)
      return {
        useBackend: true,
        backendUrl: PROXY_API_URL,
        timeout: 300000,
        description: 'AI Background Removal',
        message: `Processing ${sizeMB.toFixed(1)} MB with AI`,
        tier: 'ai',
        info: '?? AI Processing',
        quality: 1.0
      };
    }

    // Process image using backend (through proxy)
    async function processWithBackend(dataURL, backendUrl, config) {
      try {
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">?? Uploading for AI processing...</div>`;
        
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 180000);
        
        // Log request details for debugging
        const imageSize = Math.ceil((dataURL.split(',')[1]?.length || 0) * 0.75 / 1024);
        console.log('?? Sending request to:', PROXY_API_URL, '(Version:', API_VERSION + ')');
        console.log('?? Image size:', imageSize, 'KB');
        console.log('?? Data URL length:', dataURL.length);
        
        // Use JSON format (proxy handles conversion)
        let response = null;
        
        try {
        // Get user info and device ID
        const userInfo = await getUserInfo();
        
          response = await fetch('/api/background-remove-birefnet', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-User-ID': userInfo.userId,
              'X-User-Type': userInfo.userType,
              'X-Device-ID': DEVICE_ID,
              'X-Auth-Token': userInfo.authToken || ''
            },
            body: JSON.stringify({ imageData: dataURL }),
            signal: controller.signal
          });
          
          console.log('?? Response received:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
          });
        } catch (fetchError) {
          console.error('? Request failed:', {
            name: fetchError.name,
            message: fetchError.message,
            stack: fetchError.stack
          });
          throw fetchError;
        }
        
        clearTimeout(timeout);

        // Check response status
        if (!response || !response.ok) {
          // If we have a response but it's not OK, handle the error
          if (response && !response.ok) {
            const errorText = await response.text();
            let errorData = {};
            try {
              errorData = JSON.parse(errorText);
            } catch (e) {
              errorData = { error: errorText || `Server error: ${response.status}` };
            }
            console.error('? Server error:', {
              status: response.status,
              statusText: response.statusText,
              error: errorData
            });
            throw new Error(errorData.error || `Server error: ${response.status} ${response.statusText}`);
          } else {
            throw new Error('No response from server. Please check your connection.');
          }
        }

        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">? Processing with professional AI...</div>`;
        
        const result = await response.json();
        console.log('? Processing result:', {
          success: result.success,
          hasResultImage: !!result.resultImage,
          outputSize: result.outputSizeMB || 'unknown'
        });
        
        if (result.success && result.resultImage) {
          return { 
            success: true, 
            dataUrl: result.resultImage, 
            processedWith: result.processedWith || config.description,
            outputSize: result.outputSize,
            outputSizeMB: result.outputSizeMB
          };
        } else {
          throw new Error(result.error || 'Processing failed on server');
        }
      } catch (error) {
        console.error('? Backend processing error:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        if (error.name === 'AbortError') {
          return { 
            success: false, 
            error: 'Request timeout. The file may be too large or the server is busy. Please try again or use a smaller image.' 
          };
        }
        
        // Provide more specific error messages - NO FALLBACK
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          return { 
            success: false, 
            error: 'Network error. Please check your internet connection and try again. If the problem persists, the server may be temporarily unavailable. Backend processing is required - no fallback available.' 
          };
        }
        
        // Check if error message contains service unavailable info
        let errorMessage = error.message || 'Backend processing failed. Please try again.';
        
        // Extract nested error messages from proxy responses
        if (errorMessage.includes('service is temporarily unavailable')) {
          errorMessage = 'Service is warming up. Please wait 15-20 seconds and try again. The service is configured to stay warm, but first request may take longer.';
        } else if (errorMessage.includes('cold starting') || errorMessage.includes('warming up')) {
          errorMessage = 'Service is warming up. Please wait 15-20 seconds and try again.';
        }
        
        return { 
          success: false, 
          error: `Backend processing failed: ${errorMessage}. Please try again or contact support.` 
        };
      }
    }

    async function processImage(dataURL) {
      clearStatus();
      previewPlaceholder.classList.add('hidden');
      previewStage.classList.remove('revealed');
      previewStage.classList.remove('empty');

      try {
        // Ensure image element is visible (should already be loaded from initializePage)
        previewOriginal.hidden = false;
        
        // Verify image is loaded
        if (!previewOriginal.complete || previewOriginal.naturalWidth === 0) {
          // If image not loaded, wait for it
          await new Promise((resolve, reject) => {
            previewOriginal.onload = resolve;
            previewOriginal.onerror = () => reject(new Error('Failed to load image'));
            previewOriginal.src = dataURL;
            
            // Check if already loaded
            if (previewOriginal.complete && previewOriginal.naturalWidth > 0) {
              resolve();
            }
          });
        }
        
        // Get file size and optimal config
        const fileSize = Number(sessionStorage.getItem('bgRemover:originalSize') || 0);
        const config = getProcessingConfig(fileSize);
        
        // Check for error (file too large)
        if (config.error) {
          showError(config.message);
          previewStage.classList.add('empty');
          previewOverlay.style.opacity = 0;
          previewPlaceholder.classList.remove('hidden');
          return;
        }
        
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">${config.message}...</div>`;
        
        // Show overlay with processing message
        previewOverlay.style.opacity = 1;

        let resultUrl = null;
        let processingMethod = 'Browser AI';

        // ===== All Processing via Backend =====
        if (config.useBackend) {
          statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">${config.info}</div>`;
          
          // Automatic retry logic for cold starts (optimized)
          let backendResult = null;
          let lastError = null;
          const maxRetries = 1; // Reduced retries
          const retryDelay = 5000; // Reduced to 5 seconds (faster recovery)
          
          for (let attempt = 0; attempt <= maxRetries; attempt++) {
            try {
              if (attempt > 0) {
                console.log(`?? Retry attempt ${attempt}/${maxRetries} after ${retryDelay/1000}s delay...`);
                statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(251,146,60,0.12);color:#7c2d12;font-weight:600;">? Service warming up... Retrying in ${retryDelay/1000} seconds (attempt ${attempt + 1}/${maxRetries + 1})...</div>`;
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">${config.info} (Retry ${attempt + 1})...</div>`;
              }
              
              backendResult = await processWithBackend(dataURL, config.backendUrl, config);
              
              if (backendResult.success) {
                // Success - break retry loop
                break;
              } else {
                // Check if it's a retryable error
                const errorMsg = backendResult.error || 'Processing failed';
                const isRetryable = errorMsg.includes('temporarily unavailable') || 
                                  errorMsg.includes('cold starting') || 
                                  errorMsg.includes('warming up') ||
                                  errorMsg.includes('Service Unavailable');
                
                if (isRetryable && attempt < maxRetries) {
                  console.log(`?? Retryable error detected, will retry: ${errorMsg}`);
                  lastError = errorMsg;
                  continue; // Retry
                } else {
                  // Not retryable or last attempt
                  throw new Error(errorMsg);
                }
              }
            } catch (error) {
              const errorMsg = error.message || 'Unknown error';
              const isRetryable = errorMsg.includes('temporarily unavailable') || 
                                errorMsg.includes('cold starting') || 
                                errorMsg.includes('warming up') ||
                                errorMsg.includes('Service Unavailable');
              
              if (isRetryable && attempt < maxRetries) {
                console.log(`?? Retryable error detected, will retry: ${errorMsg}`);
                lastError = errorMsg;
                continue; // Retry
              } else {
                // Not retryable or last attempt - throw error
                throw error;
              }
            }
          }
          
          if (backendResult && backendResult.success) {
            resultUrl = backendResult.dataUrl;
            processingMethod = backendResult.processedWith || config.description;
            
            // Log success
            console.log('? Processing successful:', {
              tier: config.tier,
              outputSize: backendResult.outputSizeMB || 'unknown'
            });
          } else {
            // All retries failed
            const errorMsg = lastError || backendResult?.error || 'Processing failed';
            throw new Error(errorMsg);
          }
        }

        // IMG.LY fallback REMOVED - Backend only for best quality
        // If backend fails, show clear error (no fallback)
        if (!resultUrl) {
          throw new Error('Backend processing failed. Please try again or contact support if the issue persists.');
        }
        
        sessionStorage.setItem(STORAGE_KEYS.foreground, resultUrl);

        const foregroundImage = new Image();
        foregroundImage.crossOrigin = 'anonymous';
        foregroundImage.src = resultUrl;
        await foregroundImage.decode();

        previewResult.hidden = false;
        previewResult.src = resultUrl;

        ensureCanvas(foregroundImage.width, foregroundImage.height);
        resultContext.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
        resultContext.drawImage(foregroundImage, 0, 0, resultCanvas.width, resultCanvas.height);
        resultDataURL = resultCanvas.toDataURL('image/png');

        sessionStorage.setItem(STORAGE_KEYS.dimensions, JSON.stringify({ width: resultCanvas.width, height: resultCanvas.height }));
        previewOverlay.style.opacity = 0;
        requestAnimationFrame(() => previewStage.classList.add('revealed'));
        backgroundChangeBtn.disabled = false;
        downloadBtn.disabled = false;
        downloadPremiumBtn.disabled = false;
        
        // Success message
        const sizeInMB = (fileSize / (1024 * 1024)).toFixed(1);
        const methodLabel = processingMethod || config.description;
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">? Background removed! (${sizeInMB} MB file processed with ${methodLabel})</div>`;
        setTimeout(() => clearStatus(), 4000);
        
      } catch (error) {
        console.error('Background removal failed', error);
        let errorMsg = '';
        
        // Extract error message from error object
        const errorMessage = error.message || error.error || 'Unknown error';
        
        // Handle different error types
        if (errorMessage.includes('fetch') || errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch')) {
          errorMsg = 'Network error. Please check your internet connection and try again.';
        } else if (errorMessage.includes('timeout') || errorMessage.includes('AbortError')) {
          errorMsg = 'Request timeout. The image may be too large or the server is busy. Please try again with a smaller image.';
        } else if (errorMessage.includes('memory') || errorMessage.includes('too large')) {
          errorMsg = 'Image too large or complex. Please try a smaller image (max 10MB).';
        } else if (errorMessage.includes('Processing failed') || errorMessage.includes('Internal server error')) {
          errorMsg = 'Processing failed. Please try again with a different image. If the problem persists, the service may be temporarily unavailable.';
        } else if (errorMessage.includes('temporarily unavailable') || errorMessage.includes('warming up')) {
          errorMsg = 'Service is warming up. Please wait 15-20 seconds and try again.';
        } else if (errorMessage.includes('Invalid image') || errorMessage.includes('Failed to load image')) {
          errorMsg = 'Invalid image file. Please ensure you are uploading a valid image (JPG, PNG, etc.).';
        } else {
          // Use the actual error message if available
          errorMsg = errorMessage || 'Failed to remove background. Please try again.';
        }
        
        showError(errorMsg);
        previewStage.classList.add('empty');
        previewOverlay.style.opacity = 0;
        previewPlaceholder.classList.remove('hidden');
      }
    }

    // Warmup request every 5 minutes to keep service warm (more frequent)
    setInterval(async () => {
      try {
        // Use health endpoint for warmup
        await fetch('/api/background-remove-birefnet/health', { 
          method: 'GET',
          cache: 'no-cache'
        });
        console.log('âœ… Warmup request sent (5 min interval)');
      } catch (error) {
        console.warn('âš ï¸ Warmup request failed:', error);
      }
    }, 5 * 60 * 1000); // 5 minutes (reduced from 10)
    
    // Initial warmup on page load (faster)
    setTimeout(async () => {
      try {
        await fetch('/api/background-remove-birefnet/health', { 
          method: 'GET',
          cache: 'no-cache'
        });
        console.log('âœ… Initial warmup request sent');
      } catch (error) {
        console.warn('âš ï¸ Initial warmup request failed:', error);
      }
    }, 1000); // Reduced from 2 seconds // 2 seconds after page load
    
    // Initialize page - load image from sessionStorage
    async function initializePage() {
      const storedOriginal = sessionStorage.getItem(STORAGE_KEYS.original);
      if (!storedOriginal) {
        previewStage.classList.add('empty');
        previewPlaceholder.classList.remove('hidden');
        showError('No image found. Please upload a file first.');
        backgroundChangeBtn.disabled = true;
        downloadBtn.disabled = true;
        downloadPremiumBtn.disabled = true;
      } else {
        // First, show the image preview
        try {
          previewOriginal.hidden = false;
          previewStage.classList.remove('empty');
          previewPlaceholder.classList.add('hidden');
          
          // Load and display the image
          await new Promise((resolve, reject) => {
            previewOriginal.onload = () => {
              console.log('âœ… Preview image loaded from sessionStorage');
              previewOverlay.style.opacity = 0; // Hide overlay initially to show preview
              resolve();
            };
            previewOriginal.onerror = (error) => {
              console.error('âŒ Failed to load preview image:', error);
              reject(new Error('Failed to load image preview'));
            };
            previewOriginal.src = storedOriginal;
            
            // If already loaded (cached)
            if (previewOriginal.complete && previewOriginal.naturalWidth > 0) {
              previewOverlay.style.opacity = 0;
              resolve();
            }
          });
          
          // Then start processing
          processImage(storedOriginal);
        } catch (error) {
          console.error('Error initializing page:', error);
          showError('Failed to load image. Please upload again.');
          previewStage.classList.add('empty');
          previewPlaceholder.classList.remove('hidden');
        }
      }
    }
    
    // Initialize when page loads
    initializePage();

    backgroundChangeBtn.addEventListener('click', () => {
      if (backgroundChangeBtn.disabled) return;
      window.location.href = 'background-style.html';
    });

    downloadBtn.addEventListener('click', () => {
      if (!resultDataURL) return;
      
      try {
        // Download free version (512px)
        const link = document.createElement('a');
        const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed.png';
        link.href = resultDataURL;
        link.download = filename.endsWith('.png') ? filename : `${filename.replace(/\.[^/.]+$/, '') || 'background-removed'}.png`;
        link.click();
        
        // Show success message
        showStatus('Downloaded successfully (Free 512px).');
      } catch (error) {
        console.error('Download error:', error);
        showError('Download failed. Please try again.');
      }
    });

    // Premium Download Handler with Auth Check and Credit Deduction
    downloadPremiumBtn.addEventListener('click', async () => {
      if (!resultDataURL) return;
      
      try {
        // Check if user is logged in
        const userInfo = await getUserInfo();
        
        if (!userInfo.userId || userInfo.userId === 'anonymous' || !userInfo.authToken) {
          // User not logged in - redirect to sign-in
          try {
            // Import setPendingAction from auth.js
            const authModule = await import('./js/auth.js');
            if (authModule && authModule.setPendingAction) {
              const currentUrl = window.location.href;
              authModule.setPendingAction({
                type: 'premium-download',
                redirectTo: currentUrl,
                payload: {
                  action: 'premium-download'
                }
              });
              
              // Redirect to login page
              window.location.href = 'login.html?redirect=' + encodeURIComponent(currentUrl);
              return;
            }
          } catch (importError) {
            console.error('Failed to import auth module:', importError);
          }
          
          // Fallback: direct redirect to login
          const currentUrl = window.location.href;
          window.location.href = 'login.html?redirect=' + encodeURIComponent(currentUrl);
          return;
        }
        
        // User is logged in - proceed with premium download
        await downloadPremiumHD(userInfo);
        
      } catch (error) {
        console.error('Premium download error:', error);
        showError('Premium download failed. Please try again.');
      }
    });
    
    // Premium HD Download Function with Credit Deduction
    async function downloadPremiumHD(userInfo) {
      try {
        downloadPremiumBtn.disabled = true;
        
        // First check credit balance
        const creditCheck = await checkCreditBalance(userInfo);
        const CREDITS_REQUIRED = 1;
        
        if (!creditCheck.unlimited && creditCheck.credits < CREDITS_REQUIRED) {
          downloadPremiumBtn.disabled = false;
          const creditMessage = creditCheck.credits === 0 
            ? 'You need 1 credit for Premium HD download. Please purchase credits.'
            : `You have ${creditCheck.credits} credit${creditCheck.credits !== 1 ? 's' : ''}. You need ${CREDITS_REQUIRED} credit${CREDITS_REQUIRED !== 1 ? 's' : ''} for Premium HD download.`;
          
          showError(creditMessage);
          setTimeout(() => {
            if (confirm('Would you like to purchase credits?')) {
              window.location.href = 'pricing.html';
            }
          }, 2000);
          return;
        }
        
        // Show processing message with credit info
        const creditInfo = creditCheck.unlimited 
          ? 'Unlimited credits'
          : `${creditCheck.credits} credit${creditCheck.credits !== 1 ? 's' : ''} available`;
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(251,146,60,0.12);color:#7c2d12;font-weight:600;">ðŸŽ¨ Processing Premium HD download... (${creditInfo}, ${CREDITS_REQUIRED} credit will be deducted)</div>`;
        
        // Get original image from sessionStorage
        const originalImageData = sessionStorage.getItem(STORAGE_KEYS.original);
        if (!originalImageData) {
          throw new Error('Original image not found');
        }
        
        // Call premium API endpoint (backend will deduct credits)
        const response = await fetch('/api/tools/bg-remove-premium', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${userInfo.authToken}`
          },
          body: JSON.stringify({
            imageData: originalImageData,
            userId: userInfo.userId
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          
          // Handle authentication required
          if (response.status === 401) {
            showError('Please sign in to use Premium HD download.');
            const currentUrl = window.location.href;
            window.location.href = 'login.html?redirect=' + encodeURIComponent(currentUrl);
            return;
          }
          
          // Handle insufficient credits
          if (response.status === 402) {
            showError(errorData.message || 'Insufficient credits. Please purchase credits to use Premium HD.');
            // Optionally redirect to pricing page
            setTimeout(() => {
              if (confirm('Would you like to purchase credits?')) {
                window.location.href = 'pricing.html';
              }
            }, 2000);
            downloadPremiumBtn.disabled = false;
            return;
          }
          
          throw new Error(errorData.error || errorData.message || `Server error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.resultImage) {
          // Download premium HD version
          const link = document.createElement('a');
          const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed-hd.png';
          link.href = result.resultImage;
          link.download = filename.endsWith('.png') 
            ? filename.replace('.png', '-hd.png') 
            : `${filename.replace(/\.[^/.]+$/, '') || 'background-removed'}-hd.png`;
          link.click();
          
          // Show success message with credit deduction info
          const creditsUsed = result.creditsUsed || CREDITS_REQUIRED;
          
          // Check updated credit balance
          const updatedCreditCheck = await checkCreditBalance(userInfo);
          const remainingCredits = updatedCreditCheck.unlimited ? 'Unlimited' : updatedCreditCheck.credits;
          
          const successMessage = updatedCreditCheck.unlimited
            ? `âœ… Premium HD downloaded! (${creditsUsed} credit${creditsUsed > 1 ? 's' : ''} used - Unlimited account)`
            : `âœ… Premium HD downloaded! (${creditsUsed} credit${creditsUsed > 1 ? 's' : ''} deducted, ${remainingCredits} remaining)`;
          
          statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">${successMessage}</div>`;
          setTimeout(() => clearStatus(), 6000);
          
          console.log('âœ… Premium HD download successful. Credits deducted:', creditsUsed);
        } else {
          throw new Error(result.error || 'Premium processing failed');
        }
        
      } catch (error) {
        console.error('Premium HD download error:', error);
        
        // Handle specific errors
        if (error.message.includes('sign in') || error.message.includes('Authentication')) {
          showError('Please sign in to use Premium HD download.');
          const currentUrl = window.location.href;
          window.location.href = 'login.html?redirect=' + encodeURIComponent(currentUrl);
        } else if (error.message.includes('credit')) {
          showError('Insufficient credits. Please purchase credits to use Premium HD.');
        } else {
          showError(`Premium download failed: ${error.message || 'Please try again.'}`);
        }
        downloadPremiumBtn.disabled = false;
      } finally {
        downloadPremiumBtn.disabled = false;
      }
    }
    
    // Handle pending action after sign-in redirect
    async function handlePendingPremiumDownload() {
      try {
        // Check for pending premium download action
        const pendingActionRaw = sessionStorage.getItem('easyjpgtopdf.pendingAction');
        if (pendingActionRaw) {
          const pendingAction = JSON.parse(pendingActionRaw);
          if (pendingAction.type === 'premium-download' && !pendingAction.dispatched) {
            // Check if user is now logged in
            const userInfo = await getUserInfo();
            if (userInfo.userId && userInfo.userId !== 'anonymous' && userInfo.authToken) {
              // Wait for page to fully load and processing to complete
              let attempts = 0;
              const maxAttempts = 60; // Wait up to 30 seconds (60 * 500ms)
              
              const checkAndDownload = setInterval(async () => {
                attempts++;
                // Check if result is available
                if (resultDataURL) {
                  clearInterval(checkAndDownload);
                  // Auto-trigger premium download
                  await downloadPremiumHD(userInfo);
                  // Clear pending action
                  sessionStorage.removeItem('easyjpgtopdf.pendingAction');
                  showStatus('Processing premium download after sign-in...');
                } else if (attempts >= maxAttempts) {
                  clearInterval(checkAndDownload);
                  showError('Image processing not completed. Please try downloading again.');
                  sessionStorage.removeItem('easyjpgtopdf.pendingAction');
                }
              }, 500);
            }
          }
        }
      } catch (error) {
        console.warn('Error handling pending action:', error);
      }
    }
    
    // Check for pending action after page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(handlePendingPremiumDownload, 1500);
      });
    } else {
      setTimeout(handlePendingPremiumDownload, 1500);
    }
    
    // Listen for auth-action-resume event (when user returns after sign-in)
    document.addEventListener('auth-action-resume', async (event) => {
      const { action, user } = event.detail;
      if (action && action.type === 'premium-download' && user) {
        setTimeout(() => {
          handlePendingPremiumDownload();
        }, 1000);
      }
    });

    // New Upload button - redirect to upload page
    const newUploadBtn = document.getElementById('newUploadBtn');
    if (newUploadBtn) {
      newUploadBtn.addEventListener('click', () => {
        window.location.href = 'background-remover.html';
      });
    }

    const footerYear = document.getElementById('footerYear');
    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }
  </script>
    
<script type="module">
  const isLocalFileProtocol = window.location.protocol === 'file:';
  if (isLocalFileProtocol) {
    console.warn('?? auth.js skipped on file:// protocol to avoid CORS errors.');
  } else {
    import('./js/auth.js').catch(err => {
      console.error('? Failed to load auth.js:', err);
    });
  }
</script>

    <script type="module" src="js/firebase-init.js"></script>

    <footer>
        <div class="container footer-inner">
            <div class="footer-company-links">
                <span>Company</span>
                <a href="index.html#about">About Us</a>
                <a href="index.html#contact">Contact</a>
                <a href="pricing.html">Pricing</a>
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="terms-of-service.html">Terms of Service</a>
                <a href="dmca-en.html">DMCA</a>
                <a href="blog.html">Blog</a>
            </div>
            <p class="footer-brand-line">&copy; easyjpgtopdf &mdash; Free PDF &amp; Image Tools for everyone. All rights reserved.</p>
            <p class="footer-credits">
                Built with open-source technologies.
                <a href="attributions.html">See full acknowledgements</a>.
            </p>
        </div>
    </footer>
</body>
</html>

