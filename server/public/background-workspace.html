<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Background Removal Workspace - AI Background Remover | Remove Background Online Free</title>
    <meta name="description" content="Remove background from images online with AI. Free preview (512px) and premium HD quality (2000-4000px) background removal. Professional GPU-accelerated AI processing.">
    <meta name="keywords" content="background removal, remove background, ai background remover, background workspace, free background removal, hd background removal, transparent background, png background remover">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://easyjpgtopdf.com/background-workspace.html">
    <meta property="og:title" content="Background Removal Workspace - Edit & Download Transparent Images">
    <meta property="og:description" content="Edit and download transparent PNG images. Remove background from image online with AI.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://easyjpgtopdf.com/background-workspace.html">
<link href="css/footer.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --dark: #212529;
      --muted: #7a7f8c;
      --surface: #ffffff;
      --border: rgba(18, 20, 58, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(180deg, #f3f4ff 0%, #f8f9ff 100%); color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--surface); box-shadow: 0 12px 30px rgba(14, 32, 86, 0.1); position: sticky; top: 0; z-index: 20; }
    .topbar .inner { max-width: 1200px; margin: 0 auto; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; gap: 18px; }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 700; font-size: 20px; color: var(--primary); text-decoration: none; }
    .quick-links { display: flex; gap: 10px; flex-wrap: wrap; }
    .quick-links a { text-decoration: none; padding: 8px 16px; border-radius: 999px; border: 1px solid var(--border); color: #253156; font-weight: 600; background: rgba(67, 97, 238, 0.08); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
    .quick-links a:hover { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; transform: translateY(-1px); box-shadow: 0 12px 24px rgba(67, 97, 238, 0.2); }
    main { flex: 1; width: 100%; max-width: 1200px; margin: 36px auto; padding: 0 24px 48px; display: grid; grid-template-columns: 1fr 40%; gap: 32px; align-items: start; }
    .panel { background: var(--surface); border-radius: 24px; padding: 28px; box-shadow: 0 20px 45px rgba(15, 30, 70, 0.08); }
    .panel h2 { font-size: 1.35rem; margin-bottom: 18px; display: flex; gap: 12px; align-items: center; color: #171f4d; }
    .preview-stage { position: relative; width: 8.5cm; height: 6cm; max-width: 100%; max-height: 100%; margin: 0 auto; border-radius: 18px; background: repeating-conic-gradient(#e5e9ff 0deg 25deg, #f8f9ff 25deg 50deg); overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .preview-original, .preview-result { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; transition: opacity 0.6s ease; border: none; outline: none; box-shadow: none; }
    .preview-result { opacity: 0; }
    .preview-stage.revealed .preview-result { opacity: 1; }
    .preview-stage.revealed .preview-original { opacity: 0; }
    .preview-overlay { position: absolute; inset: 0; background: rgba(17, 24, 39, 0.55); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: #fff; font-weight: 600; letter-spacing: 0.03em; transition: opacity 0.4s ease; }
    .preview-stage.revealed .preview-overlay { opacity: 0; pointer-events: none; }
    .preview-stage.empty .preview-overlay { display: none; }
    .preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; text-align: center; color: var(--muted); font-weight: 600; letter-spacing: 0.03em; }
    .preview-placeholder.hidden { display: none; }
    .preview-spinner { width: 34px; height: 34px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .actions { margin-top: 24px; display: flex; flex-wrap: wrap; gap: 14px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 22px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.25); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: #233050; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .status-card { display: flex; flex-direction: column; gap: 18px; color: var(--muted); font-size: 0.95rem; line-height: 1.6; }
    .status-card strong { color: #1e254d; font-size: 1.05rem; }
    footer { text-align: center; padding: 24px 16px 40px; font-size: 0.85rem; color: var(--muted); }
    /* Download Modal Styles */
    .download-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 1000; align-items: center; justify-content: center; }
    .download-modal.active { display: flex; }
    .download-modal-content { background: #fff; border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3); }
    .download-modal-header { margin-bottom: 24px; }
    .download-modal-header h3 { font-size: 1.4rem; color: #1a214d; margin-bottom: 8px; }
    .download-modal-header p { color: var(--muted); font-size: 0.95rem; }
    .download-options { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .download-option { border: 2px solid var(--border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; background: #fff; position: relative; }
    .download-option:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15); }
    .download-option.disabled { opacity: 0.6; cursor: not-allowed; background: #f5f5f5; }
    .download-option.selected { border-color: var(--primary); background: rgba(67, 97, 238, 0.05); }
    .download-option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .download-option-title { font-weight: 700; font-size: 1.1rem; color: #1a214d; }
    .download-option-badge { padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .download-option-badge.free { background: rgba(34, 197, 94, 0.15); color: #059669; }
    .download-option-badge.premium { background: rgba(67, 97, 238, 0.15); color: var(--primary); }
    .download-option-details { color: var(--muted); font-size: 0.9rem; line-height: 1.6; }
    .download-option-details strong { color: #1a214d; }
    .size-selection { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: none; }
    .size-selection.active { display: block; }
    .size-selection label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
    .size-select { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 0.95rem; color: #1a214d; background: #fff; cursor: pointer; transition: border-color 0.2s; }
    .size-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
    .size-info { margin-top: 8px; font-size: 0.8rem; color: var(--muted); }
    .download-modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    @media (max-width: 640px) {
      .download-modal-content { padding: 24px; max-width: 95%; }
      .size-select { font-size: 0.9rem; padding: 8px 12px; }
    }
    .download-modal-actions button { padding: 10px 20px; border-radius: 999px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s; }
    .download-modal-actions button:hover { transform: translateY(-1px); }
    .download-modal-actions .btn-cancel { background: #f5f5f5; color: #666; }
    .download-modal-actions .btn-download { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 16px 30px rgba(67, 97, 238, 0.25); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
      .actions { justify-content: center; }
    }
  </style>
<link href="css/header.css" rel="stylesheet"/>
<link href="css/theme-modern.css" rel="stylesheet"/>
<link rel="stylesheet" href="css/voice-assistant.css">
<script src="js/voice-assistant.js" defer></script>
            <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Background Removal Workspace - AI Background Remover | Remove Background Online Free",
      "description": "Remove background from images online with AI. Free preview (512px) and premium HD quality (up to 25 Megapixels) background removal. Professional GPU-accelerated AI processing.",
      "url": "https://easyjpgtopdf.com/background-workspace.html",
      "inLanguage": "en-US",
      "isPartOf": {
        "@type": "WebSite",
        "name": "easyjpgtopdf",
        "url": "https://easyjpgtopdf.com"
      },
      "publisher": {
        "@type": "Organization",
        "name": "easyjpgtopdf",
        "url": "https://easyjpgtopdf.com"
      }
    }
    </script>
</head>
<body>
    <!-- Global Header Placeholder - Loaded by global-components.js -->
    <div id="global-header-placeholder"></div>
    <nav aria-label="Breadcrumb" style="padding: 15px 0; background: #f8f9ff; border-bottom: 1px solid #e2e6ff;">
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
            <ol style="list-style: none; display: flex; flex-wrap: wrap; gap: 10px; margin: 0; padding: 0; align-items: center;">
                <li><a href="index.html" style="color: #4361ee; text-decoration: none; font-weight: 500; transition: color 0.3s;" onmouseover="this.style.color='#3a0ca3'" onmouseout="this.style.color='#4361ee'">Home</a></li>
                <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
                <li><a href="login.html" style="color: #56607a; font-weight: 500; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#4361ee'" onmouseout="this.style.color='#56607a'">Sign In</a></li>
                <li><span style="margin: 0 8px; color: #9ca3af;">|</span></li>
                <li><a href="signup.html" style="color: #56607a; font-weight: 500; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#4361ee'" onmouseout="this.style.color='#56607a'">Signup</a></li>
            </ol>
        </div>
    </nav>
<main>
<section class="panel">
<h1>AI Background Removal Workspace - Remove Background Online Free</h1>
<div class="preview-stage" id="previewStage">
<img alt="Original" class="preview-original" hidden="" id="previewOriginal"/>
<img alt="Result" class="preview-result" hidden="" id="previewResult"/>
<div class="preview-overlay" id="previewOverlay">
<div class="preview-spinner"></div>
<span>AI Processing...</span>
</div>
<div class="preview-placeholder hidden" id="previewPlaceholder">
<i class="fas fa-image" style="font-size:3rem;opacity:0.3;"></i>
<span>No image loaded</span>
</div>
</div>
<!-- Hidden file input for multiple uploads -->
<input type="file" id="multipleImageUpload" accept="image/*" multiple style="display: none;">
<!-- Multiple Images Grid Preview -->
<div id="multipleImagesGrid" style="display: none; margin-top: 24px; padding: 20px; background: #f8f9ff; border-radius: 12px; border: 1px solid #e2e6ff;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="font-size: 1.1rem; color: #1f2559; margin: 0;">
            <i class="fas fa-images" style="margin-right: 8px; color: #4361ee;"></i>
            Uploaded Images (<span id="imageCount">0</span>)
        </h3>
        <button id="clearAllImages" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;">
            <i class="fas fa-trash"></i> Clear All
        </button>
    </div>
    <div id="imagesGridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(1cm, 1cm)); gap: 8px; max-height: 300px; overflow-y: auto; padding: 8px; background: white; border-radius: 8px;">
        <!-- Images will be added here -->
    </div>
    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button id="processAllBtn" class="btn btn-primary" style="flex: 1; min-width: 150px;">
            <i class="fas fa-magic"></i> Process All Images
        </button>
        <button id="downloadAllBtn" class="btn btn-primary" disabled style="flex: 1; min-width: 150px;">
            <i class="fas fa-download"></i> Download All (ZIP)
        </button>
    </div>
</div>
<div class="actions">
<button class="btn btn-outline" disabled="" id="backgroundChange">
<i class="fas fa-palette"></i> Change Background
        </button>
<button class="btn btn-primary" disabled="" id="downloadPng">
<i class="fas fa-download"></i> Download
        </button>
<button class="btn btn-primary" id="newUploadBtn" style="margin-left: 8px;">
<i class="fas fa-plus"></i>
        </button>
</div>
</section>
<section class="panel" style="display: none;">
<h2 style="display: none;">Processing Options</h2>
<div class="status-card" id="statusMessage"></div>
<!-- Process Button -->
<div style="display: none; margin: 20px 0; padding: 20px; background: #f8f9ff; border-radius: 12px; border: 1px solid #e2e6ff;">
  <button id="processBtn" class="btn btn-primary" style="width: 100%;">
    <i class="fas fa-magic"></i> Process Image
  </button>
  <p style="margin-top: 12px; font-size: 0.85rem; color: #56607a; text-align: center;">Process your image with AI background removal</p>
</div>
</section>
<section class="panel">
<h2>About This Tool</h2>
<!-- Animated Demo -->
<div style="margin: 16px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(67,97,238,0.15);">
<img alt="AI Processing Demo" src="images/bg-removal-jungle-demo.svg" style="width: 100%; height: auto; display: block;" onerror="this.style.display='none'; console.warn('Demo image not found');"/>
</div>
<div class="status-card">
<strong>? Professional AI Processing</strong>
<p>� Fast and accurate background removal</p>
<p>� Automatic processing for optimal results</p>
<p>� Professional quality output</p>
<p>� Unlimited uploads and downloads</p>
<p>� High-quality transparent PNG output</p>
</div>
</section>
<section class="panel">
<h2>Batch Processing Features (Premium)</h2>
<div class="status-card">
<strong>Multiple Image Upload & Processing</strong>
<p>Upload multiple images at once using the + button</p>
<p>View all uploaded images in a grid preview (1x1cm frames)</p>
<p>Process all images in batch with one click</p>
<p>Download all processed images as a ZIP file</p>
<p>Images automatically sync to Background Style page</p>
<p><strong>Free Users:</strong> Limited to one image at a time</p>
<p><strong>Premium Users:</strong> Unlimited batch processing</p>
</div>
</section>
</main>
<script type="module">
    const STORAGE_KEYS = {
      original: 'bgRemover:original',
      filename: 'bgRemover:filename',
      foreground: 'bgRemover:foreground',
      dimensions: 'bgRemover:dimensions',
      multipleImages: 'bgRemover:multipleImages',
      processedImages: 'bgRemover:processedImages'
    };

    const previewStage = document.getElementById('previewStage');
    const previewOriginal = document.getElementById('previewOriginal');
    const previewResult = document.getElementById('previewResult');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const backgroundChangeBtn = document.getElementById('backgroundChange');
    const downloadBtn = document.getElementById('downloadPng');
    const statusMessage = document.getElementById('statusMessage');
    const multipleImageUpload = document.getElementById('multipleImageUpload');
    const multipleImagesGrid = document.getElementById('multipleImagesGrid');
    const imagesGridContainer = document.getElementById('imagesGridContainer');
    const imageCount = document.getElementById('imageCount');
    const processAllBtn = document.getElementById('processAllBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const clearAllImages = document.getElementById('clearAllImages');

    let resultCanvas = null;
    let resultContext = null;
    let resultDataURL = null;
    let multipleImages = []; // Array to store multiple images: {id, file, dataURL, processed, resultURL, filename}
    let isPremiumUser = false;
    
    // IMG.LY library REMOVED - Using backend only for best quality

    function dataURLToBlob(dataURL) {
      const [meta, encoded] = dataURL.split(',');
      const mimeMatch = meta.match(/data:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/png';
      const binary = atob(encoded);
      const len = binary.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) buffer[i] = binary.charCodeAt(i);
      return new Blob([buffer], { type: mime });
    }

    async function blobFromSource(source, meta) {
      if (!source) return null;
      if (source.startsWith('data:')) {
        return dataURLToBlob(source);
      }
      if (source.startsWith('blob:')) {
        return await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', source);
          xhr.responseType = 'blob';
          xhr.onload = () => {
            const responseBlob = xhr.response;
            if (responseBlob && meta?.type && responseBlob.type !== meta.type) {
              resolve(responseBlob.slice(0, responseBlob.size, meta.type));
            } else {
              resolve(responseBlob);
            }
          };
          xhr.onerror = () => reject(new Error('Failed to read blob URL.'));
          xhr.send();
        });
      }
      const response = await fetch(source);
      return await response.blob();
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function showError(message) {
      statusMessage.innerHTML = `<div style="padding:16px;border-radius:14px;background:rgba(220,38,38,0.12);color:#7f1d1d;font-weight:600;">${message}</div>`;
    }

    function showStatus(message) {
      statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">${message}</div>`;
      setTimeout(() => {
        if (statusMessage.textContent?.includes(message)) {
          clearStatus();
        }
      }, 3000);
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    function ensureCanvas(width, height) {
      if (!resultCanvas) {
        resultCanvas = document.createElement('canvas');
        resultContext = resultCanvas.getContext('2d');
      }
      resultCanvas.width = width;
      resultCanvas.height = height;
    }

    // ============================================
    // HIGH QUALITY AI BACKGROUND REMOVER
    // Professional AI Processing System
    // ============================================
    // Use proxy endpoint for processing
    // ============================================
    
    // All processing is done via backend API - GPU-accelerated server-side processing
    
    // ============================================
    // AI-Powered Background Remover
    // FREE: 512px Preview (GPU-accelerated)
    // PREMIUM: HD 2000-4000px (GPU-accelerated High-Resolution)
    // ============================================
    
    // Import subscription and credit modules
    let subscriptionModule = null;
    let creditModule = null;
    let currentUserId = null;
    
    // Get API base URL
    function getApiBaseUrl() {
      const hostname = window.location.hostname;
      const isDevelopment = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.');
      if (isDevelopment) {
        return 'http://localhost:3000';
      }
      const origin = window.location.origin;
      return origin.endsWith('/') ? origin.slice(0, -1) : origin;
    }
    
    const API_BASE_URL = getApiBaseUrl();
    console.log('API Base URL:', API_BASE_URL);
    
    // Load subscription module
    async function loadSubscriptionModule() {
      if (subscriptionModule) return subscriptionModule;
      try {
        subscriptionModule = await import('./js/subscription.js');
        return subscriptionModule;
      } catch (error) {
        console.warn('Failed to load subscription module:', error);
        return null;
      }
    }
    
    // Load credit manager module
    async function loadCreditModule() {
      if (creditModule) return creditModule;
      try {
        creditModule = await import('./js/credit-manager.js');
        return creditModule;
      } catch (error) {
        console.warn('Failed to load credit module:', error);
        return null;
      }
    }
    
    // Get current user ID - FIXED: Use Firebase auth directly
    async function getCurrentUserId() {
      if (currentUserId) return currentUserId;
      
      try {
        // Import Firebase auth directly
        const firebaseInit = await import('./js/firebase-init.js');
        if (firebaseInit && firebaseInit.auth) {
          const auth = firebaseInit.auth;
          
          // Check current user first
          if (auth.currentUser) {
            currentUserId = auth.currentUser.uid;
            return currentUserId;
          }
          
          // Wait for auth state with timeout
          const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
          
          return new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              unsubscribe();
              if (user) {
                currentUserId = user.uid;
                resolve(user.uid);
              } else {
                resolve(null);
              }
            });
            
            // Timeout after 3 seconds
            setTimeout(() => {
              unsubscribe();
              resolve(null);
            }, 3000);
          });
        }
      } catch (error) {
        console.warn('Failed to get user ID:', error);
      }
      
      return currentUserId || null;
    }
    
    // Process with Free Preview API (512px BiRefNet GPU)
    // Validate image data URL format - COMPREHENSIVE VALIDATION
    function validateImageDataURL(dataURL) {
      if (!dataURL || typeof dataURL !== 'string') {
        return { valid: false, error: 'Image data is invalid or missing' };
      }
      
      // Check minimum length
      if (dataURL.length < 100) {
        return { valid: false, error: 'Image data is too small or corrupted. Please try uploading again.' };
      }
      
      // Check if it's a data URL
      if (!dataURL.startsWith('data:image/')) {
        return { valid: false, error: 'Invalid image format. Please upload a valid image file (JPG, PNG, etc.).' };
      }
      
      // Check if it has base64 data
      if (!dataURL.includes(',')) {
        return { valid: false, error: 'Image data is incomplete. Please try uploading the image again.' };
      }
      
      // Extract base64 part
      const parts = dataURL.split(',');
      const base64Part = parts[1];
      
      if (!base64Part || base64Part.length < 100) {
        return { valid: false, error: 'Image data is too small or corrupted. Please try a different image.' };
      }
      
      // Check base64 format (should only contain valid base64 characters)
      const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
      if (!base64Regex.test(base64Part)) {
        return { valid: false, error: 'Invalid base64 format. Please try uploading the image again.' };
      }
      
      // Try to decode a sample to verify it's valid base64
      try {
        const sampleSize = Math.min(1000, base64Part.length);
        const sample = base64Part.substring(0, sampleSize);
        const decoded = atob(sample);
        if (!decoded || decoded.length === 0) {
          return { valid: false, error: 'Image data is corrupted. Please try uploading again.' };
        }
      } catch (e) {
        return { valid: false, error: 'Invalid image data format. Please upload a valid image file (JPG, PNG, etc.).' };
      }
      
      return { valid: true };
    }
    
    async function processWithFreePreview(dataURL) {
      // Declare variables in function scope for proper cleanup
      let progressInterval = null;
      let timeout = null;
      const controller = new AbortController();
      
      try {
        // Validate image data before sending
        const validation = validateImageDataURL(dataURL);
        if (!validation.valid) {
          return {
            success: false,
            error: validation.error || 'Invalid image file. Please ensure you are uploading a valid image (JPG, PNG, etc.).'
          };
        }
        
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">⚡ Processing with Free Preview (512px GPU-accelerated)... This usually takes 10-30 seconds. Please wait...</div>`;
        
        const apiUrl = `${API_BASE_URL}/api/tools/bg-remove-free`;
        console.log('Calling API:', apiUrl);
        console.log('Image data URL length:', dataURL.length);
        console.log('Image data URL preview:', dataURL.substring(0, 50) + '...');
        console.log('Base64 part length:', dataURL.split(',')[1]?.length || 0);
        
        // Verify image data is complete before sending
        const base64Part = dataURL.split(',')[1];
        if (!base64Part || base64Part.length < 100) {
          throw new Error('Image data is incomplete. Please try uploading the image again.');
        }
        
        const startTime = Date.now();
        
        // Progress indicator - update every 5 seconds
        progressInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          if (elapsed < 30) {
            statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">⚡ Processing... (${elapsed}s) - Please wait, this usually takes 10-30 seconds.</div>`;
          } else if (elapsed < 50) {
            statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(255,193,7,0.12);color:#856404;font-weight:600;">⏳ Processing... (${elapsed}s) - Taking longer than usual. Almost done...</div>`;
          }
        }, 5000);
        
        // Add timeout for free preview (120 seconds - increased for reliability)
        timeout = setTimeout(() => {
          if (!controller.signal.aborted) {
            if (progressInterval) clearInterval(progressInterval);
            controller.abort();
          }
        }, 120000); // 120 seconds - more time for complex images
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ imageData: dataURL }),
          signal: controller.signal
        });
        
        // Clear timeout and interval on successful response
        if (timeout) clearTimeout(timeout);
        clearInterval(progressInterval);
        
        if (!response.ok) {
          let errorData = {};
          let errorText = '';
          
          try {
            errorText = await response.text();
            console.error('API Error Response Text:', errorText);
            
            if (errorText) {
              try {
                errorData = JSON.parse(errorText);
              } catch (e) {
                errorData = { error: errorText };
              }
            }
          } catch (e) {
            console.error('Error reading response:', e);
            errorData = { error: `Failed to read error response: ${e.message}` };
          }
          
          // Extract error message with better handling
          let errorMsg = 'Unknown error';
          if (errorData && typeof errorData === 'object') {
            errorMsg = errorData.error || errorData.message || errorData.errorMessage || JSON.stringify(errorData);
          } else if (typeof errorData === 'string') {
            errorMsg = errorData;
          } else if (errorText) {
            errorMsg = errorText;
          }
          
          // Fallback to status-based message
          if (!errorMsg || errorMsg === 'Unknown error') {
            if (response.status === 404) {
              errorMsg = 'API endpoint not found (404). Please check the API URL and try again.';
            } else if (response.status === 500) {
              errorMsg = 'Server error (500). Please try again later.';
            } else {
              errorMsg = `Server error: ${response.status} ${response.statusText}`;
            }
          }
          
          console.error('API Error Details:', {
            status: response.status,
            statusText: response.statusText,
            url: apiUrl,
            errorData: errorData,
            errorText: errorText,
            finalError: errorMsg
          });
          
          throw new Error(errorMsg);
        }
        
        const result = await response.json();
        
        if (result.success && result.resultImage) {
          return {
            success: true,
            dataUrl: result.resultImage,
            processedWith: 'Free Preview (512px GPU-accelerated)',
            outputSize: result.outputSize,
            outputSizeMB: result.outputSizeMB
          };
        } else {
          const errorMsg = result.error || result.message || 'Processing failed';
          console.error('Processing failed:', result);
          throw new Error(errorMsg);
        }
      } catch (error) {
        // Clean up progress interval and timeout if still running
        if (progressInterval) {
          clearInterval(progressInterval);
        }
        if (timeout) {
          clearTimeout(timeout);
        }
        
        console.error('Free preview processing error:', error);
        console.error('Error type:', typeof error);
        console.error('Error details:', {
          name: error?.name,
          message: error?.message,
          stack: error?.stack,
          error: error
        });
        
        // Handle AbortError FIRST - this happens when timeout occurs
        if (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted')) {
          return {
            success: false,
            error: 'Request timeout. Free preview processing took longer than 90 seconds. The server may be busy or the image may be too complex. Please try again with a smaller image or wait a moment and retry.'
          };
        }
        
        let errorMessage = 'Free preview processing failed';
        
        // Extract error message properly
        if (error instanceof Error) {
          errorMessage = error.message || error.toString();
        } else if (typeof error === 'string') {
          errorMessage = error;
        } else if (error && typeof error === 'object') {
          // Try multiple ways to extract error message
          errorMessage = error.error || error.message || error.errorMessage || error.msg || JSON.stringify(error);
        }
        
        // Clean up error message (remove [object Object])
        if (errorMessage === '[object Object]' || errorMessage.includes('[object Object]')) {
          try {
            const errorObj = error && typeof error === 'object' ? error : {};
            errorMessage = errorObj.error || errorObj.message || errorObj.errorMessage || 'Processing failed. Please try again.';
          } catch (e) {
            errorMessage = 'Processing failed. Please try again.';
          }
        }
        
        // More specific error messages
        if (errorMessage.includes('404') || errorMessage.includes('not found') || errorMessage.includes('Route not found')) {
          errorMessage = 'API endpoint not found (404). The service may be updating. Please refresh the page (Ctrl+Shift+R) and try again.';
        } else if (errorMessage.includes('index.js')) {
          errorMessage = 'API routing error. Please refresh the page (Ctrl+Shift+R) and try again.';
        } else if (errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch') || errorMessage.includes('Network request failed')) {
          errorMessage = 'Network error. Please check your internet connection and try again.';
        } else if (errorMessage.includes('timeout') || errorMessage.includes('Timeout')) {
          errorMessage = 'Request timeout. The server may be busy. Please try again with a smaller image.';
        } else if (errorMessage.includes('Invalid image') || errorMessage.includes('Invalid image data') || errorMessage.includes('bytes-like object') || errorMessage.includes('Image object') || errorMessage.includes('Invalid image data format')) {
          errorMessage = 'Invalid image file. Please ensure you are uploading a valid image file (JPG, PNG, etc.). The image may be corrupted or in an unsupported format. Please try uploading a different image.';
        }
        
        return {
          success: false,
          error: errorMessage
        };
      }
    }
    
    // Process with Premium HD API (up to 25 MP BiRefNet GPU High-Resolution)
    async function processWithPremiumHD(dataURL, targetSize = 'original') {
      try {
        // Validate image data before sending
        const validation = validateImageDataURL(dataURL);
        if (!validation.valid) {
          return {
            success: false,
            error: validation.error || 'Invalid image file. Please ensure you are uploading a valid image (JPG, PNG, etc.).'
          };
        }
        
        // Check credits first
        const subModule = await loadSubscriptionModule();
        const userId = await getCurrentUserId();
        
        if (!userId) {
          return {
            success: false,
            error: 'Please sign in to use Premium HD processing',
            requiresAuth: true
          };
        }
        
        // Verify credits (this should be done on backend, but we check here for UX)
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">⚡ Processing with Premium HD – up to 25 Megapixels (GPU-accelerated High-Resolution)... This may take 30-90 seconds.</div>`;
        
        const startTime = Date.now();
        
        // Progress indicator - update every 10 seconds for premium
        let progressInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          if (elapsed < 60) {
            statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">⚡ Premium HD processing... (${elapsed}s) - Please wait, high-quality processing takes 30-90 seconds.</div>`;
          } else if (elapsed < 180) {
            statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(255,193,7,0.12);color:#856404;font-weight:600;">⏳ Premium HD processing... (${elapsed}s) - High-quality processing takes longer. Almost done...</div>`;
          }
        }, 10000);
        
        // Add timeout for premium processing (5 minutes)
        const controller = new AbortController();
        const timeout = setTimeout(() => {
          clearInterval(progressInterval);
          controller.abort();
        }, 300000); // 5 minutes
        
        const response = await fetch(`${API_BASE_URL}/api/tools/bg-remove-premium`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${await getAuthToken()}`
          },
          // Parse target size
          let targetWidth = null;
          let targetHeight = null;
          if (selectedPremiumSize && selectedPremiumSize !== 'original') {
            const [width, height] = selectedPremiumSize.split('x');
            targetWidth = parseInt(width);
            targetHeight = parseInt(height);
          }
          
          body: JSON.stringify({ 
            imageData: dataURL,
            userId: userId,
            targetSize: selectedPremiumSize || 'original',
            targetWidth: targetWidth,
            targetHeight: targetHeight
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeout);
        clearInterval(progressInterval);
        
        if (!response.ok) {
          let errorData = {};
          let errorText = '';
          
          try {
            errorText = await response.text();
            console.error('Premium API Error Response Text:', errorText);
            
            if (errorText) {
              try {
                errorData = JSON.parse(errorText);
              } catch (e) {
                errorData = { error: errorText };
              }
            }
          } catch (e) {
            console.error('Error reading premium response:', e);
            errorData = { error: `Failed to read error response: ${e.message}` };
          }
          
          // Extract error message
          let errorMsg = errorData.error || errorData.message || errorData.errorMessage || `Server error: ${response.status}`;
          
          if (response.status === 401) {
            return {
              success: false,
              error: 'Please sign in to use Premium HD processing.',
              requiresAuth: true
            };
          }
          
          if (response.status === 402 || errorMsg.includes('credit') || errorMsg.includes('insufficient')) {
            return {
              success: false,
              error: 'Insufficient credits. Please purchase credits to use Premium HD processing.',
              requiresCredits: true
            };
          }
          
          console.error('Premium API Error Details:', {
            status: response.status,
            statusText: response.statusText,
            errorData: errorData,
            errorText: errorText,
            finalError: errorMsg
          });
          
          throw new Error(errorMsg);
        }
        
        const result = await response.json();
        
        if (result.success && result.resultImage) {
          return {
            success: true,
            dataUrl: result.resultImage,
            processedWith: 'Premium HD (2000-4000px GPU-accelerated High-Resolution)',
            outputSize: result.outputSize,
            outputSizeMB: result.outputSizeMB,
            creditsUsed: result.creditsUsed
          };
        } else {
          throw new Error(result.error || 'Processing failed');
        }
      } catch (error) {
        // Clean up progress interval if still running
        if (typeof progressInterval !== 'undefined') {
          clearInterval(progressInterval);
        }
        
        console.error('Premium HD processing error:', error);
        console.error('Error type:', typeof error);
        console.error('Error details:', {
          name: error?.name,
          message: error?.message,
          stack: error?.stack,
          error: error
        });
        
        let errorMessage = 'Premium HD processing failed';
        
        // Extract error message properly
        if (error instanceof Error) {
          errorMessage = error.message || error.toString();
        } else if (typeof error === 'string') {
          errorMessage = error;
        } else if (error && typeof error === 'object') {
          errorMessage = error.error || error.message || error.errorMessage || error.msg || JSON.stringify(error);
        }
        
        // Clean up error message
        if (errorMessage === '[object Object]' || errorMessage.includes('[object Object]')) {
          try {
            const errorObj = error && typeof error === 'object' ? error : {};
            errorMessage = errorObj.error || errorObj.message || errorObj.errorMessage || 'Premium HD processing failed. Please try again.';
          } catch (e) {
            errorMessage = 'Premium HD processing failed. Please try again.';
          }
        }
        
        // Handle timeout
        if (error.name === 'AbortError' || errorMessage.includes('timeout') || errorMessage.includes('aborted')) {
          errorMessage = 'Request timeout. Premium HD processing may take longer. Please try again with a smaller image or wait a moment.';
        }
        
        // Handle network errors
        if (errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch') || errorMessage.includes('Network request failed')) {
          errorMessage = 'Network error. Please check your internet connection and try again.';
        }
        
        // Handle 404
        if (errorMessage.includes('404') || errorMessage.includes('not found')) {
          errorMessage = 'API endpoint not found (404). Please refresh the page (Ctrl+Shift+R) and try again.';
        }
        
        return {
          success: false,
          error: errorMessage
        };
      }
    }
    
    // Get auth token helper - FIXED: Use Firebase auth directly
    async function getAuthToken() {
      try {
        // Import Firebase auth directly
        const firebaseInit = await import('./js/firebase-init.js');
        if (firebaseInit && firebaseInit.auth) {
          const auth = firebaseInit.auth;
          const user = auth.currentUser;
          
          if (user) {
            // Force token refresh to ensure it's valid
            return await user.getIdToken(true);
          }
          
          // Wait for auth state if not immediately available
          const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
          
          return new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
              unsubscribe();
              if (user) {
                try {
                  const token = await user.getIdToken(true);
                  resolve(token);
                } catch (tokenError) {
                  console.warn('Failed to get token:', tokenError);
                  resolve(null);
                }
              } else {
                resolve(null);
              }
            });
            
            // Timeout after 3 seconds
            setTimeout(() => {
              unsubscribe();
              resolve(null);
            }, 3000);
          });
        }
      } catch (error) {
        console.warn('Failed to get auth token:', error);
      }
      return null;
    }
    

    // OLD FUNCTION - REMOVED (Now using backend API)
    // This function is kept for reference but NOT USED
    async function processWithBackend_OLD_UNUSED(dataURL, backendUrl, config) {
      try {
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(67,97,238,0.08);color:#1f2559;font-weight:600;">?? Uploading for AI processing...</div>`;
        
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 180000);
        
        // Log request details for debugging (OLD BACKEND - NOT USED)
        const imageSize = Math.ceil((dataURL.split(',')[1]?.length || 0) * 0.75 / 1024);
        console.log('?? [OLD BACKEND] Image size:', imageSize, 'KB');
        
        // Use JSON format (proxy handles conversion)
        let response = null;
        
        try {
          // Get user info and device ID
          const userInfo = await getUserInfo();
          
          // OLD BACKEND - NOT USED (Backend API is used instead)
          response = await fetch('/api/background-remove-pytorch-DISABLED', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-User-ID': userInfo.userId,
              'X-User-Type': userInfo.userType,
              'X-Device-ID': DEVICE_ID,
              'X-Auth-Token': userInfo.authToken || ''
            },
            body: JSON.stringify({ imageData: dataURL }),
            signal: controller.signal
          });
          
          console.log('?? Response received:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
          });
        } catch (fetchError) {
          console.error('? Request failed:', {
            name: fetchError.name,
            message: fetchError.message,
            stack: fetchError.stack
          });
          throw fetchError;
        }
        
        clearTimeout(timeout);

        // Check response status
        if (!response || !response.ok) {
          // If we have a response but it's not OK, handle the error
          if (response && !response.ok) {
            const errorText = await response.text();
            let errorData = {};
            try {
              errorData = JSON.parse(errorText);
            } catch (e) {
              errorData = { error: errorText || `Server error: ${response.status}` };
            }
            console.error('? Server error:', {
              status: response.status,
              statusText: response.statusText,
              error: errorData
            });
            throw new Error(errorData.error || `Server error: ${response.status} ${response.statusText}`);
          } else {
            throw new Error('No response from server. Please check your connection.');
          }
        }

        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">? Processing with professional AI...</div>`;
        
        const result = await response.json();
        console.log('? Processing result:', {
          success: result.success,
          hasResultImage: !!result.resultImage,
          outputSize: result.outputSizeMB || 'unknown'
        });
        
        if (result.success && result.resultImage) {
          return { 
            success: true, 
            dataUrl: result.resultImage, 
            processedWith: result.processedWith || config.description,
            outputSize: result.outputSize,
            outputSizeMB: result.outputSizeMB
          };
        } else {
          throw new Error(result.error || 'Processing failed on server');
        }
      } catch (error) {
        console.error('? Backend processing error:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        if (error.name === 'AbortError') {
          return { 
            success: false, 
            error: 'Request timeout. The file may be too large or the server is busy. Please try again or use a smaller image.' 
          };
        }
        
        // Provide more specific error messages - NO FALLBACK
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          return { 
            success: false, 
            error: 'Network error. Please check your internet connection and try again. If the problem persists, the server may be temporarily unavailable. Backend processing is required - no fallback available.' 
          };
        }
        
        // Check if error message contains service unavailable info
        let errorMessage = error.message || 'Backend processing failed. Please try again.';
        
        // Extract nested error messages from proxy responses
        if (errorMessage.includes('service is temporarily unavailable')) {
          errorMessage = 'Service is warming up. Please wait 15-20 seconds and try again. The service is configured to stay warm, but first request may take longer.';
        } else if (errorMessage.includes('cold starting') || errorMessage.includes('warming up')) {
          errorMessage = 'Service is warming up. Please wait 15-20 seconds and try again.';
        }
        
        return { 
          success: false, 
          error: `Backend processing failed: ${errorMessage}. Please try again or contact support.` 
        };
      }
    }

    async function processImage(dataURL) {
      clearStatus();
      previewPlaceholder.classList.add('hidden');
      previewStage.classList.remove('revealed');
      previewStage.classList.remove('empty');
      previewOverlay.style.opacity = 1;

      try {
        // Validate image data before processing
        const validation = validateImageDataURL(dataURL);
        if (!validation.valid) {
          showError(validation.error || 'Invalid image file. Please ensure you are uploading a valid image (JPG, PNG, etc.).');
          previewStage.classList.add('empty');
          previewOverlay.style.opacity = 0;
          previewPlaceholder.classList.remove('hidden');
          return;
        }
        
        previewOriginal.hidden = false;
        previewOriginal.src = dataURL;
        
        const fileSize = Number(sessionStorage.getItem('bgRemover:originalSize') || 0);
        
        // Always use Free Preview for processing (Premium HD available in download modal)
        const freeResult = await processWithFreePreview(dataURL);
        
        if (!freeResult.success) {
          throw new Error(freeResult.error || 'Free preview processing failed');
        }
        
        const resultUrl = freeResult.dataUrl;
        const processingMethod = freeResult.processedWith || 'Free Preview (512px)';
        console.log('✅ Free preview processing successful');
        
        if (!resultUrl) {
          throw new Error('Image processing failed. Please try again.');
        }
        
        sessionStorage.setItem(STORAGE_KEYS.foreground, resultUrl);

        const foregroundImage = new Image();
        foregroundImage.crossOrigin = 'anonymous';
        foregroundImage.src = resultUrl;
        await foregroundImage.decode();

        previewResult.hidden = false;
        previewResult.src = resultUrl;

        // Create canvas with proper settings for transparency preservation
        ensureCanvas(foregroundImage.width, foregroundImage.height);
        
        // Clear canvas to ensure transparency
        resultContext.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
        
        // Draw the transparent PNG image (preserves alpha channel)
        resultContext.drawImage(foregroundImage, 0, 0, resultCanvas.width, resultCanvas.height);
        
        // Convert to PNG with full quality (preserves transparency)
        resultDataURL = resultCanvas.toDataURL('image/png');

        sessionStorage.setItem(STORAGE_KEYS.dimensions, JSON.stringify({ width: resultCanvas.width, height: resultCanvas.height }));
        previewOverlay.style.opacity = 0;
        requestAnimationFrame(() => previewStage.classList.add('revealed'));
        backgroundChangeBtn.disabled = false;
        downloadBtn.disabled = false;
        
        // Success message
        const sizeInMB = (fileSize / (1024 * 1024)).toFixed(1);
        const methodLabel = processingMethod || config.description;
        statusMessage.innerHTML = `<div style="padding:12px 16px;border-radius:12px;background:rgba(34,197,94,0.12);color:#065f46;font-weight:600;">? Background removed! (${sizeInMB} MB file processed with ${methodLabel})</div>`;
        setTimeout(() => clearStatus(), 4000);
        
      } catch (error) {
        console.error('Background removal failed', error);
        console.error('Error details:', {
          name: error?.name,
          message: error?.message,
          stack: error?.stack,
          error: error
        });
        
        let errorMsg = '';
        
        // Handle AbortError FIRST - this happens when timeout occurs
        if (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted')) {
          errorMsg = 'Request timeout. The image processing took too long. The server may be busy or the image may be too complex. Please try again with a smaller image or wait a moment and retry.';
          showError(errorMsg);
          previewStage.classList.add('empty');
          previewOverlay.style.opacity = 0;
          previewPlaceholder.classList.remove('hidden');
          return;
        }
        
        // Extract error message from error object - COMPLETE FIX for [object Object]
        let errorMessage = 'Unknown error';
        
        if (error instanceof Error) {
          errorMessage = error.message || error.toString();
        } else if (typeof error === 'string') {
          errorMessage = error;
        } else if (error && error.error) {
          errorMessage = error.error;
        } else if (error && typeof error === 'object') {
          // Try multiple properties to extract error message
          errorMessage = error.error || error.message || error.errorMessage || error.msg || error.detail || error.description;
          
          // If still no message, try to safely stringify
          if (!errorMessage || errorMessage === '[object Object]') {
            try {
              const errorStr = JSON.stringify(error, null, 2);
              if (errorStr && errorStr !== '{}' && !errorStr.includes('[object Object]')) {
                errorMessage = errorStr;
              } else {
                // Try to get any string property
                const keys = Object.keys(error || {});
                for (const key of keys) {
                  if (typeof error[key] === 'string' && error[key] && error[key] !== '[object Object]') {
                    errorMessage = error[key];
                    break;
                  }
                }
              }
            } catch (e) {
              // If stringify fails, try toString
              try {
                const toStringResult = error.toString();
                if (toStringResult && toStringResult !== '[object Object]') {
                  errorMessage = toStringResult;
                }
              } catch (e2) {
                errorMessage = 'Processing failed. Please try again.';
              }
            }
          }
        }
        
        // Final cleanup - remove [object Object] if present
        if (!errorMessage || errorMessage === '[object Object]' || (typeof errorMessage === 'string' && errorMessage.trim() === '[object Object]')) {
          errorMessage = 'Processing failed. Please try again.';
        }
        
        // Handle different error types with better messages
        if (errorMessage.includes('404') || errorMessage.includes('not found') || errorMessage.includes('Route not found') || errorMessage.includes('index.js')) {
          errorMsg = 'API endpoint not found. The service may be updating. Please refresh the page (Ctrl+Shift+R) and try again.';
        } else if (errorMessage.includes('fetch') || errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch')) {
          errorMsg = 'Network error. Please check your internet connection and try again.';
        } else if (errorMessage.includes('timeout') || errorMessage.includes('Timeout')) {
          errorMsg = 'Request timeout. The image may be too large or the server is busy. Please try again with a smaller image.';
        } else if (errorMessage.includes('Invalid image') || errorMessage.includes('Invalid image data') || errorMessage.includes('bytes-like object') || errorMessage.includes('Image object')) {
          errorMsg = 'Invalid image file. Please ensure you are uploading a valid image file (JPG, PNG, etc.). The image may be corrupted or in an unsupported format. Please try uploading a different image.';
        } else if (errorMessage.includes('memory') || errorMessage.includes('too large')) {
          errorMsg = 'Image too large or complex. Please try a smaller image (max 10MB).';
        } else if (errorMessage.includes('Processing failed') || errorMessage.includes('Internal server error')) {
          errorMsg = 'Processing failed. Please try again with a different image. If the problem persists, the service may be temporarily unavailable.';
        } else if (errorMessage.includes('temporarily unavailable') || errorMessage.includes('warming up')) {
          errorMsg = 'Service is warming up. Please wait 15-20 seconds and try again.';
        } else {
          // Use the actual error message if available
          errorMsg = errorMessage || 'Failed to remove background. Please try again.';
        }
        
        showError(errorMsg);
        previewStage.classList.add('empty');
        previewOverlay.style.opacity = 0;
        previewPlaceholder.classList.remove('hidden');
      }
    }

    // ========== MULTIPLE IMAGE UPLOAD & BATCH PROCESSING ==========
    
    // Check if user is premium
    async function checkPremiumUser() {
      try {
        const creditMod = await loadCreditModule();
        const userId = await getCurrentUserId();
        
        if (!userId) {
          isPremiumUser = false;
          return false;
        }
        
        if (creditMod && creditMod.getUserCredits) {
          const creditData = await creditMod.getUserCredits(userId);
          isPremiumUser = creditData.unlimited || (creditData.credits && creditData.credits > 0);
          return isPremiumUser;
        }
        
        // Fallback: check subscription
        const subModule = await loadSubscriptionModule();
        if (subModule && subModule.getCurrentSubscription) {
          const subscription = await subModule.getCurrentSubscription(userId);
          isPremiumUser = subscription && (subscription.plan === 'premium' || subscription.plan === 'business') && subscription.isValid;
          return isPremiumUser;
        }
        
        isPremiumUser = false;
        return false;
      } catch (error) {
        console.error('Error checking premium status:', error);
        isPremiumUser = false;
        return false;
      }
    }
    
    // Load multiple images from session storage
    function loadMultipleImages() {
      try {
        const stored = sessionStorage.getItem(STORAGE_KEYS.multipleImages);
        if (stored) {
          multipleImages = JSON.parse(stored);
          updateImagesGrid();
        }
      } catch (error) {
        console.error('Error loading multiple images:', error);
        multipleImages = [];
      }
    }
    
    // Save multiple images to session storage
    function saveMultipleImages() {
      try {
        sessionStorage.setItem(STORAGE_KEYS.multipleImages, JSON.stringify(multipleImages));
      } catch (error) {
        console.error('Error saving multiple images:', error);
      }
    }
    
    // Update images grid display
    function updateImagesGrid() {
      if (!imagesGridContainer || !imageCount) return;
      
      imageCount.textContent = multipleImages.length;
      
      if (multipleImages.length === 0) {
        multipleImagesGrid.style.display = 'none';
        return;
      }
      
      multipleImagesGrid.style.display = 'block';
      imagesGridContainer.innerHTML = '';
      
      multipleImages.forEach((img, index) => {
        const frame = document.createElement('div');
        frame.style.cssText = 'position: relative; width: 1cm; height: 1cm; border: 2px solid #e2e6ff; border-radius: 4px; overflow: hidden; cursor: pointer; background: #f8f9ff;';
        
        const imgElement = document.createElement('img');
        imgElement.src = img.dataURL;
        imgElement.style.cssText = 'width: 100%; height: 100%; object-fit: cover; display: block;';
        frame.appendChild(imgElement);
        
        // Processed indicator
        if (img.processed) {
          const checkmark = document.createElement('div');
          checkmark.style.cssText = 'position: absolute; top: 2px; right: 2px; background: #22c55e; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px;';
          checkmark.innerHTML = '<i class="fas fa-check"></i>';
          frame.appendChild(checkmark);
        }
        
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.style.cssText = 'position: absolute; top: 2px; left: 2px; background: rgba(220, 38, 38, 0.8); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 8px; display: flex; align-items: center; justify-content: center; padding: 0;';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          removeImage(index);
        };
        frame.appendChild(removeBtn);
        
        // Click to process single image
        frame.onclick = () => {
          processSingleImage(index);
        };
        
        imagesGridContainer.appendChild(frame);
      });
      
      // Update buttons
      const hasProcessed = multipleImages.some(img => img.processed);
      downloadAllBtn.disabled = !hasProcessed || multipleImages.length === 0;
    }
    
    // Remove image from array
    function removeImage(index) {
      multipleImages.splice(index, 1);
      saveMultipleImages();
      updateImagesGrid();
    }
    
    // Process single image from grid
    async function processSingleImage(index) {
      if (index < 0 || index >= multipleImages.length) return;
      
      const img = multipleImages[index];
      if (img.processed) {
        // Already processed, show in main preview
        previewOriginal.src = img.dataURL;
        previewResult.src = img.resultURL;
        previewResult.hidden = false;
        previewStage.classList.remove('empty');
        previewPlaceholder.classList.add('hidden');
        return;
      }
      
      // Process this image
      try {
        showStatus(`Processing image ${index + 1} of ${multipleImages.length}...`);
        const result = await processWithFreePreview(img.dataURL);
        
        if (result.success) {
          img.processed = true;
          img.resultURL = result.dataUrl;
          saveMultipleImages();
          updateImagesGrid();
          showStatus(`✅ Image ${index + 1} processed successfully!`);
          
          // Show in main preview
          previewOriginal.src = img.dataURL;
          previewResult.src = img.resultURL;
          previewResult.hidden = false;
          previewStage.classList.remove('empty');
          previewPlaceholder.classList.add('hidden');
        } else {
          showError(`Failed to process image ${index + 1}: ${result.error}`);
        }
      } catch (error) {
        showError(`Error processing image ${index + 1}: ${error.message}`);
      }
    }
    
    // Process all images in batch
    async function processAllImages() {
      if (multipleImages.length === 0) {
        showError('No images to process');
        return;
      }
      
      if (!isPremiumUser && multipleImages.length > 1) {
        if (confirm('Multiple image processing is available for premium users only. Free users can process one image at a time. Would you like to upgrade to premium?')) {
          window.location.href = 'pricing.html';
        }
        return;
      }
      
      processAllBtn.disabled = true;
      showStatus(`Processing ${multipleImages.length} images...`);
      
      let successCount = 0;
      let failCount = 0;
      
      for (let i = 0; i < multipleImages.length; i++) {
        if (multipleImages[i].processed) {
          successCount++;
          continue;
        }
        
        try {
          showStatus(`Processing image ${i + 1} of ${multipleImages.length}...`);
          const result = await processWithFreePreview(multipleImages[i].dataURL);
          
          if (result.success) {
            multipleImages[i].processed = true;
            multipleImages[i].resultURL = result.dataUrl;
            successCount++;
          } else {
            failCount++;
            console.error(`Failed to process image ${i + 1}:`, result.error);
          }
        } catch (error) {
          failCount++;
          console.error(`Error processing image ${i + 1}:`, error);
        }
        
        // Small delay between processing
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      saveMultipleImages();
      updateImagesGrid();
      processAllBtn.disabled = false;
      
      if (successCount === multipleImages.length) {
        showStatus(`✅ All ${successCount} images processed successfully!`);
      } else {
        showStatus(`✅ Processed ${successCount} images. ${failCount} failed.`);
      }
    }
    
    // Download all processed images as ZIP
    async function downloadAllImages() {
      if (!window.JSZip) {
        showError('ZIP library not loaded. Please refresh the page.');
        return;
      }
      
      const processedImages = multipleImages.filter(img => img.processed);
      if (processedImages.length === 0) {
        showError('No processed images to download. Please process images first.');
        return;
      }
      
      if (!isPremiumUser && processedImages.length > 1) {
        if (confirm('Multiple image download is available for premium users only. Would you like to upgrade to premium?')) {
          window.location.href = 'pricing.html';
        }
        return;
      }
      
      try {
        showStatus('Creating ZIP file...');
        downloadAllBtn.disabled = true;
        
        const zip = new JSZip();
        
        for (let i = 0; i < processedImages.length; i++) {
          const img = processedImages[i];
          const imgElement = new Image();
          imgElement.crossOrigin = 'anonymous';
          imgElement.src = img.resultURL;
          
          await new Promise((resolve, reject) => {
            imgElement.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = imgElement.width;
              canvas.height = imgElement.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(imgElement, 0, 0);
              
              canvas.toBlob((blob) => {
                const filename = img.filename || `image-${i + 1}.png`;
                const baseName = filename.replace(/\.[^/.]+$/, '') || `image-${i + 1}`;
                zip.file(`${baseName}-bg-removed.png`, blob);
                resolve();
              }, 'image/png');
            };
            imgElement.onerror = reject;
          });
        }
        
        showStatus('Generating ZIP file...');
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = `background-removed-images-${new Date().getTime()}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        
        showStatus(`✅ Downloaded ${processedImages.length} images as ZIP file!`);
        downloadAllBtn.disabled = false;
      } catch (error) {
        console.error('ZIP download error:', error);
        showError('Failed to create ZIP file: ' + error.message);
        downloadAllBtn.disabled = false;
      }
    }
    
    // Handle multiple file upload
    async function handleMultipleFileUpload(files) {
      if (!files || files.length === 0) return;
      
      // Check premium status
      await checkPremiumUser();
      
      // Free users limited to 1 image
      if (!isPremiumUser && files.length > 1) {
        if (confirm('Multiple image upload is available for premium users only. Free users can upload one image at a time. Would you like to upgrade to premium?')) {
          window.location.href = 'pricing.html';
        }
        // Allow single image for free users
        if (files.length > 1) {
          files = [files[0]];
        }
      }
      
      // Free users: replace existing if any
      if (!isPremiumUser && multipleImages.length > 0) {
        if (confirm('Free users can only have one image. Replace current image?')) {
          multipleImages = [];
        } else {
          return;
        }
      }
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        if (!file.type.startsWith('image/')) {
          showError(`File ${i + 1} is not an image. Skipping...`);
          continue;
        }
        
        try {
          const dataURL = await blobToDataURL(file);
          const imageId = `img_${Date.now()}_${i}`;
          
          multipleImages.push({
            id: imageId,
            file: file,
            dataURL: dataURL,
            filename: file.name,
            processed: false,
            resultURL: null
          });
        } catch (error) {
          console.error(`Error loading file ${i + 1}:`, error);
          showError(`Failed to load image ${i + 1}`);
        }
      }
      
      saveMultipleImages();
      updateImagesGrid();
      
      if (multipleImages.length > 0) {
        // Show first image in main preview
        previewOriginal.src = multipleImages[0].dataURL;
        previewOriginal.hidden = false;
        previewStage.classList.remove('empty');
        previewPlaceholder.classList.add('hidden');
        backgroundChangeBtn.disabled = false;
      }
      
      showStatus(`✅ ${multipleImages.length} image(s) uploaded successfully!`);
    }

    // Initialize page
    const storedOriginal = sessionStorage.getItem(STORAGE_KEYS.original);
    if (!storedOriginal) {
      previewStage.classList.add('empty');
      previewPlaceholder.classList.remove('hidden');
      showError('No image found. Please upload a file first.');
      backgroundChangeBtn.disabled = true;
      downloadBtn.disabled = true;
      const processBtn = document.getElementById('processBtn');
      if (processBtn) processBtn.disabled = true;
    } else {
      // Load and display the image
      previewStage.classList.remove('empty');
      previewPlaceholder.classList.add('hidden');
      previewOriginal.hidden = false;
      previewOriginal.src = storedOriginal;
      
      const processBtn = document.getElementById('processBtn');
      if (processBtn) processBtn.disabled = false;
      backgroundChangeBtn.disabled = false;
      downloadBtn.disabled = false;
      
      // Auto-process with free preview on load
      setTimeout(() => {
        processImage(storedOriginal);
      }, 300);
    }
    
    // Process button handler - always uses free preview
    const processBtn = document.getElementById('processBtn');
    if (processBtn) {
      processBtn.addEventListener('click', () => {
        const stored = sessionStorage.getItem(STORAGE_KEYS.original);
        if (stored) {
          processImage(stored);
        } else {
          showError('Please upload an image first.');
        }
      });
    }

    backgroundChangeBtn.addEventListener('click', () => {
      if (backgroundChangeBtn.disabled) return;
      window.location.href = 'background-style.html';
    });

    // Download Modal Management
    const downloadModal = document.getElementById('downloadModal');
    const freeDownloadOption = document.getElementById('freeDownloadOption');
    const premiumDownloadOption = document.getElementById('premiumDownloadOption');
    const confirmDownloadBtn = document.getElementById('confirmDownload');
    const cancelDownloadBtn = document.getElementById('cancelDownload');
    const premiumCreditInfo = document.getElementById('premiumCreditInfo');
    const premiumCreditText = document.getElementById('premiumCreditText');
    
    let selectedDownloadQuality = null;
    let selectedPremiumSize = 'original'; // Default: preserve original size
    
    // Show download modal when download button is clicked
    downloadBtn.addEventListener('click', async () => {
      const originalResultUrl = sessionStorage.getItem(STORAGE_KEYS.foreground);
      const downloadUrl = originalResultUrl || resultDataURL;
      
      if (!downloadUrl) {
        showError('No processed image available. Please process an image first.');
        return;
      }
      
      // Reset modal state
      selectedDownloadQuality = null;
      confirmDownloadBtn.disabled = true;
      freeDownloadOption.classList.remove('selected');
      premiumDownloadOption.classList.remove('selected');
      premiumCreditInfo.style.display = 'none';
      
      // Update premium credit info
      await updatePremiumCreditInfo();
      
      // Show modal
      downloadModal.classList.add('active');
    });
    
    // Update premium credit info
    async function updatePremiumCreditInfo() {
      try {
        const creditMod = await loadCreditModule();
        const userId = await getCurrentUserId();
        
        if (!userId) {
          premiumCreditText.innerHTML = '<a href="login.html" style="color: #4361ee; text-decoration: underline;">Sign in</a> required for Premium HD';
          premiumCreditInfo.style.display = 'block';
          return;
        }
        
        if (creditMod && creditMod.getUserCredits) {
          const creditData = await creditMod.getUserCredits(userId);
          
          if (creditData.unlimited) {
            premiumCreditText.textContent = 'Premium plan active - Unlimited credits';
            premiumCreditText.style.color = '#22c55e';
          } else {
            const credits = creditData.credits || 0;
            if (credits > 0) {
              premiumCreditText.innerHTML = `You have <strong>${credits}</strong> credit(s) - <a href="pricing.html" style="color: #4361ee; text-decoration: underline;">Buy more</a>`;
              premiumCreditText.style.color = '#1f2559';
            } else {
              premiumCreditText.innerHTML = 'No credits - <a href="pricing.html" style="color: #4361ee; text-decoration: underline;">Purchase credits</a> for Premium HD';
              premiumCreditText.style.color = '#dc2626';
            }
          }
          premiumCreditInfo.style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking credits:', error);
        premiumCreditText.textContent = 'Unable to check credits';
        premiumCreditText.style.color = '#dc2626';
        premiumCreditInfo.style.display = 'block';
      }
    }
    
    // Handle quality selection
    freeDownloadOption.addEventListener('click', () => {
      selectedDownloadQuality = 'free';
      freeDownloadOption.classList.add('selected');
      premiumDownloadOption.classList.remove('selected');
      confirmDownloadBtn.disabled = false;
    });
    
    premiumDownloadOption.addEventListener('click', async () => {
      const userId = await getCurrentUserId();
      if (!userId) {
        if (confirm('Please sign in to use Premium HD. Would you like to sign in now?')) {
          window.location.href = 'login.html?returnTo=' + encodeURIComponent(window.location.href);
        }
        return;
      }
      
      // Check credits
      const creditMod = await loadCreditModule();
      if (creditMod && creditMod.hasSufficientCredits) {
        const creditCheck = await creditMod.hasSufficientCredits(userId, 1);
        
        if (!creditCheck.hasCredits && !creditCheck.unlimited) {
          if (confirm(`You need 2 credits for Premium HD. You have ${creditCheck.creditsAvailable || 0} credit(s). Would you like to purchase credits?`)) {
            window.location.href = 'pricing.html#credits';
          }
          return;
        }
      }
      
      selectedDownloadQuality = 'premium';
      premiumDownloadOption.classList.add('selected');
      freeDownloadOption.classList.remove('selected');
      
      // Show size selection
      const sizeSelection = document.getElementById('premiumSizeSelection');
      if (sizeSelection) {
        sizeSelection.classList.add('active');
      }
      
      confirmDownloadBtn.disabled = false;
    });
    
    // Handle size selection change
    const premiumSizeSelect = document.getElementById('premiumSizeSelect');
    if (premiumSizeSelect) {
      premiumSizeSelect.addEventListener('change', (e) => {
        selectedPremiumSize = e.target.value;
        const sizeInfo = document.getElementById('premiumSizeInfo');
        if (sizeInfo) {
          if (selectedPremiumSize === 'original') {
            sizeInfo.textContent = 'Original resolution will be preserved if within 25 MP limit';
          } else {
            const [width, height] = selectedPremiumSize.split('x');
            const mp = ((parseInt(width) * parseInt(height)) / 1_000_000).toFixed(2);
            sizeInfo.textContent = `${width}×${height} pixels (${mp} MP) • 2 credits`;
          }
        }
      });
    }
    
    // Hide size selection when free option is selected
    freeDownloadOption.addEventListener('click', () => {
      const sizeSelection = document.getElementById('premiumSizeSelection');
      if (sizeSelection) {
        sizeSelection.classList.remove('active');
      }
    });
    
    // Cancel download modal
    cancelDownloadBtn.addEventListener('click', () => {
      downloadModal.classList.remove('active');
      selectedDownloadQuality = null;
    });
    
    // Close modal on outside click
    downloadModal.addEventListener('click', (e) => {
      if (e.target === downloadModal) {
        downloadModal.classList.remove('active');
        selectedDownloadQuality = null;
      }
    });
    
    // Handle confirm download
    confirmDownloadBtn.addEventListener('click', async () => {
      if (!selectedDownloadQuality) return;
      
      const originalResultUrl = sessionStorage.getItem(STORAGE_KEYS.foreground);
      const downloadUrl = originalResultUrl || resultDataURL;
      
      if (!downloadUrl) {
        showError('No processed image available. Please process an image first.');
        downloadModal.classList.remove('active');
        return;
      }
      
      try {
        let finalDownloadUrl = downloadUrl;
        
        // If premium, process with premium quality first
        if (selectedDownloadQuality === 'premium') {
          const userId = await getCurrentUserId();
          if (!userId) {
            showError('Please sign in to use Premium HD download.');
            downloadModal.classList.remove('active');
            return;
          }
          
          // Get original image data
          const originalDataUrl = sessionStorage.getItem(STORAGE_KEYS.original);
          if (!originalDataUrl) {
            showError('Original image not found. Please upload again.');
            downloadModal.classList.remove('active');
            return;
          }
          
          // Process with premium HD - FIXED: Add processing indicator and ensure download happens
          const processingOverlay = document.createElement('div');
          processingOverlay.id = 'premiumProcessingOverlay';
          processingOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;';
          processingOverlay.innerHTML = `
            <div style="background:white;padding:32px;border-radius:20px;max-width:400px;text-align:center;box-shadow:0 24px 60px rgba(0,0,0,0.3);">
              <div style="font-size:48px;margin-bottom:16px;">⏳</div>
              <h3 style="color:#1a214d;margin:0 0 12px 0;font-size:1.3rem;">Processing Premium HD...</h3>
              <p style="color:#6f7694;margin:0 0 20px 0;line-height:1.6;">This may take 30-90 seconds. Please wait while we process your image with high-quality AI.</p>
              <div style="width:100%;height:4px;background:#f0f0f0;border-radius:2px;overflow:hidden;">
                <div id="processingProgressBar" style="height:100%;background:linear-gradient(90deg,#4361ee,#3a0ca3);width:0%;transition:width 0.3s;animation:pulse 1.5s infinite;"></div>
              </div>
            </div>
          `;
          document.body.appendChild(processingOverlay);
          
          // Animate progress bar
          let progress = 0;
          const progressBar = document.getElementById('processingProgressBar');
          const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            if (progressBar) progressBar.style.width = progress + '%';
          }, 500);
          
          downloadModal.classList.remove('active');
          
          console.log('Starting premium HD processing...', { userId, hasOriginalData: !!originalDataUrl });
          
          try {
            const premiumResult = await processWithPremiumHD(originalDataUrl, selectedPremiumSize);
            
            clearInterval(progressInterval);
            if (progressBar) progressBar.style.width = '100%';
            
            console.log('Premium HD processing result:', { success: premiumResult.success, error: premiumResult.error, requiresAuth: premiumResult.requiresAuth, requiresCredits: premiumResult.requiresCredits });
            
            if (premiumResult.success) {
              finalDownloadUrl = premiumResult.dataUrl;
              
              // Show credit deduction info
              const creditsUsed = premiumResult.creditsUsed || 2;
              const creditsRemaining = premiumResult.creditsRemaining;
              const creditInfo = creditsRemaining !== undefined 
                ? ` (${creditsUsed} credit used, ${creditsRemaining} remaining)`
                : ` (${creditsUsed} credit used)`;
              
              // Update stored foreground
              sessionStorage.setItem(STORAGE_KEYS.foreground, premiumResult.dataUrl);
              
              // Update preview
              previewResult.src = premiumResult.dataUrl;
              const foregroundImage = new Image();
              foregroundImage.crossOrigin = 'anonymous';
              foregroundImage.src = premiumResult.dataUrl;
              await foregroundImage.decode();
              
              ensureCanvas(foregroundImage.width, foregroundImage.height);
              resultContext.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
              resultContext.drawImage(foregroundImage, 0, 0, resultCanvas.width, resultCanvas.height);
              resultDataURL = resultCanvas.toDataURL('image/png');
              
              // Remove processing overlay
              if (processingOverlay && processingOverlay.parentNode) {
                processingOverlay.parentNode.removeChild(processingOverlay);
              }
              
              showStatus(`✅ Premium HD processed successfully!${creditInfo}`);
              
              // Continue to download after processing
            } else {
              // Remove processing overlay
              if (processingOverlay && processingOverlay.parentNode) {
                processingOverlay.parentNode.removeChild(processingOverlay);
              }
              
              if (premiumResult.requiresAuth) {
                if (confirm('Please sign in to use Premium HD. Would you like to sign in now?')) {
                  window.location.href = 'login.html?returnTo=' + encodeURIComponent(window.location.href);
                }
              } else if (premiumResult.requiresCredits) {
                if (confirm('Insufficient credits for Premium HD. Would you like to purchase credits?')) {
                  window.location.href = 'pricing.html#credits';
                }
              } else {
                showError(premiumResult.error || 'Premium HD processing failed');
              }
              return;
            }
          } catch (error) {
            clearInterval(progressInterval);
            if (processingOverlay && processingOverlay.parentNode) {
              processingOverlay.parentNode.removeChild(processingOverlay);
            }
            console.error('Premium HD processing error:', error);
            showError('Premium HD processing failed: ' + (error.message || 'Unknown error'));
            return;
          }
        }
        
        // Prepare download URL - FIXED: Ensure download happens
        if (!finalDownloadUrl) {
          showError('No image available for download');
          return;
        }
        
        if (finalDownloadUrl.startsWith('data:image/png')) {
          // Already PNG, use directly
        } else {
          // Convert to PNG
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.src = finalDownloadUrl;
          
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = () => reject(new Error('Failed to load image'));
            setTimeout(() => reject(new Error('Image load timeout')), 10000);
          });
          
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          finalDownloadUrl = canvas.toDataURL('image/png');
        }
        
        // Download the image - FIXED: Ensure download triggers
        try {
          const link = document.createElement('a');
          const filename = sessionStorage.getItem(STORAGE_KEYS.filename) || 'background-removed.png';
          const baseName = filename.replace(/\.[^/.]+$/, '') || 'background-removed';
          const qualitySuffix = selectedDownloadQuality === 'premium' ? '-premium-hd' : '-free-preview';
          link.href = finalDownloadUrl;
          link.download = `${baseName}${qualitySuffix}.png`;
          
          document.body.appendChild(link);
          link.click();
          setTimeout(() => {
            document.body.removeChild(link);
          }, 100);
          
          console.log('Download triggered successfully');
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          showError('Failed to trigger download. Please try right-clicking on the preview image and selecting "Save image as..."');
        }
        
        // Show success message
        const qualityLabel = selectedDownloadQuality === 'premium' ? 'Premium HD – up to 25 Megapixels (2 Credit per image)' : 'Free Preview (512px)';
        const wasPremium = selectedDownloadQuality === 'premium';
        showStatus(`✅ ${qualityLabel} downloaded successfully!`);
        
        // Close modal
        downloadModal.classList.remove('active');
        selectedDownloadQuality = null;
        
        // Update credit info if premium
        if (wasPremium) {
          await updatePremiumCreditInfo();
        }
      } catch (error) {
        console.error('Download error:', error);
        showError('Download failed. Please try again. Error: ' + error.message);
        downloadModal.classList.remove('active');
      }
    });

    // New Upload button - trigger file input for multiple uploads
    const newUploadBtn = document.getElementById('newUploadBtn');
    if (newUploadBtn && multipleImageUpload) {
      newUploadBtn.addEventListener('click', () => {
        multipleImageUpload.click();
      });
    }
    
    // File input change handler
    if (multipleImageUpload) {
      multipleImageUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          handleMultipleFileUpload(files);
        }
        // Reset input to allow same file selection
        e.target.value = '';
      });
    }
    
    // Process All button
    if (processAllBtn) {
      processAllBtn.addEventListener('click', processAllImages);
    }
    
    // Download All button
    if (downloadAllBtn) {
      downloadAllBtn.addEventListener('click', downloadAllImages);
    }
    
    // Clear All button
    if (clearAllImages) {
      clearAllImages.addEventListener('click', () => {
        if (confirm('Clear all uploaded images?')) {
          multipleImages = [];
          saveMultipleImages();
          updateImagesGrid();
          previewStage.classList.add('empty');
          previewPlaceholder.classList.remove('hidden');
          previewOriginal.hidden = true;
          previewResult.hidden = true;
          backgroundChangeBtn.disabled = true;
          downloadBtn.disabled = true;
        }
      });
    }
    
    // Initialize multiple images and premium check on page load
    (async () => {
      await checkPremiumUser();
      loadMultipleImages();
    })();

    const footerYear = document.getElementById('footerYear');
    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }
    
    // Initialize modules on page load
    Promise.all([
      loadSubscriptionModule(),
      loadCreditModule()
    ]).catch(err => {
      console.warn('Failed to load modules:', err);
    });
  </script>
    
    <!-- Auth and Firebase scripts loaded by global-components.js -->
    
    <section class="explanatory-content" style="margin: 40px 0; padding: 40px; background: linear-gradient(135deg, #f8f9ff, #ffffff); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div class="container" style="max-width: 900px; margin: 0 auto;">
            <h2 style="font-size: 2rem; color: #4361ee; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-info-circle" style="margin-right: 10px;"></i>
                About Background Removal Workspace
            </h2>
            <div class="content-text" style="font-size: 1.1rem; color: #56607a; line-height: 1.8; text-align: center; margin-bottom: 30px;">
                <p>Our Background Removal Workspace is a powerful AI-powered tool that removes backgrounds from images with professional precision. Using advanced GPU-accelerated AI technology, we offer two processing modes: Free Preview (512px output) for quick previews and Premium HD (up to 25 Megapixels output) for high-resolution professional results. The tool uses state-of-the-art deep learning models to accurately detect and remove backgrounds while preserving fine details, edges, and transparency. Whether you're creating product photos, social media content, or professional graphics, our background remover delivers studio-quality results. The free preview mode allows you to test the quality before committing credits, while premium HD mode provides print-ready transparent PNG files suitable for professional use. All processing is done securely in the cloud using GPU-accelerated servers, ensuring fast processing times and high-quality results. Your images are automatically deleted after processing to protect your privacy.</p>
            </div>
            
            <div class="features-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <div class="feature-item" style="padding: 20px; background: white; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <i class="fas fa-robot" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                    <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px;">AI-Powered Processing</h3>
                    <p style="color: #56607a; font-size: 0.95rem;">Advanced GPU-accelerated AI technology for accurate background removal</p>
                </div>
                
                <div class="feature-item" style="padding: 20px; background: white; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <i class="fas fa-image" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                    <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px;">HD Quality Output</h3>
                    <p style="color: #56607a; font-size: 0.95rem;">Premium mode delivers up to 25 Megapixels resolution for professional use</p>
                </div>
                
                <div class="feature-item" style="padding: 20px; background: white; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <i class="fas fa-shield-alt" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                    <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px;">Secure & Private</h3>
                    <p style="color: #56607a; font-size: 0.95rem;">Your images are processed securely and deleted automatically</p>
                </div>
            </div>
        </div>
    </section>

    <section class="how-to-guide" style="margin: 40px 0; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="font-size: 2rem; color: #4361ee; margin-bottom: 30px; text-align: center;">
            <i class="fas fa-book-open" style="margin-right: 10px;"></i>
            How to Remove Background from Image
        </h2>
        <div class="steps-container" style="max-width: 800px; margin: 0 auto;">
            <ol style="list-style: none; padding: 0; counter-reset: step-counter;">

                <li style="counter-increment: step-counter; margin-bottom: 25px; padding: 20px; background: #f8f9ff; border-radius: 12px; border-left: 4px solid #4361ee; position: relative; padding-left: 60px;">
                    <span style="position: absolute; left: 15px; top: 20px; background: #4361ee; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                        1
                    </span>
                    <p style="font-size: 1.1rem; color: #0b1630; line-height: 1.6; margin: 0;">
                        Upload your image using the upload page or select an existing image from your workspace
                    </p>
                </li>

                <li style="counter-increment: step-counter; margin-bottom: 25px; padding: 20px; background: #f8f9ff; border-radius: 12px; border-left: 4px solid #4361ee; position: relative; padding-left: 60px;">
                    <span style="position: absolute; left: 15px; top: 20px; background: #4361ee; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                        2
                    </span>
                    <p style="font-size: 1.1rem; color: #0b1630; line-height: 1.6; margin: 0;">
                        Choose your processing quality: Free Preview (512px) for quick preview or Premium HD (up to 25 Megapixels) for professional results
                    </p>
                </li>

                <li style="counter-increment: step-counter; margin-bottom: 25px; padding: 20px; background: #f8f9ff; border-radius: 12px; border-left: 4px solid #4361ee; position: relative; padding-left: 60px;">
                    <span style="position: absolute; left: 15px; top: 20px; background: #4361ee; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                        3
                    </span>
                    <p style="font-size: 1.1rem; color: #0b1630; line-height: 1.6; margin: 0;">
                        Click "Process Image" to start AI background removal using GPU-accelerated technology
                    </p>
                </li>

                <li style="counter-increment: step-counter; margin-bottom: 25px; padding: 20px; background: #f8f9ff; border-radius: 12px; border-left: 4px solid #4361ee; position: relative; padding-left: 60px;">
                    <span style="position: absolute; left: 15px; top: 20px; background: #4361ee; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                        4
                    </span>
                    <p style="font-size: 1.1rem; color: #0b1630; line-height: 1.6; margin: 0;">
                        Preview the result and download your transparent PNG image or change the background
                    </p>
                </li>

            </ol>
        </div>
    </section>

    <section class="related-tools" style="margin: 40px 0; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="font-size: 2rem; color: #4361ee; margin-bottom: 30px; text-align: center;">
            <i class="fas fa-tools" style="margin-right: 10px;"></i>
            Related Tools
        </h2>
        <div class="tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">

            <a href="background-remover.html" style="display: block; padding: 20px; background: #f8f9ff; border-radius: 12px; text-decoration: none; text-align: center; transition: transform 0.3s, box-shadow 0.3s; border: 2px solid transparent;" 
               onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(67,97,238,0.2)'; this.style.borderColor='#4361ee';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
                <i class="fas fa-magic" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                <h3 style="font-size: 1.1rem; color: #0b1630; margin: 0;">Background Remover</h3>
            </a>

            <a href="image-editor.html" style="display: block; padding: 20px; background: #f8f9ff; border-radius: 12px; text-decoration: none; text-align: center; transition: transform 0.3s, box-shadow 0.3s; border: 2px solid transparent;" 
               onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(67,97,238,0.2)'; this.style.borderColor='#4361ee';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
                <i class="fas fa-edit" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                <h3 style="font-size: 1.1rem; color: #0b1630; margin: 0;">Image Editor</h3>
            </a>

            <a href="image-compressor.html" style="display: block; padding: 20px; background: #f8f9ff; border-radius: 12px; text-decoration: none; text-align: center; transition: transform 0.3s, box-shadow 0.3s; border: 2px solid transparent;" 
               onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(67,97,238,0.2)'; this.style.borderColor='#4361ee';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='transparent';">
                <i class="fas fa-compress" style="font-size: 2rem; color: #4361ee; margin-bottom: 10px;"></i>
                <h3 style="font-size: 1.1rem; color: #0b1630; margin: 0;">Image Compressor</h3>
            </a>

        </div>
    </section>

    <section class="faq-section" style="margin: 40px 0; padding: 40px; background: #f8f9ff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="font-size: 2rem; color: #4361ee; margin-bottom: 30px; text-align: center;">
            <i class="fas fa-question-circle" style="margin-right: 10px;"></i>
            Frequently Asked Questions
        </h2>
        <div class="faq-container" style="max-width: 800px; margin: 0 auto;">
            <div class="faq-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border-left: 4px solid #4361ee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center;" onclick="toggleFaq(this)">
                    <i class="fas fa-chevron-right" style="color: #4361ee; margin-right: 10px; transition: transform 0.3s;"></i>
                    What is the difference between Free Preview and Premium HD?
                </h3>
                <div class="faq-answer" style="font-size: 1rem; color: #56607a; line-height: 1.6; margin-top: 10px; display: none; padding-left: 30px;">
                    Free Preview provides 512px output using GPU-accelerated processing and requires no credits. Premium HD delivers up to 25 Megapixels resolution using GPU-accelerated High-Resolution processing and requires 2 credits per image. Both use the same advanced AI technology, but Premium HD provides higher resolution suitable for professional printing and large-format use.
                </div>
            </div>
            <div class="faq-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border-left: 4px solid #4361ee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center;" onclick="toggleFaq(this)">
                    <i class="fas fa-chevron-right" style="color: #4361ee; margin-right: 10px; transition: transform 0.3s;"></i>
                    How accurate is the background removal?
                </h3>
                <div class="faq-answer" style="font-size: 1rem; color: #56607a; line-height: 1.6; margin-top: 10px; display: none; padding-left: 30px;">
                    Our GPU-accelerated AI technology provides professional-grade accuracy, preserving fine details, hair, and complex edges. The AI model is trained on millions of images and delivers results comparable to professional photo editing software.
                </div>
            </div>
            <div class="faq-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border-left: 4px solid #4361ee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center;" onclick="toggleFaq(this)">
                    <i class="fas fa-chevron-right" style="color: #4361ee; margin-right: 10px; transition: transform 0.3s;"></i>
                    Will my images be secure?
                </h3>
                <div class="faq-answer" style="font-size: 1rem; color: #56607a; line-height: 1.6; margin-top: 10px; display: none; padding-left: 30px;">
                    Yes, all images are processed securely on GPU servers and automatically deleted after processing. We never store, share, or use your images for any purpose other than background removal.
                </div>
            </div>
            <div class="faq-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border-left: 4px solid #4361ee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center;" onclick="toggleFaq(this)">
                    <i class="fas fa-chevron-right" style="color: #4361ee; margin-right: 10px; transition: transform 0.3s;"></i>
                    What file formats are supported?
                </h3>
                <div class="faq-answer" style="font-size: 1rem; color: #56607a; line-height: 1.6; margin-top: 10px; display: none; padding-left: 30px;">
                    We support all common image formats including JPG, JPEG, PNG, WEBP, and more. The output is always a transparent PNG file suitable for use in any design software.
                </div>
            </div>
            <div class="faq-item" style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 12px; border-left: 4px solid #4361ee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="font-size: 1.2rem; color: #0b1630; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center;" onclick="toggleFaq(this)">
                    <i class="fas fa-chevron-right" style="color: #4361ee; margin-right: 10px; transition: transform 0.3s;"></i>
                    How do I get credits for Premium HD?
                </h3>
                <div class="faq-answer" style="font-size: 1rem; color: #56607a; line-height: 1.6; margin-top: 10px; display: none; padding-left: 30px;">
                    Credits can be purchased through our pricing page. Premium and Business plan subscribers receive credits as part of their subscription. You can also purchase credit packs for one-time use.
                </div>
            </div>
        </div>
    </section>

    <script>
    function toggleFaq(element) {
        const answer = element.nextElementSibling;
        const icon = element.querySelector('i');
        const isOpen = answer.style.display === 'block';

        answer.style.display = isOpen ? 'none' : 'block';
        icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
    }
    </script>

    <section class="feedback-section" style="margin: 40px 0; padding: 40px; background: #f8f9ff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="font-size: 2rem; color: #4361ee; margin-bottom: 10px; text-align: center;">
            <i class="fas fa-comments" style="margin-right: 10px;"></i>
            Reviews & Comments
        </h2>
        <div style="text-align: center; margin-bottom: 30px;">
            <a href="feedback.html" style="display: inline-flex; align-items: center; gap: 8px; color: #4361ee; text-decoration: none; font-weight: 600; font-size: 1rem; transition: color 0.3s;" onmouseover="this.style.color='#3a0ca3'" onmouseout="this.style.color='#4361ee'">
                <i class="fas fa-external-link-alt"></i>
                View All Comments
            </a>
        </div>
        
        <div class="feedback-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: flex-start; max-width: 1200px; margin: 0 auto;">
            <div class="feedback-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 400px; max-height: 600px; overflow-y: auto;">
                <div class="thread-header" style="margin-bottom: 20px; border-bottom: 2px solid #e2e6ff; padding-bottom: 12px;">
                    <h3 style="font-size: 1.3rem; color: #0b1630; margin-bottom: 8px;">Live Comments</h3>
                    <p class="feedback-hint" style="font-size: 0.85rem; color: #9ca3af; margin: 0;">Share your experience and see what others are saying.</p>
                </div>
                <ul class="comment-list" id="feedbackList" style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 16px;">
                    <li class="feedback-muted" id="feedback-empty-state" style="text-align: center; padding: 40px 20px; color: #9ca3af; font-size: 0.95rem;">No comments yet. Start the conversation!</li>
                </ul>
            </div>
            
            <div class="feedback-form-card" style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 20px;">
                <h3 style="font-size: 1.3rem; color: #0b1630; margin-bottom: 20px;">
                    <i class="fas fa-edit" style="color: #4361ee; margin-right: 8px;"></i>
                    Share Your Feedback
                </h3>
                <form id="feedbackForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="form-group">
                        <label for="feedbackName" style="display: block; margin-bottom: 8px; color: #56607a; font-weight: 600; font-size: 0.9rem;">Your Name</label>
                        <input type="text" id="feedbackName" placeholder="Enter your name" required style="width: 100%; padding: 12px 16px; border: 1px solid #e2e6ff; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; box-sizing: border-box;" onfocus="this.style.borderColor='#4361ee'" onblur="this.style.borderColor='#e2e6ff'">
                    </div>
                    <div class="form-group">
                        <label for="feedbackMessage" style="display: block; margin-bottom: 8px; color: #56607a; font-weight: 600; font-size: 0.9rem;">Your Comment</label>
                        <textarea id="feedbackMessage" placeholder="Write your feedback or comment here..." required rows="5" style="width: 100%; padding: 12px 16px; border: 1px solid #e2e6ff; border-radius: 8px; font-size: 0.95rem; resize: vertical; transition: border-color 0.3s; font-family: inherit; box-sizing: border-box;" onfocus="this.style.borderColor='#4361ee'" onblur="this.style.borderColor='#e2e6ff'"></textarea>
                    </div>
                    <button type="submit" style="background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(67, 97, 238, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                        Submit Feedback
                    </button>
                </form>
            </div>
        </div>
    </section>

    <style>
    @media (max-width: 768px) {
        .feedback-grid {
            grid-template-columns: 1fr !important;
        }
        .feedback-form-card {
            position: static !important;
        }
    }
    </style>

    <script>
    // Store feedback in localStorage (in production, use backend API)
    const currentPage = window.location.pathname.split('/').pop() || 'background-workspace.html';
    
    function loadFeedbacks() {
        const storedFeedbacks = JSON.parse(localStorage.getItem('feedbacks') || '{}');
        const pageFeedbacks = (storedFeedbacks[currentPage] || []).slice(0, 3);
        const feedbackList = document.getElementById('feedbackList');
        const emptyState = document.getElementById('feedback-empty-state');
        
        if (!feedbackList) return;
        
        feedbackList.innerHTML = '';
        
        if (pageFeedbacks.length === 0) {
            if (emptyState) {
                feedbackList.appendChild(emptyState);
            }
            return;
        }
        
        if (emptyState) emptyState.remove();
        
        pageFeedbacks.forEach(fb => {
            const li = document.createElement('li');
            li.style.cssText = 'background: #f8f9ff; padding: 16px; border-radius: 8px; border-left: 3px solid #4361ee; margin-bottom: 12px;';
            
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;';
            
            const nameDiv = document.createElement('div');
            const name = document.createElement('h4');
            name.style.cssText = 'font-size: 1rem; color: #0b1630; margin: 0 0 4px 0; font-weight: 600;';
            name.textContent = fb.name || 'Anonymous';
            
            const time = document.createElement('span');
            time.style.cssText = 'font-size: 0.8rem; color: #9ca3af;';
            time.textContent = fb.date || 'Recently';
            
            nameDiv.appendChild(name);
            nameDiv.appendChild(time);
            header.appendChild(nameDiv);
            li.appendChild(header);
            
            const body = document.createElement('p');
            body.style.cssText = 'color: #56607a; line-height: 1.6; margin: 0; font-size: 0.9rem;';
            body.textContent = fb.message || '';
            li.appendChild(body);
            
            feedbackList.appendChild(li);
        });
    }
    
    const feedbackForm = document.getElementById('feedbackForm');
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('feedbackName').value.trim();
            const message = document.getElementById('feedbackMessage').value.trim();
            
            if (!name || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            const feedback = {
                name: name,
                message: message,
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                page: currentPage
            };
            
            const storedFeedbacks = JSON.parse(localStorage.getItem('feedbacks') || '{}');
            if (!storedFeedbacks[currentPage]) {
                storedFeedbacks[currentPage] = [];
            }
            storedFeedbacks[currentPage].unshift(feedback);
            localStorage.setItem('feedbacks', JSON.stringify(storedFeedbacks));
            
            this.reset();
            loadFeedbacks();
            alert('Thank you for your feedback!');
        });
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadFeedbacks);
    } else {
        loadFeedbacks();
    }
    </script>

    <!-- Load global header and footer components -->
    <script src="js/global-components.js"></script>
    <script>
    // Ensure header loads - multiple attempts to guarantee it works
    (function() {
        function tryLoadHeader() {
            if (typeof loadGlobalHeader === 'function') {
                try {
                    loadGlobalHeader();
                    return true;
                } catch (e) {
                    console.error('Error calling loadGlobalHeader:', e);
                }
            }
            return false;
        }
        
        // Try immediately if script already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            if (!tryLoadHeader()) {
                // Script not loaded yet, wait for it
                var attempts = 0;
                var maxAttempts = 60; // 3 seconds total
                var checkHeader = setInterval(function() {
                    attempts++;
                    if (tryLoadHeader() || attempts >= maxAttempts) {
                        clearInterval(checkHeader);
                    }
                }, 50);
            }
        } else {
            // Wait for DOM to be ready
            document.addEventListener('DOMContentLoaded', function() {
                if (!tryLoadHeader()) {
                    var attempts = 0;
                    var maxAttempts = 40;
                    var checkHeader = setInterval(function() {
                        attempts++;
                        if (tryLoadHeader() || attempts >= maxAttempts) {
                            clearInterval(checkHeader);
                        }
                    }, 50);
                }
            });
        }
        
        function tryLoadFooter() {
            if (typeof loadGlobalFooter === 'function') {
                try {
                    loadGlobalFooter();
                    return true;
                } catch (e) {
                    console.error('Error calling loadGlobalFooter:', e);
                }
            }
            return false;
        }
        
        // Try immediately if script already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            if (!tryLoadHeader()) {
                var attempts = 0;
                var maxAttempts = 60;
                var checkHeader = setInterval(function() {
                    attempts++;
                    if (tryLoadHeader() || attempts >= maxAttempts) {
                        clearInterval(checkHeader);
                    }
                }, 50);
            }
            if (!tryLoadFooter()) {
                var attempts = 0;
                var maxAttempts = 60;
                var checkFooter = setInterval(function() {
                    attempts++;
                    if (tryLoadFooter() || attempts >= maxAttempts) {
                        clearInterval(checkFooter);
                    }
                }, 50);
            }
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                if (!tryLoadHeader()) {
                    var attempts = 0;
                    var maxAttempts = 40;
                    var checkHeader = setInterval(function() {
                        attempts++;
                        if (tryLoadHeader() || attempts >= maxAttempts) {
                            clearInterval(checkHeader);
                        }
                    }, 50);
                }
                if (!tryLoadFooter()) {
                    var attempts = 0;
                    var maxAttempts = 40;
                    var checkFooter = setInterval(function() {
                        attempts++;
                        if (tryLoadFooter() || attempts >= maxAttempts) {
                            clearInterval(checkFooter);
                        }
                    }, 50);
                }
            });
        }
        
        // Final backup attempt on window load
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (!document.querySelector('header') && typeof loadGlobalHeader === 'function') {
                    loadGlobalHeader();
                }
                if (!document.querySelector('footer') && typeof loadGlobalFooter === 'function') {
                    loadGlobalFooter();
                }
            }, 100);
        });
    })();
    </script>

    <!-- Download Modal -->
    <div class="download-modal" id="downloadModal">
      <div class="download-modal-content">
        <div class="download-modal-header">
          <h3><i class="fas fa-download"></i> Download Image</h3>
          <p>Choose your download quality</p>
        </div>
        <div class="download-options">
          <div class="download-option" id="freeDownloadOption" data-quality="free">
            <div class="download-option-header">
              <div class="download-option-title">Free Preview</div>
              <span class="download-option-badge free">Free</span>
            </div>
            <div class="download-option-details">
              <strong>512px</strong> • No credits required • Instant download
            </div>
          </div>
          <div class="download-option" id="premiumDownloadOption" data-quality="premium">
            <div class="download-option-header">
              <div class="download-option-title">Premium HD – up to 25 Megapixels</div>
              <span class="download-option-badge premium">Premium (2 Credit)</span>
            </div>
            <div class="download-option-details">
              <strong>Up to 25 Megapixels</strong> • 2 credits per image • High-resolution quality
            </div>
            <div class="size-selection" id="premiumSizeSelection">
              <label for="premiumSizeSelect"><i class="fas fa-expand-arrows-alt"></i> Select Resolution:</label>
              <select id="premiumSizeSelect" class="size-select">
                <option value="original">Original Size (Preserved if ≤ 25 MP)</option>
                <option value="1920x1080">1920×1080 (2.07 MP) - Full HD</option>
                <option value="2048x2048">2048×2048 (4.19 MP) - Square HD</option>
                <option value="3000x2000">3000×2000 (6 MP) - 3:2 Ratio</option>
                <option value="3000x3000">3000×3000 (9 MP) - Square</option>
                <option value="4000x3000">4000×3000 (12 MP) - 4:3 Ratio</option>
                <option value="4000x4000">4000×4000 (16 MP) - Square</option>
                <option value="5000x3000">5000×3000 (15 MP) - 5:3 Ratio</option>
                <option value="5000x5000">5000×5000 (25 MP) - Maximum</option>
              </select>
              <div class="size-info" id="premiumSizeInfo">Original resolution will be preserved if within 25 MP limit</div>
            </div>
            <div id="premiumCreditInfo" style="margin-top: 8px; padding: 8px; background: rgba(67, 97, 238, 0.08); border-radius: 8px; font-size: 0.85rem; color: #56607a; display: none;">
              <span id="premiumCreditText">Checking credits...</span>
            </div>
          </div>
        </div>
        <div class="download-modal-actions">
          <button class="btn-cancel" id="cancelDownload">Cancel</button>
          <button class="btn-download" id="confirmDownload" disabled>
            <i class="fas fa-download"></i> Download
          </button>
        </div>
      </div>
    </div>

    <!-- Global Footer Placeholder - Loaded by global-components.js -->
    <div id="global-footer-placeholder"></div>
</body>
</html>

